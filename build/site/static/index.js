import { text } from 'd3-request';
import { event, select, selectAll } from 'd3-selection';
import * as hljs from 'highlight.js';
import * as vega from 'vega';
import { post } from 'vega-embed/build/post';
import { Handler } from 'vega-tooltip';
import { compile } from '../../src';
import { runStreamingExample } from './streaming';
window['runStreamingExample'] = runStreamingExample;
window['embedExample'] = embedExample;
var loader = vega.loader({
    baseURL: BASEURL
});
var editorURL = 'https://vega.github.io/editor/';
function trim(str) {
    return str.replace(/^\s+|\s+$/g, '');
}
/* Anchors */
selectAll('h2, h3, h4, h5, h6').each(function () {
    var sel = select(this);
    var name = sel.attr('id');
    var title = sel.text();
    sel.html('<a href="#' + name + '" class="anchor"><span class="octicon octicon-link"></span></a>' + trim(title));
});
/* Documentation */
function renderExample($target, specText) {
    $target.classed('example', true);
    $target.text('');
    var vis = $target.append('div').attr('class', 'example-vis');
    // Decrease visual noise by removing $schema and description from code examples.
    var textClean = specText.replace(/(\s)+\"(\$schema|description)\": \".*?\",/g, '');
    var code = $target.append('pre').attr('class', 'example-code')
        .append('code').attr('class', 'json').text(textClean);
    hljs.highlightBlock(code.node());
    var spec = JSON.parse(specText);
    embedExample(vis.node(), spec, true, !$target.classed('no-tooltip'));
}
function embedExample($target, spec, actions, tooltip) {
    if (actions === void 0) { actions = true; }
    if (tooltip === void 0) { tooltip = true; }
    var vgSpec = compile(spec).spec;
    var view = new vega.View(vega.parse(vgSpec), { loader: loader })
        .renderer('svg')
        .initialize($target);
    if (tooltip) {
        var handler = new Handler().call;
        view.tooltip(handler);
    }
    view.run();
    if (actions) {
        select($target)
            .append('div')
            .attr('class', 'vega-actions')
            .append('a')
            .text('Open in Vega Editor')
            .attr('href', '#')
            .on('click', function () {
            post(window, editorURL, {
                mode: 'vega-lite',
                spec: JSON.stringify(spec, null, 2),
                config: vgSpec.config,
                renderer: 'svg'
            });
            event.preventDefault();
        });
    }
}
function getSpec(el) {
    var sel = select(el);
    var name = sel.attr('data-name');
    if (name) {
        var dir = sel.attr('data-dir');
        var fullUrl = BASEURL + '/examples/specs/' + (dir ? (dir + '/') : '') + name + '.vl.json';
        text(fullUrl, function (error, spec) {
            if (error) {
                console.error(error);
            }
            else {
                renderExample(sel, spec);
            }
        });
    }
    else {
        console.error('No "data-name" specified to import examples from');
    }
}
window['changeSpec'] = function (elId, newSpec) {
    var el = document.getElementById(elId);
    select(el).attr('data-name', newSpec);
    getSpec(el);
};
window['buildSpecOpts'] = function (id, baseName) {
    var oldName = select('#' + id).attr('data-name');
    var prefixSel = select('select[name=' + id + ']');
    var inputsSel = selectAll('input[name=' + id + ']:checked');
    var prefix = prefixSel.empty() ? id : prefixSel.property('value');
    var values = inputsSel.nodes().map(function (n) { return n.value; }).sort().join('_');
    var newName = baseName + prefix + (values ? '_' + values : '');
    if (oldName !== newName) {
        window['changeSpec'](id, newName);
    }
};
selectAll('.vl-example').each(function () {
    getSpec(this);
});
// caroussel for the front page
// adapted from https://codepen.io/LANparty/pen/wePYXb
var carousel = document.getElementById('carousel');
function carouselHide(slides, indicators, links, active) {
    indicators[active].setAttribute('data-state', '');
    links[active].setAttribute('data-state', '');
    slides[active].setAttribute('data-state', '');
    slides[active].style.display = 'none';
    var video = slides[active].querySelector('video');
    if (video) {
        video.pause();
    }
}
function carouselShow(slides, indicators, links, active) {
    indicators[active].checked = true;
    indicators[active].setAttribute('data-state', 'active');
    links[active].setAttribute('data-state', 'active');
    slides[active].setAttribute('data-state', 'active');
    var video = slides[active].querySelector('video');
    if (video) {
        video.currentTime = 0;
        slides[active].style.display = 'block';
        video.play();
    }
    else {
        slides[active].style.display = 'block';
    }
}
function setSlide(slides, indicators, links, active) {
    return function () {
        // Reset all slides
        for (var i = 0; i < indicators.length; i++) {
            indicators[i].setAttribute('data-state', '');
            slides[i].setAttribute('data-state', '');
            carouselHide(slides, indicators, links, i);
        }
        // Set defined slide as active
        indicators[active].setAttribute('data-state', 'active');
        slides[active].setAttribute('data-state', 'active');
        carouselShow(slides, indicators, links, active);
        // Switch button text
        var numSlides = carousel.querySelectorAll('.indicator').length;
        if (numSlides === active + 1) {
            carousel.querySelector('.next-slide').textContent = 'Start over';
        }
        else {
            carousel.querySelector('.next-slide').textContent = 'Next step';
        }
    };
}
if (carousel) {
    var slides_1 = carousel.querySelectorAll('.slide');
    var indicators_1 = carousel.querySelectorAll('.indicator');
    var links_1 = carousel.querySelectorAll('.slide-nav');
    // tslint:disable-next-line:prefer-for-of
    for (var i = 0; i < indicators_1.length; i++) {
        indicators_1[i].addEventListener('click', setSlide(slides_1, indicators_1, links_1, +indicators_1[i].getAttribute('data-slide')));
    }
    // tslint:disable-next-line:prefer-for-of
    for (var i = 0; i < links_1.length; i++) {
        links_1[i].addEventListener('click', setSlide(slides_1, indicators_1, links_1, +links_1[i].getAttribute('data-slide')));
    }
    carousel.querySelector('.next-slide').addEventListener('click', function () {
        var slide = +carousel.querySelector('.indicator[data-state=active]').getAttribute('data-slide');
        var numSlides = carousel.querySelectorAll('.indicator').length;
        setSlide(slides_1, indicators_1, links_1, (slide + 1) % numSlides)();
    });
    [].forEach.call(slides_1, function (slide) {
        var video = slide.querySelector('video');
        if (video) {
            video.addEventListener('mouseover', function () {
                slide.querySelector('.example-vis').style.visibility = 'visible';
                video.style.display = 'none';
                video.pause();
            });
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zaXRlL3N0YXRpYy9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsSUFBSSxFQUFDLE1BQU0sWUFBWSxDQUFDO0FBQ2hDLE9BQU8sRUFBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBWSxNQUFNLGNBQWMsQ0FBQztBQUNqRSxPQUFPLEtBQUssSUFBSSxNQUFNLGNBQWMsQ0FBQztBQUNyQyxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEVBQUMsSUFBSSxFQUFDLE1BQU0sdUJBQXVCLENBQUM7QUFDM0MsT0FBTyxFQUFDLE9BQU8sRUFBQyxNQUFNLGNBQWMsQ0FBQztBQUVyQyxPQUFPLEVBQUMsT0FBTyxFQUFlLE1BQU0sV0FBVyxDQUFDO0FBQ2hELE9BQU8sRUFBQyxtQkFBbUIsRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUVoRCxNQUFNLENBQUMscUJBQXFCLENBQUMsR0FBRyxtQkFBbUIsQ0FBQztBQUNwRCxNQUFNLENBQUMsY0FBYyxDQUFDLEdBQUcsWUFBWSxDQUFDO0FBSXRDLElBQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDekIsT0FBTyxFQUFFLE9BQU87Q0FDakIsQ0FBQyxDQUFDO0FBRUgsSUFBTSxTQUFTLEdBQUcsZ0NBQWdDLENBQUM7QUFFbkQsY0FBYyxHQUFXO0lBQ3ZCLE9BQU8sR0FBRyxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDdkMsQ0FBQztBQUVELGFBQWE7QUFDYixTQUFTLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDbkMsSUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3pCLElBQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDNUIsSUFBTSxL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QUFRLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ2pFLFFBQVEsQ0FBQyxRQUFNLEVBQUUsWUFBVSxFQUFFLE9BQUssRUFBRSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsR0FBRyxTQUFTLENBQUMsRUFBRSxDQUFDO0lBQ2pFLENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBTSxFQUFFLFVBQUMsS0FBYztRQUNyQyxJQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzNDLElBQUksS0FBSyxFQUFFO1lBQ1QsS0FBSyxDQUFDLGdCQUFnQixDQUFDLFdBQVcsRUFBRTtnQkFDakMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQVMsQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHLFNBQVMsQ0FBQztnQkFDMUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO2dCQUM3QixLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDaEIsQ0FBQyxDQUFDLENBQUM7U0FDSjtJQUNILENBQUMsQ0FBQyxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge3RleHR9IGZyb20gJ2QzLXJlcXVlc3QnO1xuaW1wb3J0IHtldmVudCwgc2VsZWN0LCBzZWxlY3RBbGwsIFNlbGVjdGlvbn0gZnJvbSAnZDMtc2VsZWN0aW9uJztcbmltcG9ydCAqIGFzIGhsanMgZnJvbSAnaGlnaGxpZ2h0LmpzJztcbmltcG9ydCAqIGFzIHZlZ2EgZnJvbSAndmVnYSc7XG5pbXBvcnQge3Bvc3R9IGZyb20gJ3ZlZ2EtZW1iZWQvYnVpbGQvcG9zdCc7XG5pbXBvcnQge0hhbmRsZXJ9IGZyb20gJ3ZlZ2EtdG9vbHRpcCc7XG5cbmltcG9ydCB7Y29tcGlsZSwgVG9wTGV2ZWxTcGVjfSBmcm9tICcuLi8uLi9zcmMnO1xuaW1wb3J0IHtydW5TdHJlYW1pbmdFeGFtcGxlfSBmcm9tICcuL3N0cmVhbWluZyc7XG5cbndpbmRvd1sncnVuU3RyZWFtaW5nRXhhbXBsZSddID0gcnVuU3RyZWFtaW5nRXhhbXBsZTtcbndpbmRvd1snZW1iZWRFeGFtcGxlJ10gPSBlbWJlZEV4YW1wbGU7XG5cbmRlY2xhcmUgY29uc3QgQkFTRVVSTDogc3RyaW5nO1xuXG5jb25zdCBsb2FkZXIgPSB2ZWdhLmxvYWRlcih7XG4gIGJhc2VVUkw6IEJBU0VVUkxcbn0pO1xuXG5jb25zdCBlZGl0b3JVUkwgPSAnaHR0cHM6Ly92ZWdhLmdpdGh1Yi5pby9lZGl0b3IvJztcblxuZnVuY3Rpb24gdHJpbShzdHI6IHN0cmluZykge1xuICByZXR1cm4gc3RyLnJlcGxhY2UoL15cXHMrfFxccyskL2csICcnKTtcbn1cblxuLyogQW5jaG9ycyAqL1xuc2VsZWN0QWxsKCdoMiwgaDMsIGg0LCBoNSwgaDYnKS5lYWNoKGZ1bmN0aW9uKHRoaXM6IGQzLkJhc2VUeXBlKSB7XG4gIGNvbnN0IHNlbCA9IHNlbGVjdCh0aGlzKTtcbiAgY29uc3QgbmFtZSA9IHNlbC5hdHRyKCdpZCcpO1xuICBjb25zdCB0aXRsZSA9IHNlbC50ZXh0KCk7XG4gIHNlbC5odG1sKCc8YSBocmVmPVwiIycgKyBuYW1lICsgJ1wiIGNsYXNzPVwiYW5jaG9yXCI+PHNwYW4gY2xhc3M9XCJvY3RpY29uIG9jdGljb24tbGlua1wiPjwvc3Bhbj48L2E+JyArIHRyaW0odGl0bGUpKTtcbn0pO1xuXG4vKiBEb2N1bWVudGF0aW9uICovXG5mdW5jdGlvbiByZW5kZXJFeGFtcGxlKCR0YXJnZXQ6IFNlbGVjdGlvbjxhbnksIGFueSwgYW55LCBhbnk+LCBzcGVjVGV4dDogc3RyaW5nKSB7XG4gICR0YXJnZXQuY2xhc3NlZCgnZXhhbXBsZScsIHRydWUpO1xuICAkdGFyZ2V0LnRleHQoJycpO1xuXG4gIGNvbnN0IHZpcyA9ICR0YXJnZXQuYXBwZW5kKCdkaXYnKS5hdHRyKCdjbGFzcycsICdleGFtcGxlLXZpcycpO1xuXG4gIC8vIERlY3JlYXNlIHZpc3VhbCBub2lzZSBieSByZW1vdmluZyAkc2NoZW1hIGFuZCBkZXNjcmlwdGlvbiBmcm9tIGNvZGUgZXhhbXBsZXMuXG4gIGNvbnN0IHRleHRDbGVhbiA9IHNwZWNUZXh0LnJlcGxhY2UoLyhcXHMpK1xcXCIoXFwkc2NoZW1hfGRlc2NyaXB0aW9uKVxcXCI6IFxcXCIuKj9cXFwiLC9nLCAnJyk7XG4gIGNvbnN0IGNvZGUgPSAkdGFyZ2V0LmFwcGVuZCgncHJlJykuYXR0cignY2xhc3MnLCAnZXhhbXBsZS1jb2RlJylcbiAgLmFwcGVuZCgnY29kZScpLmF0dHIoJ2NsYXNzJywgJ2pzb24nKS50ZXh0KHRleHRDbGVhbik7XG4gIGhsanMuaGlnaGxpZ2h0QmxvY2soY29kZS5ub2RlKCkgYXMgYW55KTtcblxuICBjb25zdCBzcGVjID0gSlNPTi5wYXJzZShzcGVjVGV4dCk7XG5cbiAgZW1iZWRFeGFtcGxlKHZpcy5ub2RlKCksIHNwZWMsIHRydWUsICEkdGFyZ2V0LmNsYXNzZWQoJ25vLXRvb2x0aXAnKSk7XG59XG5cbmZ1bmN0aW9uIGVtYmVkRXhhbXBsZSgkdGFyZ2V0OiBhbnksIHNwZWM6IFRvcExldmVsU3BlYywgYWN0aW9ucz10cnVlLCB0b29sdGlwPXRydWUpIHtcbiAgY29uc3QgdmdTcGVjID0gY29tcGlsZShzcGVjKS5zcGVjO1xuXG4gIGNvbnN0IHZpZXcgPSBuZXcgdmVnYS5WaWV3KHZlZ2EucGFyc2UodmdTcGVjKSwge2xvYWRlcjogbG9hZGVyfSlcbiAgICAucmVuZGVyZXIoJ3N2ZycpXG4gICAgLmluaXRpYWxpemUoJHRhcmdldCk7XG5cbiAgaWYgKHRvb2x0aXApIHtcbiAgICBjb25zdCBoYW5kbGVyID0gbmV3IEhhbmRsZXIoKS5jYWxsO1xuICAgIHZpZXcudG9vbHRpcChoYW5kbGVyKTtcbiAgfVxuXG4gIHZpZXcucnVuKCk7XG5cbiAgaWYgKGFjdGlvbnMpIHtcbiAgICBzZWxlY3QoJHRhcmdldClcbiAgICAgIC5hcHBlbmQoJ2RpdicpXG4gICAgICAuYXR0cignY2xhc3MnLCAndmVnYS1hY3Rpb25zJylcbiAgICAgIC5hcHBlbmQoJ2EnKVxuICAgICAgLnRleHQoJ09wZW4gaW4gVmVnYSBFZGl0b3InKVxuICAgICAgLmF0dHIoJ2hyZWYnLCAnIycpXG4gICAgICAub24oJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuICAgICAgICBwb3N0KHdpbmRvdywgZWRpdG9yVVJMLCB7XG4gICAgICAgICAgbW9kZTogJ3ZlZ2EtbGl0ZScsXG4gICAgICAgICAgc3BlYzogSlNPTi5zdHJpbmdpZnkoc3BlYywgbnVsbCwgMiksXG4gICAgICAgICAgY29uZmlnOiB2Z1NwZWMuY29uZmlnLFxuICAgICAgICAgIHJlbmRlcmVyOiAnc3ZnJ1xuICAgICAgICB9KTtcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgIH0pO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldFNwZWMoZWw6IGQzLkJhc2VUeXBlKSB7XG4gIGNvbnN0IHNlbCA9IHNlbGVjdChlbCk7XG4gIGNvbnN0IG5hbWUgPSBzZWwuYXR0cignZGF0YS1uYW1lJyk7XG4gIGlmIChuYW1lKSB7XG4gICAgY29uc3QgZGlyID0gc2VsLmF0dHIoJ2RhdGEtZGlyJyk7XG4gICAgY29uc3QgZnVsbFVybCA9IEJBU0VVUkwgKyAnL2V4YW1wbGVzL3NwZWNzLycgKyAoZGlyID8gKGRpciArICcvJykgOiAnJykgKyBuYW1lICsgJy52bC5qc29uJztcblxuICAgIHRleHQoZnVsbFVybCwgZnVuY3Rpb24oZXJyb3IsIHNwZWMpIHtcbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlbmRlckV4YW1wbGUoc2VsLCBzcGVjKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICBjb25zb2xlLmVycm9yKCdObyBcImRhdGEtbmFtZVwiIHNwZWNpZmllZCB0byBpbXBvcnQgZXhhbXBsZXMgZnJvbScpO1xuICB9XG59XG5cbndpbmRvd1snY2hhbmdlU3BlYyddID0gZnVuY3Rpb24oZWxJZDogc3RyaW5nLCBuZXdTcGVjOiBzdHJpbmcpIHtcbiAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChlbElkKTtcbiAgc2VsZWN0KGVsKS5hdHRyKCdkYXRhLW5hbWUnLCBuZXdTcGVjKTtcbiAgZ2V0U3BlYyhlbCk7XG59O1xuXG53aW5kb3dbJ2J1aWxkU3BlY09wdHMnXSA9IGZ1bmN0aW9uKGlkOiBzdHJpbmcsIGJhc2VOYW1lOiBzdHJpbmcpIHtcbiAgY29uc3Qgb2xkTmFtZSA9IHNlbGVjdCgnIycgKyBpZCkuYXR0cignZGF0YS1uYW1lJyk7XG4gIGNvbnN0IHByZWZpeFNlbCA9IHNlbGVjdCgnc2VsZWN0W25hbWU9JyArIGlkICsgJ10nKTtcbiAgY29uc3QgaW5wdXRzU2VsID0gc2VsZWN0QWxsKCdpbnB1dFtuYW1lPScgKyBpZCArICddOmNoZWNrZWQnKTtcbiAgY29uc3QgcHJlZml4ID0gcHJlZml4U2VsLmVtcHR5KCkgPyBpZCA6IHByZWZpeFNlbC5wcm9wZXJ0eSgndmFsdWUnKTtcbiAgY29uc3QgdmFsdWVzID0gaW5wdXRzU2VsLm5vZGVzKCkubWFwKChuOiBhbnkpID0+IG4udmFsdWUpLnNvcnQoKS5qb2luKCdfJyk7XG4gIGNvbnN0IG5ld05hbWUgPSBiYXNlTmFtZSArIHByZWZpeCArICh2YWx1ZXMgPyAnXycgKyB2YWx1ZXMgOiAnJyk7XG4gIGlmIChvbGROYW1lICE9PSBuZXdOYW1lKSB7XG4gICAgd2luZG93WydjaGFuZ2VTcGVjJ10oaWQsIG5ld05hbWUpO1xuICB9XG59O1xuXG5zZWxlY3RBbGwoJy52bC1leGFtcGxlJykuZWFjaChmdW5jdGlvbih0aGlzOiBkMy5CYXNlVHlwZSkge1xuICBnZXRTcGVjKHRoaXMpO1xufSk7XG5cbi8vIGNhcm91c3NlbCBmb3IgdGhlIGZyb250IHBhZ2Vcbi8vIGFkYXB0ZWQgZnJvbSBodHRwczovL2NvZGVwZW4uaW8vTEFOcGFydHkvcGVuL3dlUFlYYlxuXG5jb25zdCBjYXJvdXNlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjYXJvdXNlbCcpO1xuXG5mdW5jdGlvbiBjYXJvdXNlbEhpZGUoc2xpZGVzOiBOb2RlTGlzdE9mPGFueT4sIGluZGljYXRvcnM6IE5vZGVMaXN0T2Y8YW55PiwgbGlua3M6IE5vZGVMaXN0T2Y8YW55PiwgYWN0aXZlOiBudW1iZXIpIHtcbiAgaW5kaWNhdG9yc1thY3RpdmVdLnNldEF0dHJpYnV0ZSgnZGF0YS1zdGF0ZScsICcnKTtcbiAgbGlua3NbYWN0aXZlXS5zZXRBdHRyaWJ1dGUoJ2RhdGEtc3RhdGUnLCAnJyk7XG4gIHNsaWRlc1thY3RpdmVdLnNldEF0dHJpYnV0ZSgnZGF0YS1zdGF0ZScsICcnKTtcbiAgc2xpZGVzW2FjdGl2ZV0uc3R5bGUuZGlzcGxheSA9ICdub25lJztcblxuICBjb25zdCB2aWRlbyA9IHNsaWRlc1thY3RpdmVdLnF1ZXJ5U2VsZWN0b3IoJ3ZpZGVvJyk7XG4gIGlmICh2aWRlbykge1xuICAgIHZpZGVvLnBhdXNlKCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gY2Fyb3VzZWxTaG93KHNsaWRlczogTm9kZUxpc3RPZjxhbnk+LCBpbmRpY2F0b3JzOiBOb2RlTGlzdE9mPGFueT4sIGxpbmtzOiBOb2RlTGlzdE9mPGFueT4sIGFjdGl2ZTogbnVtYmVyKSB7XG4gIGluZGljYXRvcnNbYWN0aXZlXS5jaGVja2VkID0gdHJ1ZTtcbiAgaW5kaWNhdG9yc1thY3RpdmVdLnNldEF0dHJpYnV0ZSgnZGF0YS1zdGF0ZScsICdhY3RpdmUnKTtcbiAgbGlua3NbYWN0aXZlXS5zZXRBdHRyaWJ1dGUoJ2RhdGEtc3RhdGUnLCAnYWN0aXZlJyk7XG4gIHNsaWRlc1thY3RpdmVdLnNldEF0dHJpYnV0ZSgnZGF0YS1zdGF0ZScsICdhY3RpdmUnKTtcblxuICBjb25zdCB2aWRlbyA9IHNsaWRlc1thY3RpdmVdLnF1ZXJ5U2VsZWN0b3IoJ3ZpZGVvJyk7XG4gIGlmICh2aWRlbykge1xuICAgIHZpZGVvLmN1cnJlbnRUaW1lID0gMDtcbiAgICBzbGlkZXNbYWN0aXZlXS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgICB2aWRlby5wbGF5KCk7XG4gIH0gZWxzZSB7XG4gICAgc2xpZGVzW2FjdGl2ZV0uc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XG4gIH1cbn1cblxuZnVuY3Rpb24gc2V0U2xpZGUoc2xpZGVzOiBOb2RlTGlzdE9mPEVsZW1lbnQ+LCBpbmRpY2F0b3JzOiBOb2RlTGlzdE9mPEVsZW1lbnQ+LCBsaW5rczogTm9kZUxpc3RPZjxhbnk+LCBhY3RpdmU6IG51bWJlcikge1xuICByZXR1cm4gZnVuY3Rpb24oKSB7XG4gICAgLy8gUmVzZXQgYWxsIHNsaWRlc1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kaWNhdG9ycy5sZW5ndGg7IGkrKykge1xuICAgICAgaW5kaWNhdG9yc1tpXS5zZXRBdHRyaWJ1dGUoJ2RhdGEtc3RhdGUnLCAnJyk7XG4gICAgICBzbGlkZXNbaV0uc2V0QXR0cmlidXRlKCdkYXRhLXN0YXRlJywgJycpO1xuICAgICAgY2Fyb3VzZWxIaWRlKHNsaWRlcywgaW5kaWNhdG9ycywgbGlua3MsIGkpO1xuICAgIH1cblxuICAgIC8vIFNldCBkZWZpbmVkIHNsaWRlIGFzIGFjdGl2ZVxuICAgIGluZGljYXRvcnNbYWN0aXZlXS5zZXRBdHRyaWJ1dGUoJ2RhdGEtc3RhdGUnLCAnYWN0aXZlJyk7XG4gICAgc2xpZGVzW2FjdGl2ZV0uc2V0QXR0cmlidXRlKCdkYXRhLXN0YXRlJywgJ2FjdGl2ZScpO1xuICAgIGNhcm91c2VsU2hvdyhzbGlkZXMsIGluZGljYXRvcnMsIGxpbmtzLCBhY3RpdmUpO1xuXG4gICAgLy8gU3dpdGNoIGJ1dHRvbiB0ZXh0XG4gICAgY29uc3QgbnVtU2xpZGVzID0gY2Fyb3VzZWwucXVlcnlTZWxlY3RvckFsbCgnLmluZGljYXRvcicpLmxlbmd0aDtcbiAgICBpZiAobnVtU2xpZGVzID09PSBhY3RpdmUgKyAxKSB7XG4gICAgICBjYXJvdXNlbC5xdWVyeVNlbGVjdG9yKCcubmV4dC1zbGlkZScpLnRleHRDb250ZW50ID0gJ1N0YXJ0IG92ZXInO1xuICAgIH0gZWxzZSB7XG4gICAgICBjYXJvdXNlbC5xdWVyeVNlbGVjdG9yKCcubmV4dC1zbGlkZScpLnRleHRDb250ZW50ID0gJ05leHQgc3RlcCc7XG4gICAgfVxuICB9O1xufVxuXG5pZiAoY2Fyb3VzZWwpIHtcbiAgY29uc3Qgc2xpZGVzID0gY2Fyb3VzZWwucXVlcnlTZWxlY3RvckFsbCgnLnNsaWRlJyk7XG4gIGNvbnN0IGluZGljYXRvcnMgPSBjYXJvdXNlbC5xdWVyeVNlbGVjdG9yQWxsKCcuaW5kaWNhdG9yJyk7XG4gIGNvbnN0IGxpbmtzID0gY2Fyb3VzZWwucXVlcnlTZWxlY3RvckFsbCgnLnNsaWRlLW5hdicpO1xuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpwcmVmZXItZm9yLW9mXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kaWNhdG9ycy5sZW5ndGg7IGkrKykge1xuICAgIGluZGljYXRvcnNbaV0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBzZXRTbGlkZShzbGlkZXMsIGluZGljYXRvcnMsIGxpbmtzLCAraW5kaWNhdG9yc1tpXS5nZXRBdHRyaWJ1dGUoJ2RhdGEtc2xpZGUnKSkpO1xuICB9XG5cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnByZWZlci1mb3Itb2ZcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaW5rcy5sZW5ndGg7IGkrKykge1xuICAgIGxpbmtzW2ldLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgc2V0U2xpZGUoc2xpZGVzLCBpbmRpY2F0b3JzLCBsaW5rcywgK2xpbmtzW2ldLmdldEF0dHJpYnV0ZSgnZGF0YS1zbGlkZScpKSk7XG4gIH1cblxuICBjYXJvdXNlbC5xdWVyeVNlbGVjdG9yKCcubmV4dC1zbGlkZScpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xuICAgIGNvbnN0IHNsaWRlID0gK2Nhcm91c2VsLnF1ZXJ5U2VsZWN0b3IoJy5pbmRpY2F0b3JbZGF0YS1zdGF0ZT1hY3RpdmVdJykuZ2V0QXR0cmlidXRlKCdkYXRhLXNsaWRlJyk7XG4gICAgY29uc3QgbnVtU2xpZGVzID0gY2Fyb3VzZWwucXVlcnlTZWxlY3RvckFsbCgnLmluZGljYXRvcicpLmxlbmd0aDtcbiAgICBzZXRTbGlkZShzbGlkZXMsIGluZGljYXRvcnMsIGxpbmtzLCAoc2xpZGUgKyAxKSAlIG51bVNsaWRlcykoKTtcbiAgfSk7XG5cbiAgW10uZm9yRWFjaC5jYWxsKHNsaWRlcywgKHNsaWRlOiBFbGVtZW50KSA9PiB7XG4gICAgY29uc3QgdmlkZW8gPSBzbGlkZS5xdWVyeVNlbGVjdG9yKCd2aWRlbycpO1xuICAgIGlmICh2aWRlbykge1xuICAgICAgdmlkZW8uYWRkRXZlbnRMaXN0ZW5lcignbW91c2VvdmVyJywgKCkgPT4ge1xuICAgICAgICAoc2xpZGUucXVlcnlTZWxlY3RvcignLmV4YW1wbGUtdmlzJykgYXMgYW55KS5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnO1xuICAgICAgICB2aWRlby5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgICAgICB2aWRlby5wYXVzZSgpO1xuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn1cbiJdfQ==