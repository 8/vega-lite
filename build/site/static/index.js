import { text } from 'd3-fetch';
import { event, select, selectAll } from 'd3-selection';
import * as hljs from 'highlight.js';
import * as vega from 'vega';
import { post } from 'vega-embed/build/post';
import { Handler } from 'vega-tooltip';
import { compile } from '../../src';
import { runStreamingExample } from './streaming';
window['runStreamingExample'] = runStreamingExample;
window['embedExample'] = embedExample;
var loader = vega.loader({
    baseURL: BASEURL
});
var editorURL = 'https://vega.github.io/editor/';
function trim(str) {
    return str.replace(/^\s+|\s+$/g, '');
}
/* Anchors */
selectAll('h2, h3, h4, h5, h6').each(function () {
    var sel = select(this);
    var name = sel.attr('id');
    var title = sel.text();
    sel.html('<a href="#' + name + '" class="anchor"><span class="octicon octicon-link"></span></a>' + trim(title));
});
/* Documentation */
function renderExample($target, specText) {
    $target.classed('example', true);
    $target.text('');
    var vis = $target.append('div').attr('class', 'example-vis');
    // Decrease visual noise by removing $schema and description from code examples.
    var textClean = specText.replace(/(\s)+\"(\$schema|description)\": \".*?\",/g, '');
    var code = $target.append('pre').attr('class', 'example-code')
        .append('code').attr('class', 'json').text(textClean);
    hljs.highlightBlock(code.node());
    var spec = JSON.parse(specText);
    embedExample(vis.node(), spec, true, !$target.classed('no-tooltip'));
}
function embedExample($target, spec, actions, tooltip) {
    if (actions === void 0) { actions = true; }
    if (tooltip === void 0) { tooltip = true; }
    var vgSpec = compile(spec).spec;
    var view = new vega.View(vega.parse(vgSpec), { loader: loader })
        .renderer('svg')
        .initialize($target);
    if (tooltip) {
        var handler = new Handler().call;
        view.tooltip(handler);
    }
    view.run();
    if (actions) {
        select($target)
            .append('div')
            .attr('class', 'vega-actions')
            .append('a')
            .text('Open in Vega Editor')
            .attr('href', '#')
            .on('click', function () {
            post(window, editorURL, {
                mode: 'vega-lite',
                spec: JSON.stringify(spec, null, 2),
                config: vgSpec.config,
                renderer: 'svg'
            });
            event.preventDefault();
        });
    }
}
function getSpec(el) {
    var sel = select(el);
    var name = sel.attr('data-name');
    if (name) {
        var dir = sel.attr('data-dir');
        var fullUrl = BASEURL + '/examples/specs/' + (dir ? (dir + '/') : '') + name + '.vl.json';
        text(fullUrl).then(function (spec) {
            renderExample(sel, spec);
        }).catch(console.error);
    }
    else {
        console.error('No "data-name" specified to import examples from');
    }
}
window['changeSpec'] = function (elId, newSpec) {
    var el = document.getElementById(elId);
    select(el).attr('data-name', newSpec);
    getSpec(el);
};
window['buildSpecOpts'] = function (id, baseName) {
    var oldName = select('#' + id).attr('data-name');
    var prefixSel = select('select[name=' + id + ']');
    var inputsSel = selectAll('input[name=' + id + ']:checked');
    var prefix = prefixSel.empty() ? id : prefixSel.property('value');
    var values = inputsSel.nodes().map(function (n) { return n.value; }).sort().join('_');
    var newName = baseName + prefix + (values ? '_' + values : '');
    if (oldName !== newName) {
        window['changeSpec'](id, newName);
    }
};
selectAll('.vl-example').each(function () {
    getSpec(this);
});
// caroussel for the front page
// adapted from https://codepen.io/LANparty/pen/wePYXb
var carousel = document.getElementById('carousel');
function carouselHide(slides, indicators, links, active) {
    indicators[active].setAttribute('data-state', '');
    links[active].setAttribute('data-state', '');
    slides[active].setAttribute('data-state', '');
    slides[active].style.display = 'none';
    var video = slides[active].querySelector('video');
    if (video) {
        video.pause();
    }
}
function carouselShow(slides, indicators, links, active) {
    indicators[active].checked = true;
    indicators[active].setAttribute('data-state', 'active');
    links[active].setAttribute('data-state', 'active');
    slides[active].setAttribute('data-state', 'active');
    var video = slides[active].querySelector('video');
    if (video) {
        video.currentTime = 0;
        slides[active].style.display = 'block';
        video.play();
    }
    else {
        slides[active].style.display = 'block';
    }
}
function setSlide(slides, indicators, links, active) {
    return function () {
        // Reset all slides
        for (var i = 0; i < indicators.length; i++) {
            indicators[i].setAttribute('data-state', '');
            slides[i].setAttribute('data-state', '');
            carouselHide(slides, indicators, links, i);
        }
        // Set defined slide as active
        indicators[active].setAttribute('data-state', 'active');
        slides[active].setAttribute('data-state', 'active');
        carouselShow(slides, indicators, links, active);
        // Switch button text
        var numSlides = carousel.querySelectorAll('.indicator').length;
        if (numSlides === active + 1) {
            carousel.querySelector('.next-slide').textContent = 'Start over';
        }
        else {
            carousel.querySelector('.next-slide').textContent = 'Next step';
        }
    };
}
if (carousel) {
    var slides_1 = carousel.querySelectorAll('.slide');
    var indicators_1 = carousel.querySelectorAll('.indicator');
    var links_1 = carousel.querySelectorAll('.slide-nav');
    // tslint:disable-next-line:prefer-for-of
    for (var i = 0; i < indicators_1.length; i++) {
        indicators_1[i].addEventListener('click', setSlide(slides_1, indicators_1, links_1, +indicators_1[i].getAttribute('data-slide')));
    }
    // tslint:disable-next-line:prefer-for-of
    for (var i = 0; i < links_1.length; i++) {
        links_1[i].addEventListener('click', setSlide(slides_1, indicators_1, links_1, +links_1[i].getAttribute('data-slide')));
    }
    carousel.querySelector('.next-slide').addEventListener('click', function () {
        var slide = +carousel.querySelector('.indicator[data-state=active]').getAttribute('data-slide');
        var numSlides = carousel.querySelectorAll('.indicator').length;
        setSlide(slides_1, indicators_1, links_1, (slide + 1) % numSlides)();
    });
    [].forEach.call(slides_1, function (slide) {
        var video = slide.querySelector('video');
        if (video) {
            video.addEventListener('mouseover', function () {
                slide.querySelector('.example-vis').style.visibility = 'visible';
                video.style.display = 'none';
                video.pause();
            });
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zaXRlL3N0YXRpYy9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsSUFBSSxFQUFDLE1BQU0sVUFBVSxDQUFDO0FBQzlCLE9BQU8sRUFBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBWSxNQUFNLGNBQWMsQ0FBQztBQUNqRSxPQUFPLEtBQUssSUFBSSxNQUFNLGNBQWMsQ0FBQztBQUNyQyxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEVBQUMsSUFBSSxFQUFDLE1BQU0sdUJBQXVCLENBQUM7QUFDM0MsT0FBTyxFQUFDLE9BQU8sRUFBQyxNQUFNLGNBQWMsQ0FBQztBQUVyQyxPQUFPLEVBQUMsT0FBTyxFQUFlLE1BQU0sV0FBVyxDQUFDO0FBQ2hELE9BQU8sRUFBQyxtQkFBbUIsRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUVoRCxNQUFNLENBQUMscUJBQXFCLENBQUMsR0FBRyxtQkFBbUIsQ0FBQztBQUNwRCxNQUFNLENBQUMsY0FBYyxDQUFDLEdBQUcsWUFBWSxDQUFDO0FBSXRDLElBQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDekIsT0FBTyxFQUFFLE9BQU87Q0FDakIsQ0FBQyxDQUFDO0FBRUgsSUFBTSxTQUFTLEdBQUcsZ0NBQWdDLENBQUM7QUFFbkQsY0FBYyxHQUFXO0lBQ3ZCLE9BQU8sR0FBRyxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDdkMsQ0FBQztBQUVELGFBQWE7QUFDYixTQUFTLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDbkMsSUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3pCLElBQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDNUIsSUFBTSxLQUFLLEdBQUcsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3pCLEdBQUcsQ0FBQyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksR0FBRyxpRUFBaUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztBQUNsSCxDQUFDLENBQUMsQ0FBQztBQUVILG1CQUFtQjtBQUNuQix1QkFBdUIsT0FBc0MsRUFBRSxRQUFnQjtJQUM3RSxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNqQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBRWpCLElBQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUMsQ0FBQztJQUUvRCxnRkFBZ0Y7SUFDaEYsSUFBTSxTQUFTLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyw0Q0FBNEMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNyRixJQUFNLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsY0FBYyxDQUFDO1NBQy9ELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN0RCxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQVMsQ0FBQyxDQUFDO0lBRXhDLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFbEMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO0FBQ3ZFLENBQUM7QUFFRCxzQkFBc0IsT0FBWSxFQUFFLElBQWtCLEVBQUUsT0FBWSxFQUFFLE9BQVk7SUFBMUIsd0JBQUEsRUFBQSxjQUFZO0lBQUUsd0JBQUEsRUFBQSxjQUFZO0lBQ2hGLElBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFFbEMsSUFBTSxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBQyxNQUFNLEVBQUUsTUFBTSxFQUFDLENBQUM7U0FDN0QsUUFBUSxDQUFDLEtBQUssQ0FBQztTQUNmLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUV2QixJQUFJLE9BQU8sRUFBRTtRQUNYLElBQU0sT0FBTyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDO1FBQ25DLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDdkI7SUFFRCxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7SUFFWCxJQUFJLE9BQU8sRUFBRTtRQUNYLE1BQU0sQ0FBQyxPQUFPLENBQUM7YUFDWixNQUFNLENBQUMsS0FBSyxDQUFDO2FBQ2IsSUFBSSxDQUFDLE9BQU8sRUFBRSxjQUFjLENBQUM7YUFDN0IsTUFBTSxDQUFDLEdBQUcsQ0FBQzthQUNYLElBQUksQ0FBQyxxQkFBcUIsQ0FBQzthQUMzQixJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQzthQUNqQixFQUFFLENBQUMsT0FBTyxFQUFFO1lBQ1gsSUFBSSxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUU7Z0JBQ3RCLElBQUksRUFBRSxXQUFXO2dCQUNqQixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztnQkFDbkMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxNQUFNO2dCQUNyQixRQUFRLEVBQUUsS0FBSzthQUNoQixDQUFDLENBQUM7WUFDSCxLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDekIsQ0FBQyxDQUFDLENBQUM7S0FDTjtBQUNILENBQUM7QUFFRCxpQkFBaUIsRUFBZTtJQUM5QixJQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDdkIsSUFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNuQyxJQUFJLElBQUksRUFBRTtRQUNSLElBQU0sR0FBRyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDakMsSUFBTSxPQUFPLEdBQUcsT0FBTyxHQUFHLGtCQUFrQixHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxHQUFHLFVBQVUsQ0FBQztRQUU1RixJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUEsSUFBSTtZQUNyQixhQUFhLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzNCLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7S0FDekI7U0FBTTtRQUNMLE9BQU8sQ0FBQyxLQUFLLENBQUMsa0RBQWtELENBQUMsQ0FBQztLQUNuRTtBQUNILENBQUM7QUFFRCxNQUFNLENBQUMsWUFBWSxDQUFDLEdBQUcsVUFBUyxJQUFZLEVBQUUsT0FBZTtJQUMzRCxJQUFNLEVBQUUsR0FBRyxRQUFRLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3pDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3RDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUNkLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxlQUFlLENBQUMsR0FBRyxVQUFTLEVBQVUsRUFBRSxRQUFnQjtJQUM3RCxJQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNuRCxJQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsY0FBYyxHQUFHLEVBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQztJQUNwRCxJQUFNLFNBQVMsR0FBRyxTQUFTLENBQUMsYUFBYSxHQUFHLEVBQUUsR0FBRyxXQUFXLENBQUMsQ0FBQztJQUM5RCxJQUFNLE1BQU0sR0FBRyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNwRSxJQUFNLE1BQU0sR0FBRyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUMsR0FBRyxDQUFDLFVBQUMsQ0FBTSxJQUFLLE9BQUEsQ0FBQyxDQUFDLEtBQUssRUFBUCxDQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDM0UsSUFBTSxPQUFPLEdBQUcsUUFBUSxHQUFHLE1BQU0sR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDakUsSUFBSSxPQUFPLEtBQUssT0FBTyxFQUFFO1FBQ3ZCLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUM7S0FDbkM7QUFDSCxDQUFDLENBQUM7QUFFRixTQUFTLENBQUMsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQzVCLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNoQixDQUFDLENBQUMsQ0FBQztBQUVILCtCQUErQjtBQUMvQixzREFBc0Q7QUFFdEQsSUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUVyRCxzQkFBc0IsTUFBdUIsRUFBRSxVQUEyQixFQUFFLEtBQXNCLEVBQUUsTUFBYztJQUNoSCxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsWUFBWSxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNsRCxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsWUFBWSxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUMsQ0FBQztJQUM3QyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsWUFBWSxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUMsQ0FBQztJQUM5QyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7SUFFdEMsSUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNwRCxJQUFJLEtBQUssRUFBRTtRQUNULEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztLQUNmO0FBQ0gsQ0FBQztBQUVELHNCQUFzQixNQUF1QixFQUFFLFVBQTJCLEVBQUUsS0FBc0IsRUFBRSxNQUFjO0lBQ2hILFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO0lBQ2xDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ3hELEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ25ELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBRXBELElBQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDcEQsSUFBSSxLQUFLLEVBQUU7UUFDVCxLQUFLLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQztRQUN0QixNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO0tBQ2Q7U0FBTTtRQUNMLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztLQUN4QztBQUNILENBQUM7QUFFRCxrQkFBa0IsTUFBMkIsRUFBRSxVQUErQixFQUFFLEtBQXNCLEVBQUUsTUFBYztJQUNwSCxPQUFPO1FBQ0wsbUJBQW1CO1FBQ25CLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQzFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQzdDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ3pDLFlBQVksQ0FBQyxNQUFNLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztTQUM1QztRQUVELDhCQUE4QjtRQUM5QixVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsWUFBWSxDQUFDLFlBQVksRUFBRSxRQUFRLENBQUMsQ0FBQztRQUN4RCxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsWUFBWSxDQUFDLFlBQVksRUFBRSxRQUFRLENBQUMsQ0FBQztRQUNwRCxZQUFZLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFaEQscUJBQXFCO1FBQ3JCLElBQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFDakUsSUFBSSxTQUFTLEtBQUssTUFBTSxHQUFHLENBQUMsRUFBRTtZQUM1QixRQUFRLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDLFdBQVcsR0FBRyxZQUFZLENBQUM7U0FDbEU7YUFBTTtZQUNMLFFBQVEsQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQztTQUNqRTtJQUNILENBQUMsQ0FBQztBQUNKLENBQUM7QUFFRCxJQUFJLFFBQVEsRUFBRTtJQUNaLElBQU0sUUFBTSxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNuRCxJQUFNLFlBQVUsR0FBRyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDM0QsSUFBTSxPQUFLLEdBQUcsUUFBUSxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxDQUFDO0lBRXRELHlDQUF5QztJQUN6QyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsWUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUMxQyxZQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxRQUFNLEVBQUUsWUFBVSxFQUFFLE9BQUssRUFBRSxDQUFDLFlBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ3pIO0lBRUQseUNBQXlDO0lBQ3pDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxPQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQ3JDLE9BQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLFFBQU0sRUFBRSxZQUFVLEVBQUUsT0FBSyxFQUFFLENBQUMsT0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDL0c7SUFFRCxRQUFRLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRTtRQUM5RCxJQUFNLEtBQUssR0FBRyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsK0JBQStCLENBQUMsQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDbEcsSUFBTSxTQUFTLEdBQUcsUUFBUSxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUNqRSxRQUFRLENBQUMsUUFBTSxFQUFFLFlBQVUsRUFBRSxPQUFLLEVBQUUsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEdBQUcsU0FBUyxDQUFDLEVBQUUsQ0FBQztJQUNqRSxDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQU0sRUFBRSxVQUFDLEtBQWM7UUFDckMsSUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMzQyxJQUFJLEtBQUssRUFBRTtZQUNULEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUU7Z0JBQ2pDLEtBQUssQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFTLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRyxTQUFTLENBQUM7Z0JBQzFFLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztnQkFDN0IsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ2hCLENBQUMsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDLENBQUMsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHt0ZXh0fSBmcm9tICdkMy1mZXRjaCc7XG5pbXBvcnQge2V2ZW50LCBzZWxlY3QsIHNlbGVjdEFsbCwgU2VsZWN0aW9ufSBmcm9tICdkMy1zZWxlY3Rpb24nO1xuaW1wb3J0ICogYXMgaGxqcyBmcm9tICdoaWdobGlnaHQuanMnO1xuaW1wb3J0ICogYXMgdmVnYSBmcm9tICd2ZWdhJztcbmltcG9ydCB7cG9zdH0gZnJvbSAndmVnYS1lbWJlZC9idWlsZC9wb3N0JztcbmltcG9ydCB7SGFuZGxlcn0gZnJvbSAndmVnYS10b29sdGlwJztcblxuaW1wb3J0IHtjb21waWxlLCBUb3BMZXZlbFNwZWN9IGZyb20gJy4uLy4uL3NyYyc7XG5pbXBvcnQge3J1blN0cmVhbWluZ0V4YW1wbGV9IGZyb20gJy4vc3RyZWFtaW5nJztcblxud2luZG93WydydW5TdHJlYW1pbmdFeGFtcGxlJ10gPSBydW5TdHJlYW1pbmdFeGFtcGxlO1xud2luZG93WydlbWJlZEV4YW1wbGUnXSA9IGVtYmVkRXhhbXBsZTtcblxuZGVjbGFyZSBjb25zdCBCQVNFVVJMOiBzdHJpbmc7XG5cbmNvbnN0IGxvYWRlciA9IHZlZ2EubG9hZGVyKHtcbiAgYmFzZVVSTDogQkFTRVVSTFxufSk7XG5cbmNvbnN0IGVkaXRvclVSTCA9ICdodHRwczovL3ZlZ2EuZ2l0aHViLmlvL2VkaXRvci8nO1xuXG5mdW5jdGlvbiB0cmltKHN0cjogc3RyaW5nKSB7XG4gIHJldHVybiBzdHIucmVwbGFjZSgvXlxccyt8XFxzKyQvZywgJycpO1xufVxuXG4vKiBBbmNob3JzICovXG5zZWxlY3RBbGwoJ2gyLCBoMywgaDQsIGg1LCBoNicpLmVhY2goZnVuY3Rpb24odGhpczogZDMuQmFzZVR5cGUpIHtcbiAgY29uc3Qgc2VsID0gc2VsZWN0KHRoaXMpO1xuICBjb25zdCBuYW1lID0gc2VsLmF0dHIoJ2lkJyk7XG4gIGNvbnN0IHRpdGxlID0gc2VsLnRleHQoKTtcbiAgc2VsLmh0bWwoJzxhIGhyZWY9XCIjJyArIG5hbWUgKyAnXCIgY2xhc3M9XCJhbmNob3JcIj48c3BhbiBjbGFzcz1cIm9jdGljb24gb2N0aWNvbi1saW5rXCI+PC9zcGFuPjwvYT4nICsgdHJpbSh0aXRsZSkpO1xufSk7XG5cbi8qIERvY3VtZW50YXRpb24gKi9cbmZ1bmN0aW9uIHJlbmRlckV4YW1wbGUoJHRhcmdldDogU2VsZWN0aW9uPGFueSwgYW55LCBhbnksIGFueT4sIHNwZWNUZXh0OiBzdHJpbmcpIHtcbiAgJHRhcmdldC5jbGFzc2VkKCdleGFtcGxlJywgdHJ1ZSk7XG4gICR0YXJnZXQudGV4dCgnJyk7XG5cbiAgY29uc3QgdmlzID0gJHRhcmdldC5hcHBlbmQoJ2RpdicpLmF0dHIoJ2NsYXNzJywgJ2V4YW1wbGUtdmlzJyk7XG5cbiAgLy8gRGVjcmVhc2UgdmlzdWFsIG5vaXNlIGJ5IHJlbW92aW5nICRzY2hlbWEgYW5kIGRlc2NyaXB0aW9uIGZyb20gY29kZSBleGFtcGxlcy5cbiAgY29uc3QgdGV4dENsZWFuID0gc3BlY1RleHQucmVwbGFjZSgvKFxccykrXFxcIihcXCRzY2hlbWF8ZGVzY3JpcHRpb24pXFxcIjogXFxcIi4qP1xcXCIsL2csICcnKTtcbiAgY29uc3QgY29kZSA9ICR0YXJnZXQuYXBwZW5kKCdwcmUnKS5hdHRyKCdjbGFzcycsICdleGFtcGxlLWNvZGUnKVxuICAuYXBwZW5kKCdjb2RlJykuYXR0cignY2xhc3MnLCAnanNvbicpLnRleHQodGV4dENsZWFuKTtcbiAgaGxqcy5oaWdobGlnaHRCbG9jayhjb2RlLm5vZGUoKSBhcyBhbnkpO1xuXG4gIGNvbnN0IHNwZWMgPSBKU09OLnBhcnNlKHNwZWNUZXh0KTtcblxuICBlbWJlZEV4YW1wbGUodmlzLm5vZGUoKSwgc3BlYywgdHJ1ZSwgISR0YXJnZXQuY2xhc3NlZCgnbm8tdG9vbHRpcCcpKTtcbn1cblxuZnVuY3Rpb24gZW1iZWRFeGFtcGxlKCR0YXJnZXQ6IGFueSwgc3BlYzogVG9wTGV2ZWxTcGVjLCBhY3Rpb25zPXRydWUsIHRvb2x0aXA9dHJ1ZSkge1xuICBjb25zdCB2Z1NwZWMgPSBjb21waWxlKHNwZWMpLnNwZWM7XG5cbiAgY29uc3QgdmlldyA9IG5ldyB2ZWdhLlZpZXcodmVnYS5wYXJzZSh2Z1NwZWMpLCB7bG9hZGVyOiBsb2FkZXJ9KVxuICAgIC5yZW5kZXJlcignc3ZnJylcbiAgICAuaW5pdGlhbGl6ZSgkdGFyZ2V0KTtcblxuICBpZiAodG9vbHRpcCkge1xuICAgIGNvbnN0IGhhbmRsZXIgPSBuZXcgSGFuZGxlcigpLmNhbGw7XG4gICAgdmlldy50b29sdGlwKGhhbmRsZXIpO1xuICB9XG5cbiAgdmlldy5ydW4oKTtcblxuICBpZiAoYWN0aW9ucykge1xuICAgIHNlbGVjdCgkdGFyZ2V0KVxuICAgICAgLmFwcGVuZCgnZGl2JylcbiAgICAgIC5hdHRyKCdjbGFzcycsICd2ZWdhLWFjdGlvbnMnKVxuICAgICAgLmFwcGVuZCgnYScpXG4gICAgICAudGV4dCgnT3BlbiBpbiBWZWdhIEVkaXRvcicpXG4gICAgICAuYXR0cignaHJlZicsICcjJylcbiAgICAgIC5vbignY2xpY2snLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHBvc3Qod2luZG93LCBlZGl0b3JVUkwsIHtcbiAgICAgICAgICBtb2RlOiAndmVnYS1saXRlJyxcbiAgICAgICAgICBzcGVjOiBKU09OLnN0cmluZ2lmeShzcGVjLCBudWxsLCAyKSxcbiAgICAgICAgICBjb25maWc6IHZnU3BlYy5jb25maWcsXG4gICAgICAgICAgcmVuZGVyZXI6ICdzdmcnXG4gICAgICAgIH0pO1xuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgfSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0U3BlYyhlbDogZDMuQmFzZVR5cGUpIHtcbiAgY29uc3Qgc2VsID0gc2VsZWN0KGVsKTtcbiAgY29uc3QgbmFtZSA9IHNlbC5hdHRyKCdkYXRhLW5hbWUnKTtcbiAgaWYgKG5hbWUpIHtcbiAgICBjb25zdCBkaXIgPSBzZWwuYXR0cignZGF0YS1kaXInKTtcbiAgICBjb25zdCBmdWxsVXJsID0gQkFTRVVSTCArICcvZXhhbXBsZXMvc3BlY3MvJyArIChkaXIgPyAoZGlyICsgJy8nKSA6ICcnKSArIG5hbWUgKyAnLnZsLmpzb24nO1xuXG4gICAgdGV4dChmdWxsVXJsKS50aGVuKHNwZWMgPT4ge1xuICAgICAgcmVuZGVyRXhhbXBsZShzZWwsIHNwZWMpO1xuICAgIH0pLmNhdGNoKGNvbnNvbGUuZXJyb3IpO1xuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUuZXJyb3IoJ05vIFwiZGF0YS1uYW1lXCIgc3BlY2lmaWVkIHRvIGltcG9ydCBleGFtcGxlcyBmcm9tJyk7XG4gIH1cbn1cblxud2luZG93WydjaGFuZ2VTcGVjJ10gPSBmdW5jdGlvbihlbElkOiBzdHJpbmcsIG5ld1NwZWM6IHN0cmluZykge1xuICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGVsSWQpO1xuICBzZWxlY3QoZWwpLmF0dHIoJ2RhdGEtbmFtZScsIG5ld1NwZWMpO1xuICBnZXRTcGVjKGVsKTtcbn07XG5cbndpbmRvd1snYnVpbGRTcGVjT3B0cyddID0gZnVuY3Rpb24oaWQ6IHN0cmluZywgYmFzZU5hbWU6IHN0cmluZykge1xuICBjb25zdCBvbGROYW1lID0gc2VsZWN0KCcjJyArIGlkKS5hdHRyKCdkYXRhLW5hbWUnKTtcbiAgY29uc3QgcHJlZml4U2VsID0gc2VsZWN0KCdzZWxlY3RbbmFtZT0nICsgaWQgKyAnXScpO1xuICBjb25zdCBpbnB1dHNTZWwgPSBzZWxlY3RBbGwoJ2lucHV0W25hbWU9JyArIGlkICsgJ106Y2hlY2tlZCcpO1xuICBjb25zdCBwcmVmaXggPSBwcmVmaXhTZWwuZW1wdHkoKSA/IGlkIDogcHJlZml4U2VsLnByb3BlcnR5KCd2YWx1ZScpO1xuICBjb25zdCB2YWx1ZXMgPSBpbnB1dHNTZWwubm9kZXMoKS5tYXAoKG46IGFueSkgPT4gbi52YWx1ZSkuc29ydCgpLmpvaW4oJ18nKTtcbiAgY29uc3QgbmV3TmFtZSA9IGJhc2VOYW1lICsgcHJlZml4ICsgKHZhbHVlcyA/ICdfJyArIHZhbHVlcyA6ICcnKTtcbiAgaWYgKG9sZE5hbWUgIT09IG5ld05hbWUpIHtcbiAgICB3aW5kb3dbJ2NoYW5nZVNwZWMnXShpZCwgbmV3TmFtZSk7XG4gIH1cbn07XG5cbnNlbGVjdEFsbCgnLnZsLWV4YW1wbGUnKS5lYWNoKGZ1bmN0aW9uKHRoaXM6IGQzLkJhc2VUeXBlKSB7XG4gIGdldFNwZWModGhpcyk7XG59KTtcblxuLy8gY2Fyb3Vzc2VsIGZvciB0aGUgZnJvbnQgcGFnZVxuLy8gYWRhcHRlZCBmcm9tIGh0dHBzOi8vY29kZXBlbi5pby9MQU5wYXJ0eS9wZW4vd2VQWVhiXG5cbmNvbnN0IGNhcm91c2VsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Nhcm91c2VsJyk7XG5cbmZ1bmN0aW9uIGNhcm91c2VsSGlkZShzbGlkZXM6IE5vZGVMaXN0T2Y8YW55PiwgaW5kaWNhdG9yczogTm9kZUxpc3RPZjxhbnk+LCBsaW5rczogTm9kZUxpc3RPZjxhbnk+LCBhY3RpdmU6IG51bWJlcikge1xuICBpbmRpY2F0b3JzW2FjdGl2ZV0uc2V0QXR0cmlidXRlKCdkYXRhLXN0YXRlJywgJycpO1xuICBsaW5rc1thY3RpdmVdLnNldEF0dHJpYnV0ZSgnZGF0YS1zdGF0ZScsICcnKTtcbiAgc2xpZGVzW2FjdGl2ZV0uc2V0QXR0cmlidXRlKCdkYXRhLXN0YXRlJywgJycpO1xuICBzbGlkZXNbYWN0aXZlXS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuXG4gIGNvbnN0IHZpZGVvID0gc2xpZGVzW2FjdGl2ZV0ucXVlcnlTZWxlY3RvcigndmlkZW8nKTtcbiAgaWYgKHZpZGVvKSB7XG4gICAgdmlkZW8ucGF1c2UoKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjYXJvdXNlbFNob3coc2xpZGVzOiBOb2RlTGlzdE9mPGFueT4sIGluZGljYXRvcnM6IE5vZGVMaXN0T2Y8YW55PiwgbGlua3M6IE5vZGVMaXN0T2Y8YW55PiwgYWN0aXZlOiBudW1iZXIpIHtcbiAgaW5kaWNhdG9yc1thY3RpdmVdLmNoZWNrZWQgPSB0cnVlO1xuICBpbmRpY2F0b3JzW2FjdGl2ZV0uc2V0QXR0cmlidXRlKCdkYXRhLXN0YXRlJywgJ2FjdGl2ZScpO1xuICBsaW5rc1thY3RpdmVdLnNldEF0dHJpYnV0ZSgnZGF0YS1zdGF0ZScsICdhY3RpdmUnKTtcbiAgc2xpZGVzW2FjdGl2ZV0uc2V0QXR0cmlidXRlKCdkYXRhLXN0YXRlJywgJ2FjdGl2ZScpO1xuXG4gIGNvbnN0IHZpZGVvID0gc2xpZGVzW2FjdGl2ZV0ucXVlcnlTZWxlY3RvcigndmlkZW8nKTtcbiAgaWYgKHZpZGVvKSB7XG4gICAgdmlkZW8uY3VycmVudFRpbWUgPSAwO1xuICAgIHNsaWRlc1thY3RpdmVdLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xuICAgIHZpZGVvLnBsYXkoKTtcbiAgfSBlbHNlIHtcbiAgICBzbGlkZXNbYWN0aXZlXS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgfVxufVxuXG5mdW5jdGlvbiBzZXRTbGlkZShzbGlkZXM6IE5vZGVMaXN0T2Y8RWxlbWVudD4sIGluZGljYXRvcnM6IE5vZGVMaXN0T2Y8RWxlbWVudD4sIGxpbmtzOiBOb2RlTGlzdE9mPGFueT4sIGFjdGl2ZTogbnVtYmVyKSB7XG4gIHJldHVybiBmdW5jdGlvbigpIHtcbiAgICAvLyBSZXNldCBhbGwgc2xpZGVzXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRpY2F0b3JzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpbmRpY2F0b3JzW2ldLnNldEF0dHJpYnV0ZSgnZGF0YS1zdGF0ZScsICcnKTtcbiAgICAgIHNsaWRlc1tpXS5zZXRBdHRyaWJ1dGUoJ2RhdGEtc3RhdGUnLCAnJyk7XG4gICAgICBjYXJvdXNlbEhpZGUoc2xpZGVzLCBpbmRpY2F0b3JzLCBsaW5rcywgaSk7XG4gICAgfVxuXG4gICAgLy8gU2V0IGRlZmluZWQgc2xpZGUgYXMgYWN0aXZlXG4gICAgaW5kaWNhdG9yc1thY3RpdmVdLnNldEF0dHJpYnV0ZSgnZGF0YS1zdGF0ZScsICdhY3RpdmUnKTtcbiAgICBzbGlkZXNbYWN0aXZlXS5zZXRBdHRyaWJ1dGUoJ2RhdGEtc3RhdGUnLCAnYWN0aXZlJyk7XG4gICAgY2Fyb3VzZWxTaG93KHNsaWRlcywgaW5kaWNhdG9ycywgbGlua3MsIGFjdGl2ZSk7XG5cbiAgICAvLyBTd2l0Y2ggYnV0dG9uIHRleHRcbiAgICBjb25zdCBudW1TbGlkZXMgPSBjYXJvdXNlbC5xdWVyeVNlbGVjdG9yQWxsKCcuaW5kaWNhdG9yJykubGVuZ3RoO1xuICAgIGlmIChudW1TbGlkZXMgPT09IGFjdGl2ZSArIDEpIHtcbiAgICAgIGNhcm91c2VsLnF1ZXJ5U2VsZWN0b3IoJy5uZXh0LXNsaWRlJykudGV4dENvbnRlbnQgPSAnU3RhcnQgb3Zlcic7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNhcm91c2VsLnF1ZXJ5U2VsZWN0b3IoJy5uZXh0LXNsaWRlJykudGV4dENvbnRlbnQgPSAnTmV4dCBzdGVwJztcbiAgICB9XG4gIH07XG59XG5cbmlmIChjYXJvdXNlbCkge1xuICBjb25zdCBzbGlkZXMgPSBjYXJvdXNlbC5xdWVyeVNlbGVjdG9yQWxsKCcuc2xpZGUnKTtcbiAgY29uc3QgaW5kaWNhdG9ycyA9IGNhcm91c2VsLnF1ZXJ5U2VsZWN0b3JBbGwoJy5pbmRpY2F0b3InKTtcbiAgY29uc3QgbGlua3MgPSBjYXJvdXNlbC5xdWVyeVNlbGVjdG9yQWxsKCcuc2xpZGUtbmF2Jyk7XG5cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnByZWZlci1mb3Itb2ZcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRpY2F0b3JzLmxlbmd0aDsgaSsrKSB7XG4gICAgaW5kaWNhdG9yc1tpXS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHNldFNsaWRlKHNsaWRlcywgaW5kaWNhdG9ycywgbGlua3MsICtpbmRpY2F0b3JzW2ldLmdldEF0dHJpYnV0ZSgnZGF0YS1zbGlkZScpKSk7XG4gIH1cblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6cHJlZmVyLWZvci1vZlxuICBmb3IgKGxldCBpID0gMDsgaSA8IGxpbmtzLmxlbmd0aDsgaSsrKSB7XG4gICAgbGlua3NbaV0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBzZXRTbGlkZShzbGlkZXMsIGluZGljYXRvcnMsIGxpbmtzLCArbGlua3NbaV0uZ2V0QXR0cmlidXRlKCdkYXRhLXNsaWRlJykpKTtcbiAgfVxuXG4gIGNhcm91c2VsLnF1ZXJ5U2VsZWN0b3IoJy5uZXh0LXNsaWRlJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgY29uc3Qgc2xpZGUgPSArY2Fyb3VzZWwucXVlcnlTZWxlY3RvcignLmluZGljYXRvcltkYXRhLXN0YXRlPWFjdGl2ZV0nKS5nZXRBdHRyaWJ1dGUoJ2RhdGEtc2xpZGUnKTtcbiAgICBjb25zdCBudW1TbGlkZXMgPSBjYXJvdXNlbC5xdWVyeVNlbGVjdG9yQWxsKCcuaW5kaWNhdG9yJykubGVuZ3RoO1xuICAgIHNldFNsaWRlKHNsaWRlcywgaW5kaWNhdG9ycywgbGlua3MsIChzbGlkZSArIDEpICUgbnVtU2xpZGVzKSgpO1xuICB9KTtcblxuICBbXS5mb3JFYWNoLmNhbGwoc2xpZGVzLCAoc2xpZGU6IEVsZW1lbnQpID0+IHtcbiAgICBjb25zdCB2aWRlbyA9IHNsaWRlLnF1ZXJ5U2VsZWN0b3IoJ3ZpZGVvJyk7XG4gICAgaWYgKHZpZGVvKSB7XG4gICAgICB2aWRlby5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW92ZXInLCAoKSA9PiB7XG4gICAgICAgIChzbGlkZS5xdWVyeVNlbGVjdG9yKCcuZXhhbXBsZS12aXMnKSBhcyBhbnkpLnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7XG4gICAgICAgIHZpZGVvLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgICAgIHZpZGVvLnBhdXNlKCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xufVxuIl19