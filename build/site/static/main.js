"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var d3_request_1 = require("d3-request");
var d3_selection_1 = require("d3-selection");
var hljs = require("highlight.js");
var vega = require("vega");
var post_1 = require("vega-embed/build/post");
var vega_tooltip_1 = require("vega-tooltip");
var src_1 = require("../../src");
var streaming_1 = require("./streaming");
window['runStreamingExample'] = streaming_1.runStreamingExample;
window['embedExample'] = embedExample;
var loader = vega.loader({
    baseURL: BASEURL
});
var editorURL = 'https://vega.github.io/editor/';
function trim(str) {
    return str.replace(/^\s+|\s+$/g, '');
}
/* Anchors */
d3_selection_1.selectAll('h2, h3, h4, h5, h6').each(function () {
    var sel = d3_selection_1.select(this);
    var name = sel.attr('id');
    var title = sel.text();
    sel.html('<a href="#' + name + '" class="anchor"><span class="octicon octicon-link"></span></a>' + trim(title));
});
/* Documentation */
function renderExample($target, specText) {
    $target.classed('example', true);
    $target.text('');
    var vis = $target.append('div').attr('class', 'example-vis');
    // Decrease visual noise by removing $schema and description from code examples.
    var textClean = specText.replace(/(\s)+\"(\$schema|description)\": \".*?\",/g, '');
    var code = $target.append('pre').attr('class', 'example-code')
        .append('code').attr('class', 'json').text(textClean);
    hljs.highlightBlock(code.node());
    var spec = JSON.parse(specText);
    embedExample(vis.node(), spec, true, $target.classed('tooltip'));
}
function embedExample($target, spec, actions, tooltip) {
    if (actions === void 0) { actions = true; }
    if (tooltip === void 0) { tooltip = false; }
    var vgSpec = src_1.compile(spec).spec;
    var view = new vega.View(vega.parse(vgSpec), { loader: loader })
        .renderer('svg')
        .initialize($target)
        .run();
    var div = d3_selection_1.select($target)
        .append('div')
        .attr('class', 'vega-actions')
        .append('a')
        .text('Open in Vega Editor')
        .attr('href', '#')
        .on('click', function () {
        post_1.post(window, editorURL, {
            mode: 'vega-lite',
            spec: JSON.stringify(spec, null, 2),
            config: vgSpec.config,
            renderer: 'svg'
        });
        d3_selection_1.event.preventDefault();
    });
    if (tooltip) {
        vega_tooltip_1.vegaLite(view, spec);
    }
}
function getSpec(el) {
    var sel = d3_selection_1.select(el);
    var name = sel.attr('data-name');
    if (name) {
        var dir = sel.attr('data-dir');
        var fullUrl = BASEURL + '/examples/specs/' + (dir ? (dir + '/') : '') + name + '.vl.json';
        d3_request_1.text(fullUrl, function (error, spec) {
            if (error) {
                console.error(error);
            }
            else {
                renderExample(sel, spec);
            }
        });
    }
    else {
        console.error('No "data-name" specified to import examples from');
    }
}
window['changeSpec'] = function (elId, newSpec) {
    var el = document.getElementById(elId);
    d3_selection_1.select(el).attr('data-name', newSpec);
    getSpec(el);
};
window['buildSpecOpts'] = function (id, baseName) {
    var oldName = d3_selection_1.select('#' + id).attr('data-name');
    var prefixSel = d3_selection_1.select('select[name=' + id + ']');
    var inputsSel = d3_selection_1.selectAll('input[name=' + id + ']:checked');
    var prefix = prefixSel.empty() ? id : prefixSel.property('value');
    var values = inputsSel.nodes().map(function (n) { return n.value; }).sort().join('_');
    var newName = baseName + prefix + (values ? '_' + values : '');
    if (oldName !== newName) {
        window['changeSpec'](id, newName);
    }
};
d3_selection_1.selectAll('.vl-example').each(function () {
    getSpec(this);
});
// caroussel for the front page
// adapted from https://codepen.io/LANparty/pen/wePYXb
var carousel = document.getElementById('carousel');
function carouselHide(slides, indicators, links, active) {
    indicators[active].setAttribute('data-state', '');
    links[active].setAttribute('data-state', '');
    slides[active].setAttribute('data-state', '');
    slides[active].style.display = 'none';
    var video = slides[active].querySelector('video');
    if (video) {
        video.pause();
    }
}
function carouselShow(slides, indicators, links, active) {
    indicators[active].checked = true;
    indicators[active].setAttribute('data-state', 'active');
    links[active].setAttribute('data-state', 'active');
    slides[active].setAttribute('data-state', 'active');
    var video = slides[active].querySelector('video');
    if (video) {
        video.currentTime = 0;
        slides[active].style.display = 'block';
        video.play();
    }
    else {
        slides[active].style.display = 'block';
    }
}
function setSlide(slides, indicators, links, active) {
    return function () {
        // Reset all slides
        for (var i = 0; i < indicators.length; i++) {
            indicators[i].setAttribute('data-state', '');
            slides[i].setAttribute('data-state', '');
            carouselHide(slides, indicators, links, i);
        }
        // Set defined slide as active
        indicators[active].setAttribute('data-state', 'active');
        slides[active].setAttribute('data-state', 'active');
        carouselShow(slides, indicators, links, active);
        // Switch button text
        var numSlides = carousel.querySelectorAll('.indicator').length;
        if (numSlides === active + 1) {
            carousel.querySelector('.next-slide').textContent = 'Start over';
        }
        else {
            carousel.querySelector('.next-slide').textContent = 'Next step';
        }
    };
}
if (carousel) {
    var slides_1 = carousel.querySelectorAll('.slide');
    var indicators_1 = carousel.querySelectorAll('.indicator');
    var links_1 = carousel.querySelectorAll('.slide-nav');
    // tslint:disable-next-line:prefer-for-of
    for (var i = 0; i < indicators_1.length; i++) {
        indicators_1[i].addEventListener('click', setSlide(slides_1, indicators_1, links_1, +indicators_1[i].getAttribute('data-slide')));
    }
    // tslint:disable-next-line:prefer-for-of
    for (var i = 0; i < links_1.length; i++) {
        links_1[i].addEventListener('click', setSlide(slides_1, indicators_1, links_1, +links_1[i].getAttribute('data-slide')));
    }
    carousel.querySelector('.next-slide').addEventListener('click', function () {
        var slide = +carousel.querySelector('.indicator[data-state=active]').getAttribute('data-slide');
        var numSlides = carousel.querySelectorAll('.indicator').length;
        setSlide(slides_1, indicators_1, links_1, (slide + 1) % numSlides)();
    });
    [].forEach.call(slides_1, function (slide) {
        var video = slide.querySelector('video');
        if (video) {
            video.addEventListener('mouseover', function () {
                slide.querySelector('.example-vis').style.visibility = 'visible';
                video.style.display = 'none';
                video.pause();
            });
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NpdGUvc3RhdGljL21haW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx5Q0FBZ0M7QUFDaEMsNkNBQWlFO0FBQ2pFLG1DQUFxQztBQUNyQywyQkFBNkI7QUFDN0IsOENBQTJDO0FBQzNDLDZDQUFzQztBQUV0QyxpQ0FBZ0Q7QUFDaEQseUNBQWdEO0FBRWhELE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxHQUFHLCtCQUFtQixDQUFDO0FBQ3BELE1BQU0sQ0FBQyxjQUFjLENBQUMsR0FBRyxZQUFZLENBQUM7QUFJdEMsSUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN6QixPQUFPLEVBQUUsT0FBTztDQUNqQixDQUFDLENBQUM7QUFFSCxJQUFNLFNBQVMsR0FBRyxnQ0FBZ0MsQ0FBQztBQUVuRCxjQUFjLEdBQVc7SUFDdkIsT0FBTyxHQUFHLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUMsQ0FBQztBQUN2QyxDQUFDO0FBRUQsYUFBYTtBQUNiLHdCQUFTLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDbkMsSUFBTSxHQUFHLEdBQUcscUJBQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN6QixJQUFNLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVCLElBQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUN6QixHQUFHLENBQUMsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLEdBQUcsaUVBQWlFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7QUFDbEgsQ0FBQyxDQUFDLENBQUM7QUFFSCxtQkFBbUI7QUFDbkIsdUJBQXVCLE9BQXNDLEVBQUUsUUFBZ0I7SUFDN0UsT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUM7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Z0JBQWdCLENBQUMsV0FBVyxFQUFFO2dCQUNqQyxLQUFLLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBUyxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUcsU0FBUyxDQUFDO2dCQUMxRSxLQUFLLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7Z0JBQzdCLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNoQixDQUFDLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQyxDQUFDLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7dGV4dH0gZnJvbSAnZDMtcmVxdWVzdCc7XG5pbXBvcnQge2V2ZW50LCBzZWxlY3QsIHNlbGVjdEFsbCwgU2VsZWN0aW9ufSBmcm9tICdkMy1zZWxlY3Rpb24nO1xuaW1wb3J0ICogYXMgaGxqcyBmcm9tICdoaWdobGlnaHQuanMnO1xuaW1wb3J0ICogYXMgdmVnYSBmcm9tICd2ZWdhJztcbmltcG9ydCB7cG9zdH0gZnJvbSAndmVnYS1lbWJlZC9idWlsZC9wb3N0JztcbmltcG9ydCB7dmVnYUxpdGV9IGZyb20gJ3ZlZ2EtdG9vbHRpcCc7XG5cbmltcG9ydCB7Y29tcGlsZSwgVG9wTGV2ZWxTcGVjfSBmcm9tICcuLi8uLi9zcmMnO1xuaW1wb3J0IHtydW5TdHJlYW1pbmdFeGFtcGxlfSBmcm9tICcuL3N0cmVhbWluZyc7XG5cbndpbmRvd1sncnVuU3RyZWFtaW5nRXhhbXBsZSddID0gcnVuU3RyZWFtaW5nRXhhbXBsZTtcbndpbmRvd1snZW1iZWRFeGFtcGxlJ10gPSBlbWJlZEV4YW1wbGU7XG5cbmRlY2xhcmUgY29uc3QgQkFTRVVSTDogc3RyaW5nO1xuXG5jb25zdCBsb2FkZXIgPSB2ZWdhLmxvYWRlcih7XG4gIGJhc2VVUkw6IEJBU0VVUkxcbn0pO1xuXG5jb25zdCBlZGl0b3JVUkwgPSAnaHR0cHM6Ly92ZWdhLmdpdGh1Yi5pby9lZGl0b3IvJztcblxuZnVuY3Rpb24gdHJpbShzdHI6IHN0cmluZykge1xuICByZXR1cm4gc3RyLnJlcGxhY2UoL15cXHMrfFxccyskL2csICcnKTtcbn1cblxuLyogQW5jaG9ycyAqL1xuc2VsZWN0QWxsKCdoMiwgaDMsIGg0LCBoNSwgaDYnKS5lYWNoKGZ1bmN0aW9uKHRoaXM6IGQzLkJhc2VUeXBlKSB7XG4gIGNvbnN0IHNlbCA9IHNlbGVjdCh0aGlzKTtcbiAgY29uc3QgbmFtZSA9IHNlbC5hdHRyKCdpZCcpO1xuICBjb25zdCB0aXRsZSA9IHNlbC50ZXh0KCk7XG4gIHNlbC5odG1sKCc8YSBocmVmPVwiIycgKyBuYW1lICsgJ1wiIGNsYXNzPVwiYW5jaG9yXCI+PHNwYW4gY2xhc3M9XCJvY3RpY29uIG9jdGljb24tbGlua1wiPjwvc3Bhbj48L2E+JyArIHRyaW0odGl0bGUpKTtcbn0pO1xuXG4vKiBEb2N1bWVudGF0aW9uICovXG5mdW5jdGlvbiByZW5kZXJFeGFtcGxlKCR0YXJnZXQ6IFNlbGVjdGlvbjxhbnksIGFueSwgYW55LCBhbnk+LCBzcGVjVGV4dDogc3RyaW5nKSB7XG4gICR0YXJnZXQuY2xhc3NlZCgnZXhhbXBsZScsIHRydWUpO1xuICAkdGFyZ2V0LnRleHQoJycpO1xuXG4gIGNvbnN0IHZpcyA9ICR0YXJnZXQuYXBwZW5kKCdkaXYnKS5hdHRyKCdjbGFzcycsICdleGFtcGxlLXZpcycpO1xuXG4gIC8vIERlY3JlYXNlIHZpc3VhbCBub2lzZSBieSByZW1vdmluZyAkc2NoZW1hIGFuZCBkZXNjcmlwdGlvbiBmcm9tIGNvZGUgZXhhbXBsZXMuXG4gIGNvbnN0IHRleHRDbGVhbiA9IHNwZWNUZXh0LnJlcGxhY2UoLyhcXHMpK1xcXCIoXFwkc2NoZW1hfGRlc2NyaXB0aW9uKVxcXCI6IFxcXCIuKj9cXFwiLC9nLCAnJyk7XG4gIGNvbnN0IGNvZGUgPSAkdGFyZ2V0LmFwcGVuZCgncHJlJykuYXR0cignY2xhc3MnLCAnZXhhbXBsZS1jb2RlJylcbiAgLmFwcGVuZCgnY29kZScpLmF0dHIoJ2NsYXNzJywgJ2pzb24nKS50ZXh0KHRleHRDbGVhbik7XG4gIGhsanMuaGlnaGxpZ2h0QmxvY2soY29kZS5ub2RlKCkgYXMgYW55KTtcblxuICBjb25zdCBzcGVjID0gSlNPTi5wYXJzZShzcGVjVGV4dCk7XG5cbiAgZW1iZWRFeGFtcGxlKHZpcy5ub2RlKCksIHNwZWMsIHRydWUsICR0YXJnZXQuY2xhc3NlZCgndG9vbHRpcCcpKTtcbn1cblxuZnVuY3Rpb24gZW1iZWRFeGFtcGxlKCR0YXJnZXQ6IGFueSwgc3BlYzogVG9wTGV2ZWxTcGVjLCBhY3Rpb25zPXRydWUsIHRvb2x0aXA9ZmFsc2UpIHtcbiAgY29uc3QgdmdTcGVjID0gY29tcGlsZShzcGVjKS5zcGVjO1xuICBjb25zdCB2aWV3ID0gbmV3IHZlZ2EuVmlldyh2ZWdhLnBhcnNlKHZnU3BlYyksIHtsb2FkZXI6IGxvYWRlcn0pXG4gICAgLnJlbmRlcmVyKCdzdmcnKVxuICAgIC5pbml0aWFsaXplKCR0YXJnZXQpXG4gICAgLnJ1bigpO1xuXG4gIGNvbnN0IGRpdiA9IHNlbGVjdCgkdGFyZ2V0KVxuICAgIC5hcHBlbmQoJ2RpdicpXG4gICAgLmF0dHIoJ2NsYXNzJywgJ3ZlZ2EtYWN0aW9ucycpXG4gICAgLmFwcGVuZCgnYScpXG4gICAgLnRleHQoJ09wZW4gaW4gVmVnYSBFZGl0b3InKVxuICAgIC5hdHRyKCdocmVmJywgJyMnKVxuICAgIC5vbignY2xpY2snLCBmdW5jdGlvbiAoKSB7XG4gICAgICBwb3N0KHdpbmRvdywgZWRpdG9yVVJMLCB7XG4gICAgICAgIG1vZGU6ICd2ZWdhLWxpdGUnLFxuICAgICAgICBzcGVjOiBKU09OLnN0cmluZ2lmeShzcGVjLCBudWxsLCAyKSxcbiAgICAgICAgY29uZmlnOiB2Z1NwZWMuY29uZmlnLFxuICAgICAgICByZW5kZXJlcjogJ3N2ZydcbiAgICB9KTtcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICB9KTtcblxuICBpZiAodG9vbHRpcCkge1xuICAgIHZlZ2FMaXRlKHZpZXcsIHNwZWMgYXMgYW55KTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRTcGVjKGVsOiBkMy5CYXNlVHlwZSkge1xuICBjb25zdCBzZWwgPSBzZWxlY3QoZWwpO1xuICBjb25zdCBuYW1lID0gc2VsLmF0dHIoJ2RhdGEtbmFtZScpO1xuICBpZiAobmFtZSkge1xuICAgIGNvbnN0IGRpciA9IHNlbC5hdHRyKCdkYXRhLWRpcicpO1xuICAgIGNvbnN0IGZ1bGxVcmwgPSBCQVNFVVJMICsgJy9leGFtcGxlcy9zcGVjcy8nICsgKGRpciA/IChkaXIgKyAnLycpIDogJycpICsgbmFtZSArICcudmwuanNvbic7XG5cbiAgICB0ZXh0KGZ1bGxVcmwsIGZ1bmN0aW9uKGVycm9yLCBzcGVjKSB7XG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZW5kZXJFeGFtcGxlKHNlbCwgc3BlYyk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgY29uc29sZS5lcnJvcignTm8gXCJkYXRhLW5hbWVcIiBzcGVjaWZpZWQgdG8gaW1wb3J0IGV4YW1wbGVzIGZyb20nKTtcbiAgfVxufVxuXG53aW5kb3dbJ2NoYW5nZVNwZWMnXSA9IGZ1bmN0aW9uKGVsSWQ6IHN0cmluZywgbmV3U3BlYzogc3RyaW5nKSB7XG4gIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZWxJZCk7XG4gIHNlbGVjdChlbCkuYXR0cignZGF0YS1uYW1lJywgbmV3U3BlYyk7XG4gIGdldFNwZWMoZWwpO1xufTtcblxud2luZG93WydidWlsZFNwZWNPcHRzJ10gPSBmdW5jdGlvbihpZDogc3RyaW5nLCBiYXNlTmFtZTogc3RyaW5nKSB7XG4gIGNvbnN0IG9sZE5hbWUgPSBzZWxlY3QoJyMnICsgaWQpLmF0dHIoJ2RhdGEtbmFtZScpO1xuICBjb25zdCBwcmVmaXhTZWwgPSBzZWxlY3QoJ3NlbGVjdFtuYW1lPScgKyBpZCArICddJyk7XG4gIGNvbnN0IGlucHV0c1NlbCA9IHNlbGVjdEFsbCgnaW5wdXRbbmFtZT0nICsgaWQgKyAnXTpjaGVja2VkJyk7XG4gIGNvbnN0IHByZWZpeCA9IHByZWZpeFNlbC5lbXB0eSgpID8gaWQgOiBwcmVmaXhTZWwucHJvcGVydHkoJ3ZhbHVlJyk7XG4gIGNvbnN0IHZhbHVlcyA9IGlucHV0c1NlbC5ub2RlcygpLm1hcCgobjogYW55KSA9PiBuLnZhbHVlKS5zb3J0KCkuam9pbignXycpO1xuICBjb25zdCBuZXdOYW1lID0gYmFzZU5hbWUgKyBwcmVmaXggKyAodmFsdWVzID8gJ18nICsgdmFsdWVzIDogJycpO1xuICBpZiAob2xkTmFtZSAhPT0gbmV3TmFtZSkge1xuICAgIHdpbmRvd1snY2hhbmdlU3BlYyddKGlkLCBuZXdOYW1lKTtcbiAgfVxufTtcblxuc2VsZWN0QWxsKCcudmwtZXhhbXBsZScpLmVhY2goZnVuY3Rpb24odGhpczogZDMuQmFzZVR5cGUpIHtcbiAgZ2V0U3BlYyh0aGlzKTtcbn0pO1xuXG4vLyBjYXJvdXNzZWwgZm9yIHRoZSBmcm9udCBwYWdlXG4vLyBhZGFwdGVkIGZyb20gaHR0cHM6Ly9jb2RlcGVuLmlvL0xBTnBhcnR5L3Blbi93ZVBZWGJcblxuY29uc3QgY2Fyb3VzZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2Fyb3VzZWwnKTtcblxuZnVuY3Rpb24gY2Fyb3VzZWxIaWRlKHNsaWRlczogTm9kZUxpc3RPZjxhbnk+LCBpbmRpY2F0b3JzOiBOb2RlTGlzdE9mPGFueT4sIGxpbmtzOiBOb2RlTGlzdE9mPGFueT4sIGFjdGl2ZTogbnVtYmVyKSB7XG4gIGluZGljYXRvcnNbYWN0aXZlXS5zZXRBdHRyaWJ1dGUoJ2RhdGEtc3RhdGUnLCAnJyk7XG4gIGxpbmtzW2FjdGl2ZV0uc2V0QXR0cmlidXRlKCdkYXRhLXN0YXRlJywgJycpO1xuICBzbGlkZXNbYWN0aXZlXS5zZXRBdHRyaWJ1dGUoJ2RhdGEtc3RhdGUnLCAnJyk7XG4gIHNsaWRlc1thY3RpdmVdLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG5cbiAgY29uc3QgdmlkZW8gPSBzbGlkZXNbYWN0aXZlXS5xdWVyeVNlbGVjdG9yKCd2aWRlbycpO1xuICBpZiAodmlkZW8pIHtcbiAgICB2aWRlby5wYXVzZSgpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNhcm91c2VsU2hvdyhzbGlkZXM6IE5vZGVMaXN0T2Y8YW55PiwgaW5kaWNhdG9yczogTm9kZUxpc3RPZjxhbnk+LCBsaW5rczogTm9kZUxpc3RPZjxhbnk+LCBhY3RpdmU6IG51bWJlcikge1xuICBpbmRpY2F0b3JzW2FjdGl2ZV0uY2hlY2tlZCA9IHRydWU7XG4gIGluZGljYXRvcnNbYWN0aXZlXS5zZXRBdHRyaWJ1dGUoJ2RhdGEtc3RhdGUnLCAnYWN0aXZlJyk7XG4gIGxpbmtzW2FjdGl2ZV0uc2V0QXR0cmlidXRlKCdkYXRhLXN0YXRlJywgJ2FjdGl2ZScpO1xuICBzbGlkZXNbYWN0aXZlXS5zZXRBdHRyaWJ1dGUoJ2RhdGEtc3RhdGUnLCAnYWN0aXZlJyk7XG5cbiAgY29uc3QgdmlkZW8gPSBzbGlkZXNbYWN0aXZlXS5xdWVyeVNlbGVjdG9yKCd2aWRlbycpO1xuICBpZiAodmlkZW8pIHtcbiAgICB2aWRlby5jdXJyZW50VGltZSA9IDA7XG4gICAgc2xpZGVzW2FjdGl2ZV0uc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XG4gICAgdmlkZW8ucGxheSgpO1xuICB9IGVsc2Uge1xuICAgIHNsaWRlc1thY3RpdmVdLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xuICB9XG59XG5cbmZ1bmN0aW9uIHNldFNsaWRlKHNsaWRlczogTm9kZUxpc3RPZjxFbGVtZW50PiwgaW5kaWNhdG9yczogTm9kZUxpc3RPZjxFbGVtZW50PiwgbGlua3M6IE5vZGVMaXN0T2Y8YW55PiwgYWN0aXZlOiBudW1iZXIpIHtcbiAgcmV0dXJuIGZ1bmN0aW9uKCkge1xuICAgIC8vIFJlc2V0IGFsbCBzbGlkZXNcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluZGljYXRvcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGluZGljYXRvcnNbaV0uc2V0QXR0cmlidXRlKCdkYXRhLXN0YXRlJywgJycpO1xuICAgICAgc2xpZGVzW2ldLnNldEF0dHJpYnV0ZSgnZGF0YS1zdGF0ZScsICcnKTtcbiAgICAgIGNhcm91c2VsSGlkZShzbGlkZXMsIGluZGljYXRvcnMsIGxpbmtzLCBpKTtcbiAgICB9XG5cbiAgICAvLyBTZXQgZGVmaW5lZCBzbGlkZSBhcyBhY3RpdmVcbiAgICBpbmRpY2F0b3JzW2FjdGl2ZV0uc2V0QXR0cmlidXRlKCdkYXRhLXN0YXRlJywgJ2FjdGl2ZScpO1xuICAgIHNsaWRlc1thY3RpdmVdLnNldEF0dHJpYnV0ZSgnZGF0YS1zdGF0ZScsICdhY3RpdmUnKTtcbiAgICBjYXJvdXNlbFNob3coc2xpZGVzLCBpbmRpY2F0b3JzLCBsaW5rcywgYWN0aXZlKTtcblxuICAgIC8vIFN3aXRjaCBidXR0b24gdGV4dFxuICAgIGNvbnN0IG51bVNsaWRlcyA9IGNhcm91c2VsLnF1ZXJ5U2VsZWN0b3JBbGwoJy5pbmRpY2F0b3InKS5sZW5ndGg7XG4gICAgaWYgKG51bVNsaWRlcyA9PT0gYWN0aXZlICsgMSkge1xuICAgICAgY2Fyb3VzZWwucXVlcnlTZWxlY3RvcignLm5leHQtc2xpZGUnKS50ZXh0Q29udGVudCA9ICdTdGFydCBvdmVyJztcbiAgICB9IGVsc2Uge1xuICAgICAgY2Fyb3VzZWwucXVlcnlTZWxlY3RvcignLm5leHQtc2xpZGUnKS50ZXh0Q29udGVudCA9ICdOZXh0IHN0ZXAnO1xuICAgIH1cbiAgfTtcbn1cblxuaWYgKGNhcm91c2VsKSB7XG4gIGNvbnN0IHNsaWRlcyA9IGNhcm91c2VsLnF1ZXJ5U2VsZWN0b3JBbGwoJy5zbGlkZScpO1xuICBjb25zdCBpbmRpY2F0b3JzID0gY2Fyb3VzZWwucXVlcnlTZWxlY3RvckFsbCgnLmluZGljYXRvcicpO1xuICBjb25zdCBsaW5rcyA9IGNhcm91c2VsLnF1ZXJ5U2VsZWN0b3JBbGwoJy5zbGlkZS1uYXYnKTtcblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6cHJlZmVyLWZvci1vZlxuICBmb3IgKGxldCBpID0gMDsgaSA8IGluZGljYXRvcnMubGVuZ3RoOyBpKyspIHtcbiAgICBpbmRpY2F0b3JzW2ldLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgc2V0U2xpZGUoc2xpZGVzLCBpbmRpY2F0b3JzLCBsaW5rcywgK2luZGljYXRvcnNbaV0uZ2V0QXR0cmlidXRlKCdkYXRhLXNsaWRlJykpKTtcbiAgfVxuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpwcmVmZXItZm9yLW9mXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgbGlua3MubGVuZ3RoOyBpKyspIHtcbiAgICBsaW5rc1tpXS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHNldFNsaWRlKHNsaWRlcywgaW5kaWNhdG9ycywgbGlua3MsICtsaW5rc1tpXS5nZXRBdHRyaWJ1dGUoJ2RhdGEtc2xpZGUnKSkpO1xuICB9XG5cbiAgY2Fyb3VzZWwucXVlcnlTZWxlY3RvcignLm5leHQtc2xpZGUnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcbiAgICBjb25zdCBzbGlkZSA9ICtjYXJvdXNlbC5xdWVyeVNlbGVjdG9yKCcuaW5kaWNhdG9yW2RhdGEtc3RhdGU9YWN0aXZlXScpLmdldEF0dHJpYnV0ZSgnZGF0YS1zbGlkZScpO1xuICAgIGNvbnN0IG51bVNsaWRlcyA9IGNhcm91c2VsLnF1ZXJ5U2VsZWN0b3JBbGwoJy5pbmRpY2F0b3InKS5sZW5ndGg7XG4gICAgc2V0U2xpZGUoc2xpZGVzLCBpbmRpY2F0b3JzLCBsaW5rcywgKHNsaWRlICsgMSkgJSBudW1TbGlkZXMpKCk7XG4gIH0pO1xuXG4gIFtdLmZvckVhY2guY2FsbChzbGlkZXMsIChzbGlkZTogRWxlbWVudCkgPT4ge1xuICAgIGNvbnN0IHZpZGVvID0gc2xpZGUucXVlcnlTZWxlY3RvcigndmlkZW8nKTtcbiAgICBpZiAodmlkZW8pIHtcbiAgICAgIHZpZGVvLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlb3ZlcicsICgpID0+IHtcbiAgICAgICAgKHNsaWRlLnF1ZXJ5U2VsZWN0b3IoJy5leGFtcGxlLXZpcycpIGFzIGFueSkuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJztcbiAgICAgICAgdmlkZW8uc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgdmlkZW8ucGF1c2UoKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG59XG4iXX0=