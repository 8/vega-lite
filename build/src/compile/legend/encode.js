import * as tslib_1 from "tslib";
import { isArray } from 'vega-util';
import { COLOR, OPACITY, SHAPE } from '../../channel';
import { hasConditionalValueDef, isTimeFieldDef, isValueDef, } from '../../fielddef';
import { AREA, BAR, CIRCLE, FILL_STROKE_CONFIG, GEOSHAPE, LINE, POINT, SQUARE, TEXT, TICK } from '../../mark';
import { ScaleType } from '../../scale';
import { keys } from '../../util';
import { applyMarkConfig, timeFormatExpression } from '../common';
import * as mixins from '../mark/mixins';
export function symbols(fieldDef, symbolsSpec, model, channel, type) {
    if (type === 'gradient') {
        return undefined;
    }
    var out = tslib_1.__assign({}, applyMarkConfig({}, model, FILL_STROKE_CONFIG), mixins.color(model));
    switch (model.mark) {
        case BAR:
        case TICK:
        case TEXT:
            out.shape = { value: 'square' };
            break;
        case CIRCLE:
        case SQUARE:
            out.shape = { value: model.mark };
            break;
        case POINT:
        case LINE:
        case GEOSHAPE:
        case AREA:
            // use default circle
            break;
    }
    var markDef = model.markDef, encoding = model.encoding;
    var filled = markDef.filled;
    if (out.fill) {
        // for fill legend, we don't want any fill in symbol
        if (channel === 'fill' || (filled && channel === COLOR)) {
            delete out.fill;
        }
        else {
            if (out.fill['field']) {
                // For others, remove fill field
                delete out.fill;
            }
            else if (isArray(out.fill)) {
                var fill = getFirstConditionValue(encoding.fill || encoding.color) || markDef.fill || (filled && markDef.color);
                if (fill) {
                    out.fill = { value: fill };
                }
            }
        }
    }
    if (out.stroke) {
        if (channel === 'stroke' || (!filled && channel === COLOR)) {
            delete out.stroke;
        }
        else {
            if (out.stroke['field']) {
                // For others, remove stroke field
                delete out.stroke;
            }
            else if (isArray(out.stroke)) {
                var stroke = getFirstConditionValue(encoding.stroke || encoding.color) || markDef.stroke || (!filled && markDef.color);
                if (stroke) {
                    out.stroke = { value: stroke };
                }
            }
        }
    }
    if (out.fill && out.fill['value'] !== 'transparent' && !out.stroke) {
        // for non color channel's legend, we need to override symbol stroke config from Vega config
        out.stroke = { value: 'transparent' };
    }
    if (channel !== SHAPE) {
        var shape = getFirstConditionValue(encoding.shape) || markDef.shape;
        if (shape) {
            out.shape = { value: shape };
        }
    }
    if (channel !== OPACITY) {
        var opacity = getMaxValue(encoding.opacity) || markDef.opacity;
        if (opacity) { // only apply opacity if it is neither zero or undefined
            out.opacity = { value: opacity };
        }
    }
    out = tslib_1.__assign({}, out, symbolsSpec);
    return keys(out).length > 0 ? out : undefined;
}
export function gradient(fieldDef, gradientSpec, model, channel, type) {
    var out = {};
    if (type === 'gradient') {
        var opacity = getMaxValue(model.encoding.opacity) || model.markDef.opacity;
        if (opacity) { // only apply opacity if it is neither zero or undefined
            out.opacity = { value: opacity };
        }
    }
    out = tslib_1.__assign({}, out, gradientSpec);
    return keys(out).length > 0 ? out : undefined;
}
export function labels(fieldDef, labelsSpec, model, channel, type) {
    var legend = model.legend(channel);
    var config = model.config;
    var out = {};
    if (isTimeFieldDef(fieldDef)) {
        var isUTCScale = model.getScaleComponent(channel).get('type') === ScaleType.UTC;
        labelsSpec = tslib_1.__assign({ text: {
                signal: timeFormatExpression('datum.value', fieldDef.timeUnit, legend.format, config.legend.shortTimeLabels, config.timeFormat, isUTCScale)
            } }, labelsSpec);
    }
    out = tslib_1.__assign({}, out, labelsSpec);
    return keys(out).length > 0 ? out : undefined;
}
function getMaxValue(channelDef) {
    return getConditionValue(channelDef, function (v, conditionalDef) { return Math.max(v, conditionalDef.value); });
}
function getFirstConditionValue(channelDef) {
    return getConditionValue(channelDef, function (v, conditionalDef) { return v !== undefined ? v : conditionalDef.value; });
}
function getConditionValue(channelDef, reducer) {
    if (hasConditionalValueDef(channelDef)) {
        return (isArray(channelDef.condition) ? channelDef.condition : [channelDef.condition])
            .reduce(reducer, channelDef.value);
    }
    else if (isValueDef(channelDef)) {
        return channelDef.value;
    }
    return undefined;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW5jb2RlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NvbXBpbGUvbGVnZW5kL2VuY29kZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFDLE9BQU8sRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUVsQyxPQUFPLEVBQVUsS0FBSyxFQUEyQixPQUFPLEVBQUUsS0FBSyxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3RGLE9BQU8sRUFJTCxzQkFBc0IsRUFDdEIsY0FBYyxFQUNkLFVBQVUsR0FJWCxNQUFNLGdCQUFnQixDQUFDO0FBQ3hCLE9BQU8sRUFBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxrQkFBa0IsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBQyxNQUFNLFlBQVksQ0FBQztBQUM1RyxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0sYUFBYSxDQUFDO0FBQ3RDLE9BQU8sRUFBQyxJQUFJLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFFaEMsT0FBTyxFQUFDLGVBQWUsRUFBRSxvQkFBb0IsRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUNoRSxPQUFPLEtBQUssTUFBTSxNQUFNLGdCQUFnQixDQUFDO0FBR3pDLE1BQU0sa0JBQWtCLFFBQTBCLEVBQUUsV0FBZ0IsRUFBRSxLQUFnQixFQUFFLE9BQWdCLEVBQUUsSUFBZ0I7SUFDeEgsSUFBSSxJQUFJLEtBQUssVUFBVSxFQUFFO1FBQ3ZCLE9BQU8sU0FBUyxDQUFDO0tBQ2xCO0lBRUQsSUFBSSxHQUFHLHdCQUNGLGVBQWUsQ0FBQyxFQUFFLEVBQUUsS0FBSyxFQUFFLGtCQUFrQixDQUFDLEVBQzlDLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQ3ZCLENBQUM7SUFFRixRQUFRLEtBQUssQ0FBQyxJQUFJLEVBQUU7UUFDbEIsS0FBSyxHQUFHLENBQUM7UUFDVCxLQUFLLElB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QUFDLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQTFDLENBQTBDLENBQzFFLENBQUM7QUFDSixDQUFDO0FBRUQsMkJBQ0UsVUFBNkcsRUFDN0csT0FBNkQ7SUFHN0QsSUFBSSxzQkFBc0IsQ0FBQyxVQUFVLENBQUMsRUFBRTtRQUN0QyxPQUFPLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDbkYsTUFBTSxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsS0FBWSxDQUFDLENBQUM7S0FDN0M7U0FBTSxJQUFJLFVBQVUsQ0FBQyxVQUFVLENBQUMsRUFBRTtRQUNqQyxPQUFPLFVBQVUsQ0FBQyxLQUFZLENBQUM7S0FDaEM7SUFDRCxPQUFPLFNBQVMsQ0FBQztBQUNuQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtpc0FycmF5fSBmcm9tICd2ZWdhLXV0aWwnO1xuXG5pbXBvcnQge0NoYW5uZWwsIENPTE9SLCBOb25Qb3NpdGlvblNjYWxlQ2hhbm5lbCwgT1BBQ0lUWSwgU0hBUEV9IGZyb20gJy4uLy4uL2NoYW5uZWwnO1xuaW1wb3J0IHtcbiAgQ29uZGl0aW9uYWwsXG4gIEZpZWxkRGVmLFxuICBGaWVsZERlZldpdGhDb25kaXRpb24sXG4gIGhhc0NvbmRpdGlvbmFsVmFsdWVEZWYsXG4gIGlzVGltZUZpZWxkRGVmLFxuICBpc1ZhbHVlRGVmLFxuICBNYXJrUHJvcEZpZWxkRGVmLFxuICBWYWx1ZURlZixcbiAgVmFsdWVEZWZXaXRoQ29uZGl0aW9uLFxufSBmcm9tICcuLi8uLi9maWVsZGRlZic7XG5pbXBvcnQge0FSRUEsIEJBUiwgQ0lSQ0xFLCBGSUxMX1NUUk9LRV9DT05GSUcsIEdFT1NIQVBFLCBMSU5FLCBQT0lOVCwgU1FVQVJFLCBURVhULCBUSUNLfSBmcm9tICcuLi8uLi9tYXJrJztcbmltcG9ydCB7U2NhbGVUeXBlfSBmcm9tICcuLi8uLi9zY2FsZSc7XG5pbXBvcnQge2tleXN9IGZyb20gJy4uLy4uL3V0aWwnO1xuaW1wb3J0IHtMZWdlbmRUeXBlLCBWZ0VuY29kZUVudHJ5fSBmcm9tICcuLi8uLi92ZWdhLnNjaGVtYSc7XG5pbXBvcnQge2FwcGx5TWFya0NvbmZpZywgdGltZUZvcm1hdEV4cHJlc3Npb259IGZyb20gJy4uL2NvbW1vbic7XG5pbXBvcnQgKiBhcyBtaXhpbnMgZnJvbSAnLi4vbWFyay9taXhpbnMnO1xuaW1wb3J0IHtVbml0TW9kZWx9IGZyb20gJy4uL3VuaXQnO1xuXG5leHBvcnQgZnVuY3Rpb24gc3ltYm9scyhmaWVsZERlZjogRmllbGREZWY8c3RyaW5nPiwgc3ltYm9sc1NwZWM6IGFueSwgbW9kZWw6IFVuaXRNb2RlbCwgY2hhbm5lbDogQ2hhbm5lbCwgdHlwZTogTGVnZW5kVHlwZSk6IFZnRW5jb2RlRW50cnkge1xuICBpZiAodHlwZSA9PT0gJ2dyYWRpZW50Jykge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBsZXQgb3V0ID0ge1xuICAgIC4uLmFwcGx5TWFya0NvbmZpZyh7fSwgbW9kZWwsIEZJTExfU1RST0tFX0NPTkZJRyksXG4gICAgLi4ubWl4aW5zLmNvbG9yKG1vZGVsKVxuICB9O1xuXG4gIHN3aXRjaCAobW9kZWwubWFyaykge1xuICAgIGNhc2UgQkFSOlxuICAgIGNhc2UgVElDSzpcbiAgICBjYXNlIFRFWFQ6XG4gICAgICBvdXQuc2hhcGUgPSB7dmFsdWU6ICdzcXVhcmUnfTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgQ0lSQ0xFOlxuICAgIGNhc2UgU1FVQVJFOlxuICAgICAgb3V0LnNoYXBlID0ge3ZhbHVlOiBtb2RlbC5tYXJrfTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgUE9JTlQ6XG4gICAgY2FzZSBMSU5FOlxuICAgIGNhc2UgR0VPU0hBUEU6XG4gICAgY2FzZSBBUkVBOlxuICAgICAgLy8gdXNlIGRlZmF1bHQgY2lyY2xlXG4gICAgICBicmVhaztcbiAgfVxuXG4gIGNvbnN0IHttYXJrRGVmLCBlbmNvZGluZ30gPSBtb2RlbDtcbiAgY29uc3QgZmlsbGVkID0gbWFya0RlZi5maWxsZWQ7XG5cbiAgaWYgKG91dC5maWxsKSB7XG4gICAgLy8gZm9yIGZpbGwgbGVnZW5kLCB3ZSBkb24ndCB3YW50IGFueSBmaWxsIGluIHN5bWJvbFxuICAgIGlmIChjaGFubmVsID09PSAnZmlsbCcgfHwgKGZpbGxlZCAmJiBjaGFubmVsID09PSBDT0xPUikpIHtcbiAgICAgIGRlbGV0ZSBvdXQuZmlsbDtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKG91dC5maWxsWydmaWVsZCddKSB7XG4gICAgICAgIC8vIEZvciBvdGhlcnMsIHJlbW92ZSBmaWxsIGZpZWxkXG4gICAgICAgIGRlbGV0ZSBvdXQuZmlsbDtcbiAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShvdXQuZmlsbCkpIHtcbiAgICAgICAgY29uc3QgZmlsbCA9IGdldEZpcnN0Q29uZGl0aW9uVmFsdWUoZW5jb2RpbmcuZmlsbCB8fCBlbmNvZGluZy5jb2xvcikgfHwgbWFya0RlZi5maWxsIHx8IChmaWxsZWQgJiYgbWFya0RlZi5jb2xvcik7XG4gICAgICAgIGlmIChmaWxsKSB7XG4gICAgICAgICAgb3V0LmZpbGwgPSB7dmFsdWU6IGZpbGx9O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKG91dC5zdHJva2UpIHtcbiAgICBpZiAoY2hhbm5lbCA9PT0gJ3N0cm9rZScgfHwgKCFmaWxsZWQgJiYgY2hhbm5lbCA9PT0gQ09MT1IpKSB7XG4gICAgICBkZWxldGUgb3V0LnN0cm9rZTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKG91dC5zdHJva2VbJ2ZpZWxkJ10pIHtcbiAgICAgICAgLy8gRm9yIG90aGVycywgcmVtb3ZlIHN0cm9rZSBmaWVsZFxuICAgICAgICBkZWxldGUgb3V0LnN0cm9rZTtcbiAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShvdXQuc3Ryb2tlKSkge1xuICAgICAgICBjb25zdCBzdHJva2UgPSBnZXRGaXJzdENvbmRpdGlvblZhbHVlKGVuY29kaW5nLnN0cm9rZSB8fCBlbmNvZGluZy5jb2xvcikgfHwgbWFya0RlZi5zdHJva2UgfHwgKCFmaWxsZWQgJiYgbWFya0RlZi5jb2xvcik7XG4gICAgICAgIGlmIChzdHJva2UpIHtcbiAgICAgICAgICBvdXQuc3Ryb2tlID0ge3ZhbHVlOiBzdHJva2V9O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKG91dC5maWxsICYmIG91dC5maWxsWyd2YWx1ZSddICE9PSAndHJhbnNwYXJlbnQnICYmICFvdXQuc3Ryb2tlKSB7XG4gICAgLy8gZm9yIG5vbiBjb2xvciBjaGFubmVsJ3MgbGVnZW5kLCB3ZSBuZWVkIHRvIG92ZXJyaWRlIHN5bWJvbCBzdHJva2UgY29uZmlnIGZyb20gVmVnYSBjb25maWdcbiAgICBvdXQuc3Ryb2tlID0ge3ZhbHVlOiAndHJhbnNwYXJlbnQnfTtcbiAgfVxuXG4gIGlmIChjaGFubmVsICE9PSBTSEFQRSkge1xuICAgIGNvbnN0IHNoYXBlID0gZ2V0Rmlyc3RDb25kaXRpb25WYWx1ZShlbmNvZGluZy5zaGFwZSkgfHwgbWFya0RlZi5zaGFwZTtcbiAgICBpZiAoc2hhcGUpIHtcbiAgICAgIG91dC5zaGFwZSA9IHt2YWx1ZTogc2hhcGV9O1xuICAgIH1cbiAgfVxuXG4gIGlmIChjaGFubmVsICE9PSBPUEFDSVRZKSB7XG4gICAgY29uc3Qgb3BhY2l0eSA9IGdldE1heFZhbHVlKGVuY29kaW5nLm9wYWNpdHkpIHx8IG1hcmtEZWYub3BhY2l0eTtcbiAgICBpZiAob3BhY2l0eSkgeyAvLyBvbmx5IGFwcGx5IG9wYWNpdHkgaWYgaXQgaXMgbmVpdGhlciB6ZXJvIG9yIHVuZGVmaW5lZFxuICAgICAgb3V0Lm9wYWNpdHkgPSB7dmFsdWU6IG9wYWNpdHl9O1xuICAgIH1cbiAgfVxuXG4gIG91dCA9IHsuLi5vdXQsIC4uLnN5bWJvbHNTcGVjfTtcblxuICByZXR1cm4ga2V5cyhvdXQpLmxlbmd0aCA+IDAgPyBvdXQgOiB1bmRlZmluZWQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBncmFkaWVudChmaWVsZERlZjogRmllbGREZWY8c3RyaW5nPiwgZ3JhZGllbnRTcGVjOiBhbnksIG1vZGVsOiBVbml0TW9kZWwsIGNoYW5uZWw6IENoYW5uZWwsIHR5cGU6IExlZ2VuZFR5cGUpIHtcbiAgbGV0IG91dDogYW55ID0ge307XG5cbiAgaWYgKHR5cGUgPT09ICdncmFkaWVudCcpIHtcbiAgICBjb25zdCBvcGFjaXR5ID0gZ2V0TWF4VmFsdWUobW9kZWwuZW5jb2Rpbmcub3BhY2l0eSkgfHwgbW9kZWwubWFya0RlZi5vcGFjaXR5O1xuICAgIGlmIChvcGFjaXR5KSB7IC8vIG9ubHkgYXBwbHkgb3BhY2l0eSBpZiBpdCBpcyBuZWl0aGVyIHplcm8gb3IgdW5kZWZpbmVkXG4gICAgICBvdXQub3BhY2l0eSA9IHt2YWx1ZTogb3BhY2l0eX07XG4gICAgfVxuICB9XG5cbiAgb3V0ID0gey4uLm91dCwgLi4uZ3JhZGllbnRTcGVjfTtcbiAgcmV0dXJuIGtleXMob3V0KS5sZW5ndGggPiAwID8gb3V0IDogdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbGFiZWxzKGZpZWxkRGVmOiBGaWVsZERlZjxzdHJpbmc+LCBsYWJlbHNTcGVjOiBhbnksIG1vZGVsOiBVbml0TW9kZWwsIGNoYW5uZWw6IE5vblBvc2l0aW9uU2NhbGVDaGFubmVsLCB0eXBlOiBMZWdlbmRUeXBlKSB7XG4gIGNvbnN0IGxlZ2VuZCA9IG1vZGVsLmxlZ2VuZChjaGFubmVsKTtcbiAgY29uc3QgY29uZmlnID0gbW9kZWwuY29uZmlnO1xuXG4gIGxldCBvdXQ6IGFueSA9IHt9O1xuXG4gIGlmIChpc1RpbWVGaWVsZERlZihmaWVsZERlZikpIHtcbiAgICBjb25zdCBpc1VUQ1NjYWxlID0gbW9kZWwuZ2V0U2NhbGVDb21wb25lbnQoY2hhbm5lbCkuZ2V0KCd0eXBlJykgPT09IFNjYWxlVHlwZS5VVEM7XG4gICAgbGFiZWxzU3BlYyA9IHtcbiAgICAgIHRleHQ6IHtcbiAgICAgICAgc2lnbmFsOiB0aW1lRm9ybWF0RXhwcmVzc2lvbignZGF0dW0udmFsdWUnLCBmaWVsZERlZi50aW1lVW5pdCwgbGVnZW5kLmZvcm1hdCwgY29uZmlnLmxlZ2VuZC5zaG9ydFRpbWVMYWJlbHMsIGNvbmZpZy50aW1lRm9ybWF0LCBpc1VUQ1NjYWxlKVxuICAgICAgfSxcbiAgICAgIC4uLmxhYmVsc1NwZWMsXG4gICAgfTtcbiAgfVxuXG4gIG91dCA9IHsuLi5vdXQsIC4uLmxhYmVsc1NwZWN9O1xuXG4gIHJldHVybiBrZXlzKG91dCkubGVuZ3RoID4gMCA/IG91dCA6IHVuZGVmaW5lZDtcbn1cblxuZnVuY3Rpb24gZ2V0TWF4VmFsdWUoY2hhbm5lbERlZjogRmllbGREZWZXaXRoQ29uZGl0aW9uPE1hcmtQcm9wRmllbGREZWY8c3RyaW5nPj4gfCBWYWx1ZURlZldpdGhDb25kaXRpb248TWFya1Byb3BGaWVsZERlZjxzdHJpbmc+Pikge1xuICByZXR1cm4gZ2V0Q29uZGl0aW9uVmFsdWUoY2hhbm5lbERlZixcbiAgICAodjogbnVtYmVyLCBjb25kaXRpb25hbERlZikgPT4gTWF0aC5tYXgodiwgY29uZGl0aW9uYWxEZWYudmFsdWUgYXMgYW55KVxuICApO1xufVxuXG5mdW5jdGlvbiBnZXRGaXJzdENvbmRpdGlvblZhbHVlKGNoYW5uZWxEZWY6IEZpZWxkRGVmV2l0aENvbmRpdGlvbjxNYXJrUHJvcEZpZWxkRGVmPHN0cmluZz4+IHwgVmFsdWVEZWZXaXRoQ29uZGl0aW9uPE1hcmtQcm9wRmllbGREZWY8c3RyaW5nPj4pIHtcbiAgcmV0dXJuIGdldENvbmRpdGlvblZhbHVlKGNoYW5uZWxEZWYsXG4gICAgKHY6IG51bWJlciwgY29uZGl0aW9uYWxEZWYpID0+IHYgIT09IHVuZGVmaW5lZCA/IHYgOiBjb25kaXRpb25hbERlZi52YWx1ZVxuICApO1xufVxuXG5mdW5jdGlvbiBnZXRDb25kaXRpb25WYWx1ZTxUPihcbiAgY2hhbm5lbERlZjogRmllbGREZWZXaXRoQ29uZGl0aW9uPE1hcmtQcm9wRmllbGREZWY8c3RyaW5nPj4gfCBWYWx1ZURlZldpdGhDb25kaXRpb248TWFya1Byb3BGaWVsZERlZjxzdHJpbmc+PixcbiAgcmVkdWNlcjogKHZhbDogVCwgY29uZGl0aW9uYWxEZWY6IENvbmRpdGlvbmFsPFZhbHVlRGVmPikgPT4gVFxuKTogVCB7XG5cbiAgaWYgKGhhc0NvbmRpdGlvbmFsVmFsdWVEZWYoY2hhbm5lbERlZikpIHtcbiAgICByZXR1cm4gKGlzQXJyYXkoY2hhbm5lbERlZi5jb25kaXRpb24pID8gY2hhbm5lbERlZi5jb25kaXRpb24gOiBbY2hhbm5lbERlZi5jb25kaXRpb25dKVxuICAgICAgLnJlZHVjZShyZWR1Y2VyLCBjaGFubmVsRGVmLnZhbHVlIGFzIGFueSk7XG4gIH0gZWxzZSBpZiAoaXNWYWx1ZURlZihjaGFubmVsRGVmKSkge1xuICAgIHJldHVybiBjaGFubmVsRGVmLnZhbHVlIGFzIGFueTtcbiAgfVxuICByZXR1cm4gdW5kZWZpbmVkO1xufVxuIl19