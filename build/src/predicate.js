import * as tslib_1 from "tslib";
import { isArray, isString } from 'vega-util';
import { selectionPredicate } from './compile/selection/selection';
import { dateTimeExpr, isDateTime } from './datetime';
import { vgField } from './fielddef';
import { fieldExpr as timeUnitFieldExpr, getLocalTimeUnit, isLocalSingleTimeUnit, isUtcSingleTimeUnit, normalizeTimeUnit } from './timeunit';
import { logicalExpr } from './util';
export function isSelectionPredicate(predicate) {
    return predicate && predicate['selection'];
}
export function isFieldEqualPredicate(predicate) {
    return predicate && !!predicate.field && predicate.equal !== undefined;
}
export function isFieldRangePredicate(predicate) {
    if (predicate && predicate.field) {
        if (isArray(predicate.range) && predicate.range.length === 2) {
            return true;
        }
    }
    return false;
}
export function isFieldOneOfPredicate(predicate) {
    return predicate && !!predicate.field && (isArray(predicate.oneOf) ||
        isArray(predicate.in) // backward compatibility
    );
}
export function isFieldPredicate(predicate) {
    return isFieldOneOfPredicate(predicate) || isFieldEqualPredicate(predicate) || isFieldRangePredicate(predicate);
}
/**
 * Converts a predicate into an expression.
 */
// model is only used for selection filters.
export function expression(model, filterOp, node) {
    return logicalExpr(filterOp, function (predicate) {
        if (isString(predicate)) {
            return predicate;
        }
        else if (isSelectionPredicate(predicate)) {
            return selectionPredicate(model, predicate.selection, node);
        }
        else { // Filter Object
            return fieldFilterExpression(predicate);
        }
    });
}
// This method is used by Voyager.  Do not change its behavior without changing Voyager.
export function fieldFilterExpression(predicate, useInRange) {
    if (useInRange === void 0) { useInRange = true; }
    var fieldExpr = predicate.timeUnit ?
        // For timeUnit, cast into integer with time() so we can use ===, inrange, indexOf to compare values directly.
        // TODO: We calculate timeUnit on the fly here. Consider if we would like to consolidate this with timeUnit pipeline
        // TODO: support utc
        ('time(' + timeUnitFieldExpr(predicate.timeUnit, predicate.field) + ')') :
        vgField(predicate, { expr: 'datum' });
    if (isFieldEqualPredicate(predicate)) {
        return fieldExpr + '===' + valueExpr(predicate.equal, predicate.timeUnit);
    }
    else if (isFieldOneOfPredicate(predicate)) {
        // "oneOf" was formerly "in" -- so we need to add backward compatibility
        var oneOf = predicate.oneOf || predicate['in'];
        return 'indexof([' +
            oneOf.map(function (v) { return valueExpr(v, predicate.timeUnit); }).join(',') +
            '], ' + fieldExpr + ') !== -1';
    }
    else if (isFieldRangePredicate(predicate)) {
        var lower = predicate.range[0];
        var upper = predicate.range[1];
        if (lower !== null && upper !== null && useInRange) {
            return 'inrange(' + fieldExpr + ', [' +
                valueExpr(lower, predicate.timeUnit) + ', ' +
                valueExpr(upper, predicate.timeUnit) + '])';
        }
        var exprs = [];
        if (lower !== null) {
            exprs.push(fieldExpr + " >= " + valueExpr(lower, predicate.timeUnit));
        }
        if (upper !== null) {
            exprs.push(fieldExpr + " <= " + valueExpr(upper, predicate.timeUnit));
        }
        return exprs.length > 0 ? exprs.join(' && ') : 'true';
    }
    /* istanbul ignore next: it should never reach here */
    throw new Error("Invalid field predicate: " + JSON.stringify(predicate));
}
function valueExpr(v, timeUnit) {
    if (isDateTime(v)) {
        var expr = dateTimeExpr(v, true);
        return 'time(' + expr + ')';
    }
    if (isLocalSingleTimeUnit(timeUnit)) {
        var datetime = {};
        datetime[timeUnit] = v;
        var expr = dateTimeExpr(datetime, true);
        return 'time(' + expr + ')';
    }
    else if (isUtcSingleTimeUnit(timeUnit)) {
        return valueExpr(v, getLocalTimeUnit(timeUnit));
    }
    return JSON.stringify(v);
}
export function normalizePredicate(f) {
    if (isFieldPredicate(f) && f.timeUnit) {
        return tslib_1.__assign({}, f, { timeUnit: normalizeTimeUnit(f.timeUnit) });
    }
    return f;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlZGljYXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3ByZWRpY2F0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFDLE9BQU8sRUFBRSxRQUFRLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFHNUMsT0FBTyxFQUFDLGtCQUFrQixFQUFDLE1BQU0sK0JBQStCLENBQUM7QUFDakUsT0FBTyxFQUFXLFlBQVksRUFBRSxVQUFVLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFDOUQsT0FBTyxFQUFDLE9BQU8sRUFBQyxNQUFNLFlBQVksQ0FBQztBQUVuQyxPQUFPLEVBQUMsU0FBUyxJQUFJLGlCQUFpQixFQUFFLGdCQUFnQixFQUFFLHFCQUFxQixFQUFFLG1CQUFtQixFQUFFLGlCQUFpQixFQUFXLE1BQU0sWUFBWSxDQUFDO0FBQ3JKLE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSxRQUFRLENBQUM7QUFzQm5DLE1BQU0sK0JBQStCLFNBQW9DO0lBQ3ZFLE9BQU8sU0FBUyxJQUFJLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUM3QyxDQUFDO0FBc0JELE1BQU0sZ0NBQWdDLFNBQWM7SUFDbEQsT0FBTyxTQUFTLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLElBQUksU0FBUyxDQUFDLEtBQUssS0FBSyxTQUFTLENBQUM7QUFDekUsQ0FBQztBQXlCRCxNQUFNLGdDQUFnQyxTQUFjO0lBQ2xELElBQUksU0FBUyxJQUFJLFNBQVMsQ0FBQyxLQUFLLEVBQUU7UUFDaEMsSUFBSSxPQUFPLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxJQUFJLFNBQVMsQ0FBQyxLQUFLLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUM1RCxPQUFPLElBQUksQ0FBQztTQUNiO0tBQ0Y7SUFDRCxPQUFPLEtBQUssQ0FBQztBQUNmLENBQUM7QUF1QkQsTUFBTSxnQ0FBZ0MsU0FBYztJQUNsRCxPQUFPLFNBQVMsSUFBSSxDQUFDLENB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LENBQUM7S0FDakQ7SUFDRCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDM0IsQ0FBQztBQUVELE1BQU0sNkJBQTZCLENBQVk7SUFDN0MsSUFBSSxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFO1FBQ3JDLDRCQUNLLENBQUMsSUFDSixRQUFRLEVBQUUsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUN2QztLQUNIO0lBQ0QsT0FBTyxDQUFDLENBQUM7QUFDWCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtpc0FycmF5LCBpc1N0cmluZ30gZnJvbSAndmVnYS11dGlsJztcbmltcG9ydCB7RGF0YUZsb3dOb2RlfSBmcm9tICcuL2NvbXBpbGUvZGF0YS9kYXRhZmxvdyc7XG5pbXBvcnQge01vZGVsfSBmcm9tICcuL2NvbXBpbGUvbW9kZWwnO1xuaW1wb3J0IHtzZWxlY3Rpb25QcmVkaWNhdGV9IGZyb20gJy4vY29tcGlsZS9zZWxlY3Rpb24vc2VsZWN0aW9uJztcbmltcG9ydCB7RGF0ZVRpbWUsIGRhdGVUaW1lRXhwciwgaXNEYXRlVGltZX0gZnJvbSAnLi9kYXRldGltZSc7XG5pbXBvcnQge3ZnRmllbGR9IGZyb20gJy4vZmllbGRkZWYnO1xuaW1wb3J0IHtMb2dpY2FsT3BlcmFuZH0gZnJvbSAnLi9sb2dpY2FsJztcbmltcG9ydCB7ZmllbGRFeHByIGFzIHRpbWVVbml0RmllbGRFeHByLCBnZXRMb2NhbFRpbWVVbml0LCBpc0xvY2FsU2luZ2xlVGltZVVuaXQsIGlzVXRjU2luZ2xlVGltZVVuaXQsIG5vcm1hbGl6ZVRpbWVVbml0LCBUaW1lVW5pdH0gZnJvbSAnLi90aW1ldW5pdCc7XG5pbXBvcnQge2xvZ2ljYWxFeHByfSBmcm9tICcuL3V0aWwnO1xuXG5leHBvcnQgdHlwZSBQcmVkaWNhdGUgPVxuICAvLyBhKSBGaWVsZFByZWNpZGF0ZSAoYnV0IHdlIGRvbid0IHR5cGUgRmllbGRGaWx0ZXIgaGVyZSBzbyB0aGUgc2NoZW1hIGhhcyBubyBuZXN0aW5nXG4gIC8vIGFuZCB0aHVzIHRoZSBkb2N1bWVudGF0aW9uIHNob3dzIGFsbCBvZiB0aGUgdHlwZXMgY2xlYXJseSlcbiAgRmllbGRFcXVhbFByZWRpY2F0ZSB8IEZpZWxkUmFuZ2VQcmVkaWNhdGUgfCBGaWVsZE9uZU9mUHJlZGljYXRlIHxcbiAgLy8gYikgU2VsZWN0aW9uIFByZWRpY2F0ZVxuICBTZWxlY3Rpb25QcmVkaWNhdGUgfFxuICAvLyBjKSBWZWdhIEV4cHJlc3Npb24gc3RyaW5nXG4gIHN0cmluZztcblxuXG5cbmV4cG9ydCB0eXBlIEZpZWxkUHJlZGljYXRlID0gRmllbGRFcXVhbFByZWRpY2F0ZSB8IEZpZWxkUmFuZ2VQcmVkaWNhdGUgfCBGaWVsZE9uZU9mUHJlZGljYXRlO1xuXG5leHBvcnQgaW50ZXJmYWNlIFNlbGVjdGlvblByZWRpY2F0ZSB7XG4gIC8qKlxuICAgKiBGaWx0ZXIgdXNpbmcgYSBzZWxlY3Rpb24gbmFtZS5cbiAgICovXG4gIHNlbGVjdGlvbjogTG9naWNhbE9wZXJhbmQ8c3RyaW5nPjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzU2VsZWN0aW9uUHJlZGljYXRlKHByZWRpY2F0ZTogTG9naWNhbE9wZXJhbmQ8UHJlZGljYXRlPik6IHByZWRpY2F0ZSBpcyBTZWxlY3Rpb25QcmVkaWNhdGUge1xuICByZXR1cm4gcHJlZGljYXRlICYmIHByZWRpY2F0ZVsnc2VsZWN0aW9uJ107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRmllbGRFcXVhbFByZWRpY2F0ZSB7XG4gIC8vIFRPRE86IHN1cHBvcnQgYWdncmVnYXRlXG5cbiAgLyoqXG4gICAqIFRpbWUgdW5pdCBmb3IgdGhlIGZpZWxkIHRvIGJlIGZpbHRlcmVkLlxuICAgKi9cbiAgdGltZVVuaXQ/OiBUaW1lVW5pdDtcblxuICAvKipcbiAgICogRmllbGQgdG8gYmUgZmlsdGVyZWQuXG4gICAqL1xuICBmaWVsZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgdmFsdWUgdGhhdCB0aGUgZmllbGQgc2hvdWxkIGJlIGVxdWFsIHRvLlxuICAgKi9cbiAgZXF1YWw6IHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4gfCBEYXRlVGltZTtcblxufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNGaWVsZEVxdWFsUHJlZGljYXRlKHByZWRpY2F0ZTogYW55KTogcHJlZGljYXRlIGlzIEZpZWxkRXF1YWxQcmVkaWNhdGUge1xuICByZXR1cm4gcHJlZGljYXRlICYmICEhcHJlZGljYXRlLmZpZWxkICYmIHByZWRpY2F0ZS5lcXVhbCAhPT0gdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEZpZWxkUmFuZ2VQcmVkaWNhdGUge1xuICAvLyBUT0RPOiBzdXBwb3J0IGFnZ3JlZ2F0ZVxuXG4gIC8qKlxuICAgKiB0aW1lIHVuaXQgZm9yIHRoZSBmaWVsZCB0byBiZSBmaWx0ZXJlZC5cbiAgICovXG4gIHRpbWVVbml0PzogVGltZVVuaXQ7XG5cbiAgLyoqXG4gICAqIEZpZWxkIHRvIGJlIGZpbHRlcmVkXG4gICAqL1xuICBmaWVsZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBBbiBhcnJheSBvZiBpbmNsdXNpdmUgbWluaW11bSBhbmQgbWF4aW11bSB2YWx1ZXNcbiAgICogZm9yIGEgZmllbGQgdmFsdWUgb2YgYSBkYXRhIGl0ZW0gdG8gYmUgaW5jbHVkZWQgaW4gdGhlIGZpbHRlcmVkIGRhdGEuXG4gICAqIEBtYXhJdGVtcyAyXG4gICAqIEBtaW5JdGVtcyAyXG4gICAqL1xuICByYW5nZTogKG51bWJlcnxEYXRlVGltZXxudWxsKVtdO1xuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0ZpZWxkUmFuZ2VQcmVkaWNhdGUocHJlZGljYXRlOiBhbnkpOiBwcmVkaWNhdGUgaXMgRmllbGRSYW5nZVByZWRpY2F0ZSB7XG4gIGlmIChwcmVkaWNhdGUgJiYgcHJlZGljYXRlLmZpZWxkKSB7XG4gICAgaWYgKGlzQXJyYXkocHJlZGljYXRlLnJhbmdlKSAmJiBwcmVkaWNhdGUucmFuZ2UubGVuZ3RoID09PSAyKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEZpZWxkT25lT2ZQcmVkaWNhdGUge1xuICAvLyBUT0RPOiBzdXBwb3J0IGFnZ3JlZ2F0ZVxuXG4gIC8qKlxuICAgKiB0aW1lIHVuaXQgZm9yIHRoZSBmaWVsZCB0byBiZSBmaWx0ZXJlZC5cbiAgICovXG4gIHRpbWVVbml0PzogVGltZVVuaXQ7XG5cbiAgLyoqXG4gICAqIEZpZWxkIHRvIGJlIGZpbHRlcmVkXG4gICAqL1xuICBmaWVsZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBBIHNldCBvZiB2YWx1ZXMgdGhhdCB0aGUgYGZpZWxkYCdzIHZhbHVlIHNob3VsZCBiZSBhIG1lbWJlciBvZixcbiAgICogZm9yIGEgZGF0YSBpdGVtIGluY2x1ZGVkIGluIHRoZSBmaWx0ZXJlZCBkYXRhLlxuICAgKi9cbiAgb25lT2Y6IHN0cmluZ1tdIHwgbnVtYmVyW10gfCBib29sZWFuW10gfCBEYXRlVGltZVtdO1xuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0ZpZWxkT25lT2ZQcmVkaWNhdGUocHJlZGljYXRlOiBhbnkpOiBwcmVkaWNhdGUgaXMgRmllbGRPbmVPZlByZWRpY2F0ZSB7XG4gIHJldHVybiBwcmVkaWNhdGUgJiYgISFwcmVkaWNhdGUuZmllbGQgJiYgKFxuICAgIGlzQXJyYXkocHJlZGljYXRlLm9uZU9mKSB8fFxuICAgIGlzQXJyYXkocHJlZGljYXRlLmluKSAvLyBiYWNrd2FyZCBjb21wYXRpYmlsaXR5XG4gICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0ZpZWxkUHJlZGljYXRlKHByZWRpY2F0ZTogUHJlZGljYXRlKTogcHJlZGljYXRlIGlzIEZpZWxkT25lT2ZQcmVkaWNhdGUgfCBGaWVsZEVxdWFsUHJlZGljYXRlIHwgRmllbGRSYW5nZVByZWRpY2F0ZSB7XG4gIHJldHVybiBpc0ZpZWxkT25lT2ZQcmVkaWNhdGUocHJlZGljYXRlKSB8fCBpc0ZpZWxkRXF1YWxQcmVkaWNhdGUocHJlZGljYXRlKSB8fCBpc0ZpZWxkUmFuZ2VQcmVkaWNhdGUocHJlZGljYXRlKTtcbn1cblxuLyoqXG4gKiBDb252ZXJ0cyBhIHByZWRpY2F0ZSBpbnRvIGFuIGV4cHJlc3Npb24uXG4gKi9cbi8vIG1vZGVsIGlzIG9ubHkgdXNlZCBmb3Igc2VsZWN0aW9uIGZpbHRlcnMuXG5leHBvcnQgZnVuY3Rpb24gZXhwcmVzc2lvbihtb2RlbDogTW9kZWwsIGZpbHRlck9wOiBMb2dpY2FsT3BlcmFuZDxQcmVkaWNhdGU+LCBub2RlPzogRGF0YUZsb3dOb2RlKTogc3RyaW5nIHtcbiAgcmV0dXJuIGxvZ2ljYWxFeHByKGZpbHRlck9wLCAocHJlZGljYXRlOiBQcmVkaWNhdGUpID0+IHtcbiAgICBpZiAoaXNTdHJpbmcocHJlZGljYXRlKSkge1xuICAgICAgcmV0dXJuIHByZWRpY2F0ZTtcbiAgICB9IGVsc2UgaWYgKGlzU2VsZWN0aW9uUHJlZGljYXRlKHByZWRpY2F0ZSkpIHtcbiAgICAgIHJldHVybiBzZWxlY3Rpb25QcmVkaWNhdGUobW9kZWwsIHByZWRpY2F0ZS5zZWxlY3Rpb24sIG5vZGUpO1xuICAgIH0gZWxzZSB7IC8vIEZpbHRlciBPYmplY3RcbiAgICAgIHJldHVybiBmaWVsZEZpbHRlckV4cHJlc3Npb24ocHJlZGljYXRlKTtcbiAgICB9XG4gIH0pO1xufVxuXG4vLyBUaGlzIG1ldGhvZCBpcyB1c2VkIGJ5IFZveWFnZXIuICBEbyBub3QgY2hhbmdlIGl0cyBiZWhhdmlvciB3aXRob3V0IGNoYW5naW5nIFZveWFnZXIuXG5leHBvcnQgZnVuY3Rpb24gZmllbGRGaWx0ZXJFeHByZXNzaW9uKHByZWRpY2F0ZTogRmllbGRQcmVkaWNhdGUsIHVzZUluUmFuZ2U9dHJ1ZSkge1xuICBjb25zdCBmaWVsZEV4cHIgPSBwcmVkaWNhdGUudGltZVVuaXQgP1xuICAgIC8vIEZvciB0aW1lVW5pdCwgY2FzdCBpbnRvIGludGVnZXIgd2l0aCB0aW1lKCkgc28gd2UgY2FuIHVzZSA9PT0sIGlucmFuZ2UsIGluZGV4T2YgdG8gY29tcGFyZSB2YWx1ZXMgZGlyZWN0bHkuXG4gICAgICAvLyBUT0RPOiBXZSBjYWxjdWxhdGUgdGltZVVuaXQgb24gdGhlIGZseSBoZXJlLiBDb25zaWRlciBpZiB3ZSB3b3VsZCBsaWtlIHRvIGNvbnNvbGlkYXRlIHRoaXMgd2l0aCB0aW1lVW5pdCBwaXBlbGluZVxuICAgICAgLy8gVE9ETzogc3VwcG9ydCB1dGNcbiAgICAoJ3RpbWUoJyArIHRpbWVVbml0RmllbGRFeHByKHByZWRpY2F0ZS50aW1lVW5pdCwgcHJlZGljYXRlLmZpZWxkKSArICcpJykgOlxuICAgIHZnRmllbGQocHJlZGljYXRlLCB7ZXhwcjogJ2RhdHVtJ30pO1xuXG4gIGlmIChpc0ZpZWxkRXF1YWxQcmVkaWNhdGUocHJlZGljYXRlKSkge1xuICAgIHJldHVybiBmaWVsZEV4cHIgKyAnPT09JyArIHZhbHVlRXhwcihwcmVkaWNhdGUuZXF1YWwsIHByZWRpY2F0ZS50aW1lVW5pdCk7XG4gIH0gZWxzZSBpZiAoaXNGaWVsZE9uZU9mUHJlZGljYXRlKHByZWRpY2F0ZSkpIHtcbiAgICAvLyBcIm9uZU9mXCIgd2FzIGZvcm1lcmx5IFwiaW5cIiAtLSBzbyB3ZSBuZWVkIHRvIGFkZCBiYWNrd2FyZCBjb21wYXRpYmlsaXR5XG4gICAgY29uc3Qgb25lT2Y6IEZpZWxkT25lT2ZQcmVkaWNhdGVbXSA9IHByZWRpY2F0ZS5vbmVPZiB8fCBwcmVkaWNhdGVbJ2luJ107XG4gICAgcmV0dXJuICdpbmRleG9mKFsnICtcbiAgICAgIG9uZU9mLm1hcCgodikgPT4gdmFsdWVFeHByKHYsIHByZWRpY2F0ZS50aW1lVW5pdCkpLmpvaW4oJywnKSArXG4gICAgICAnXSwgJyArIGZpZWxkRXhwciArICcpICE9PSAtMSc7XG4gIH0gZWxzZSBpZiAoaXNGaWVsZFJhbmdlUHJlZGljYXRlKHByZWRpY2F0ZSkpIHtcbiAgICBjb25zdCBsb3dlciA9IHByZWRpY2F0ZS5yYW5nZVswXTtcbiAgICBjb25zdCB1cHBlciA9IHByZWRpY2F0ZS5yYW5nZVsxXTtcblxuICAgIGlmIChsb3dlciAhPT0gbnVsbCAmJiB1cHBlciAhPT0gbnVsbCAmJiB1c2VJblJhbmdlKSB7XG4gICAgICByZXR1cm4gJ2lucmFuZ2UoJyArIGZpZWxkRXhwciArICcsIFsnICtcbiAgICAgICAgdmFsdWVFeHByKGxvd2VyLCBwcmVkaWNhdGUudGltZVVuaXQpICsgJywgJyArXG4gICAgICAgIHZhbHVlRXhwcih1cHBlciwgcHJlZGljYXRlLnRpbWVVbml0KSArICddKSc7XG4gICAgfVxuXG4gICAgY29uc3QgZXhwcnMgPSBbXTtcbiAgICBpZiAobG93ZXIgIT09IG51bGwpIHtcbiAgICAgIGV4cHJzLnB1c2goYCR7ZmllbGRFeHByfSA+PSAke3ZhbHVlRXhwcihsb3dlciwgcHJlZGljYXRlLnRpbWVVbml0KX1gKTtcbiAgICB9XG4gICAgaWYgKHVwcGVyICE9PSBudWxsKSB7XG4gICAgICBleHBycy5wdXNoKGAke2ZpZWxkRXhwcn0gPD0gJHt2YWx1ZUV4cHIodXBwZXIsIHByZWRpY2F0ZS50aW1lVW5pdCl9YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGV4cHJzLmxlbmd0aCA+IDAgPyBleHBycy5qb2luKCcgJiYgJykgOiAndHJ1ZSc7XG4gIH1cblxuICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dDogaXQgc2hvdWxkIG5ldmVyIHJlYWNoIGhlcmUgKi9cbiAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGZpZWxkIHByZWRpY2F0ZTogJHtKU09OLnN0cmluZ2lmeShwcmVkaWNhdGUpfWApO1xufVxuXG5mdW5jdGlvbiB2YWx1ZUV4cHIodjogYW55LCB0aW1lVW5pdDogVGltZVVuaXQpOiBzdHJpbmcge1xuICBpZiAoaXNEYXRlVGltZSh2KSkge1xuICAgIGNvbnN0IGV4cHIgPSBkYXRlVGltZUV4cHIodiwgdHJ1ZSk7XG4gICAgcmV0dXJuICd0aW1lKCcgKyBleHByICsgJyknO1xuICB9XG4gIGlmIChpc0xvY2FsU2luZ2xlVGltZVVuaXQodGltZVVuaXQpKSB7XG4gICAgY29uc3QgZGF0ZXRpbWU6IERhdGVUaW1lID0ge307XG4gICAgZGF0ZXRpbWVbdGltZVVuaXRdID0gdjtcbiAgICBjb25zdCBleHByID0gZGF0ZVRpbWVFeHByKGRhdGV0aW1lLCB0cnVlKTtcbiAgICByZXR1cm4gJ3RpbWUoJyArIGV4cHIgKyAnKSc7XG4gIH0gZWxzZSBpZiAoaXNVdGNTaW5nbGVUaW1lVW5pdCh0aW1lVW5pdCkpIHtcbiAgICByZXR1cm4gdmFsdWVFeHByKHYsIGdldExvY2FsVGltZVVuaXQodGltZVVuaXQpKTtcbiAgfVxuICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodik7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVQcmVkaWNhdGUoZjogUHJlZGljYXRlKTogUHJlZGljYXRlIHtcbiAgaWYgKGlzRmllbGRQcmVkaWNhdGUoZikgJiYgZi50aW1lVW5pdCkge1xuICAgIHJldHVybiB7XG4gICAgICAuLi5mLFxuICAgICAgdGltZVVuaXQ6IG5vcm1hbGl6ZVRpbWVVbml0KGYudGltZVVuaXQpXG4gICAgfTtcbiAgfVxuICByZXR1cm4gZjtcbn1cbiJdfQ==