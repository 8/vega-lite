import * as tslib_1 from "tslib";
import { isArray, isString } from 'vega-util';
import { selectionPredicate } from './compile/selection/selection';
import { dateTimeExpr, isDateTime } from './datetime';
import { vgField } from './fielddef';
import { fieldExpr as timeUnitFieldExpr, getLocalTimeUnit, isLocalSingleTimeUnit, isUtcSingleTimeUnit, normalizeTimeUnit } from './timeunit';
import { logicalExpr } from './util';
export function isSelectionPredicate(predicate) {
    return predicate && predicate['selection'];
}
export function isFieldEqualPredicate(predicate) {
    return predicate && !!predicate.field && predicate.equal !== undefined;
}
export function isFieldLTPredicate(predicate) {
    return predicate && !!predicate.field && predicate.lt !== undefined;
}
export function isFieldLTEPredicate(predicate) {
    return predicate && !!predicate.field && predicate.lte !== undefined;
}
export function isFieldGTPredicate(predicate) {
    return predicate && !!predicate.field && predicate.gt !== undefined;
}
export function isFieldGTEPredicate(predicate) {
    return predicate && !!predicate.field && predicate.gte !== undefined;
}
export function isFieldRangePredicate(predicate) {
    if (predicate && predicate.field) {
        if (isArray(predicate.range) && predicate.range.length === 2) {
            return true;
        }
    }
    return false;
}
export function isFieldOneOfPredicate(predicate) {
    return predicate && !!predicate.field && (isArray(predicate.oneOf) ||
        isArray(predicate.in) // backward compatibility
    );
}
export function isFieldPredicate(predicate) {
    return isFieldOneOfPredicate(predicate) || isFieldEqualPredicate(predicate) || isFieldRangePredicate(predicate) || isFieldLTPredicate(predicate) || isFieldGTPredicate(predicate) || isFieldLTEPredicate(predicate) || isFieldGTEPredicate(predicate);
}
/**
 * Converts a predicate into an expression.
 */
// model is only used for selection filters.
export function expression(model, filterOp, node) {
    return logicalExpr(filterOp, function (predicate) {
        if (isString(predicate)) {
            return predicate;
        }
        else if (isSelectionPredicate(predicate)) {
            return selectionPredicate(model, predicate.selection, node);
        }
        else { // Filter Object
            return fieldFilterExpression(predicate);
        }
    });
}
// This method is used by Voyager.  Do not change its behavior without changing Voyager.
export function fieldFilterExpression(predicate, useInRange) {
    if (useInRange === void 0) { useInRange = true; }
    var fieldExpr = predicate.timeUnit ?
        // For timeUnit, cast into integer with time() so we can use ===, inrange, indexOf to compare values directly.
        // TODO: We calculate timeUnit on the fly here. Consider if we would like to consolidate this with timeUnit pipeline
        // TODO: support utc
        ('time(' + timeUnitFieldExpr(predicate.timeUnit, predicate.field) + ')') :
        vgField(predicate, { expr: 'datum' });
    if (isFieldEqualPredicate(predicate)) {
        return fieldExpr + '===' + valueExpr(predicate.equal, predicate.timeUnit);
    }
    else if (isFieldLTPredicate(predicate)) {
        var upper = predicate.lt;
        return fieldExpr + "<" + valueExpr(upper, predicate.timeUnit);
    }
    else if (isFieldGTPredicate(predicate)) {
        var lower = predicate.gt;
        return fieldExpr + ">" + valueExpr(lower, predicate.timeUnit);
    }
    else if (isFieldLTEPredicate(predicate)) {
        var upper = predicate.lte;
        return fieldExpr + "<=" + valueExpr(upper, predicate.timeUnit);
    }
    else if (isFieldGTEPredicate(predicate)) {
        var lower = predicate.gte;
        return fieldExpr + ">=" + valueExpr(lower, predicate.timeUnit);
    }
    else if (isFieldOneOfPredicate(predicate)) {
        // "oneOf" was formerly "in" -- so we need to add backward compatibility
        var oneOf = predicate.oneOf || predicate['in'];
        return 'indexof([' +
            oneOf.map(function (v) { return valueExpr(v, predicate.timeUnit); }).join(',') +
            '], ' + fieldExpr + ') !== -1';
    }
    else if (isFieldRangePredicate(predicate)) {
        var lower = predicate.range[0];
        var upper = predicate.range[1];
        if (lower !== null && upper !== null && useInRange) {
            return 'inrange(' + fieldExpr + ', [' +
                valueExpr(lower, predicate.timeUnit) + ', ' +
                valueExpr(upper, predicate.timeUnit) + '])';
        }
        var exprs = [];
        if (lower !== null) {
            exprs.push(fieldExpr + " >= " + valueExpr(lower, predicate.timeUnit));
        }
        if (upper !== null) {
            exprs.push(fieldExpr + " <= " + valueExpr(upper, predicate.timeUnit));
        }
        return exprs.length > 0 ? exprs.join(' && ') : 'true';
    }
    /* istanbul ignore next: it should never reach here */
    throw new Error("Invalid field predicate: " + JSON.stringify(predicate));
}
function valueExpr(v, timeUnit) {
    if (isDateTime(v)) {
        var expr = dateTimeExpr(v, true);
        return 'time(' + expr + ')';
    }
    if (isLocalSingleTimeUnit(timeUnit)) {
        var datetime = {};
        datetime[timeUnit] = v;
        var expr = dateTimeExpr(datetime, true);
        return 'time(' + expr + ')';
    }
    else if (isUtcSingleTimeUnit(timeUnit)) {
        return valueExpr(v, getLocalTimeUnit(timeUnit));
    }
    return JSON.stringify(v);
}
export function normalizePredicate(f) {
    if (isFieldPredicate(f) && f.timeUnit) {
        return tslib_1.__assign({}, f, { timeUnit: normalizeTimeUnit(f.timeUnit) });
    }
    return f;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlZGljYXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3ByZWRpY2F0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFDLE9BQU8sRUFBRSxRQUFRLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFHNUMsT0FBTyxFQUFDLGtCQUFrQixFQUFDLE1BQU0sK0JBQStCLENBQUM7QUFDakUsT0FBTyxFQUFXLFlBQVksRUFBRSxVQUFVLEVBQUMsTUFBTSxZQUFZLENBQUM7QUFDOUQsT0FBTyxFQUFDLE9BQU8sRUFBQyxNQUFNLFlBQVksQ0FBQztBQUVuQyxPQUFPLEVBQUMsU0FBUyxJQUFJLGlCQUFpQixFQUFFLGdCQUFnQixFQUFFLHFCQUFxQixFQUFFLG1CQUFtQixFQUFFLGlCQUFpQixFQUFXLE1BQU0sWUFBWSxDQUFDO0FBQ3JKLE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSxRQUFRLENBQUM7QUFzQm5DLE1BQU0sK0JBQStCLFNBQW9DO0lBQ3ZFLE9BQU8sU0FBUyxJQUFJLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUM3QyxDQUFDO0FBd0JELE1BQU0sZ0NBQWdDLFNBQWM7SUFDbEQsT0FBTyxTQUFTLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLElBQUksU0FBUyxDQUFDLEtBQUssS0FBSyxTQUFTLENBQUM7QUFDekUsQ0FBQztBQVVELE1BQU0sNkJBQTZCLFNBQWM7SUFDL0MsT0FBTyxTQUFTLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLElBQUksU0FBUyxDQUFDLEVBQUUsS0FBSyxTQUFTLENBQUM7QUFDdEUsQ0FBQztBQVdELE1BQU0sOEJBQThCLFNBQWM7SUFDaEQsT0FBTyxTQUFTLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLElBQUksU0FBUyxDQUFDLEdBQUcsS0FBSyxTQUFTLENBQUM7QUFDdkUsQ0FBQztBQVdELE1BQU0sNkJBQTZCLFNBQWM7SUFDL0MsT0FBTyxT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QUFNLFFBQVEsR0FBYSxFQUFFLENBQUM7UUFDOUIsUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN2QixJQUFNLElBQUksR0FBRyxZQUFZLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzFDLE9BQU8sT0FBTyxHQUFHLElBQUksR0FBRyxHQUFHLENBQUM7S0FDN0I7U0FBTSxJQUFJLG1CQUFtQixDQUFDLFFBQVEsQ0FBQyxFQUFFO1FBQ3hDLE9BQU8sU0FBUyxDQUFDLENBQUMsRUFBRSxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0tBQ2pEO0lBQ0QsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzNCLENBQUM7QUFFRCxNQUFNLDZCQUE2QixDQUFZO0lBQzdDLElBQUksZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsRUFBRTtRQUNyQyw0QkFDSyxDQUFDLElBQ0osUUFBUSxFQUFFLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFDdkM7S0FDSDtJQUNELE9BQU8sQ0FBQyxDQUFDO0FBQ1gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7aXNBcnJheSwgaXNTdHJpbmd9IGZyb20gJ3ZlZ2EtdXRpbCc7XG5pbXBvcnQge0RhdGFGbG93Tm9kZX0gZnJvbSAnLi9jb21waWxlL2RhdGEvZGF0YWZsb3cnO1xuaW1wb3J0IHtNb2RlbH0gZnJvbSAnLi9jb21waWxlL21vZGVsJztcbmltcG9ydCB7c2VsZWN0aW9uUHJlZGljYXRlfSBmcm9tICcuL2NvbXBpbGUvc2VsZWN0aW9uL3NlbGVjdGlvbic7XG5pbXBvcnQge0RhdGVUaW1lLCBkYXRlVGltZUV4cHIsIGlzRGF0ZVRpbWV9IGZyb20gJy4vZGF0ZXRpbWUnO1xuaW1wb3J0IHt2Z0ZpZWxkfSBmcm9tICcuL2ZpZWxkZGVmJztcbmltcG9ydCB7TG9naWNhbE9wZXJhbmR9IGZyb20gJy4vbG9naWNhbCc7XG5pbXBvcnQge2ZpZWxkRXhwciBhcyB0aW1lVW5pdEZpZWxkRXhwciwgZ2V0TG9jYWxUaW1lVW5pdCwgaXNMb2NhbFNpbmdsZVRpbWVVbml0LCBpc1V0Y1NpbmdsZVRpbWVVbml0LCBub3JtYWxpemVUaW1lVW5pdCwgVGltZVVuaXR9IGZyb20gJy4vdGltZXVuaXQnO1xuaW1wb3J0IHtsb2dpY2FsRXhwcn0gZnJvbSAnLi91dGlsJztcblxuZXhwb3J0IHR5cGUgUHJlZGljYXRlID1cbiAgLy8gYSkgRmllbGRQcmVkaWNhdGUgKGJ1dCB3ZSBkb24ndCB0eXBlIEZpZWxkRmlsdGVyIGhlcmUgc28gdGhlIHNjaGVtYSBoYXMgbm8gbmVzdGluZ1xuICAvLyBhbmQgdGh1cyB0aGUgZG9jdW1lbnRhdGlvbiBzaG93cyBhbGwgb2YgdGhlIHR5cGVzIGNsZWFybHkpXG4gIEZpZWxkRXF1YWxQcmVkaWNhdGUgfCBGaWVsZFJhbmdlUHJlZGljYXRlIHwgRmllbGRPbmVPZlByZWRpY2F0ZSB8IEZpZWxkTFRQcmVkaWNhdGUgfCBGaWVsZEdUUHJlZGljYXRlIHwgRmllbGRMVEVQcmVkaWNhdGUgfCBGaWVsZEdURVByZWRpY2F0ZSB8XG4gIC8vIGIpIFNlbGVjdGlvbiBQcmVkaWNhdGVcbiAgU2VsZWN0aW9uUHJlZGljYXRlIHxcbiAgLy8gYykgVmVnYSBFeHByZXNzaW9uIHN0cmluZ1xuICBzdHJpbmc7XG5cblxuXG5leHBvcnQgdHlwZSBGaWVsZFByZWRpY2F0ZSA9IEZpZWxkRXF1YWxQcmVkaWNhdGUgfCBGaWVsZExUUHJlZGljYXRlIHwgRmllbGRHVFByZWRpY2F0ZSB8IEZpZWxkTFRFUHJlZGljYXRlIHwgRmllbGRHVEVQcmVkaWNhdGUgfEZpZWxkUmFuZ2VQcmVkaWNhdGUgfCBGaWVsZE9uZU9mUHJlZGljYXRlO1xuXG5leHBvcnQgaW50ZXJmYWNlIFNlbGVjdGlvblByZWRpY2F0ZSB7XG4gIC8qKlxuICAgKiBGaWx0ZXIgdXNpbmcgYSBzZWxlY3Rpb24gbmFtZS5cbiAgICovXG4gIHNlbGVjdGlvbjogTG9naWNhbE9wZXJhbmQ8c3RyaW5nPjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzU2VsZWN0aW9uUHJlZGljYXRlKHByZWRpY2F0ZTogTG9naWNhbE9wZXJhbmQ8UHJlZGljYXRlPik6IHByZWRpY2F0ZSBpcyBTZWxlY3Rpb25QcmVkaWNhdGUge1xuICByZXR1cm4gcHJlZGljYXRlICYmIHByZWRpY2F0ZVsnc2VsZWN0aW9uJ107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRmllbGRQcmVkaWNhdGVCYXNlIHtcbiAgLy8gVE9ETzogc3VwcG9ydCBhZ2dyZWdhdGVcblxuICAvKipcbiAgICogVGltZSB1bml0IGZvciB0aGUgZmllbGQgdG8gYmUgZmlsdGVyZWQuXG4gICAqL1xuICB0aW1lVW5pdD86IFRpbWVVbml0O1xuXG4gIC8qKlxuICAgKiBGaWVsZCB0byBiZSBmaWx0ZXJlZC5cbiAgICovXG4gIGZpZWxkOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRmllbGRFcXVhbFByZWRpY2F0ZSBleHRlbmRzIEZpZWxkUHJlZGljYXRlQmFzZSB7XG4gIC8qKlxuICAgKiBUaGUgdmFsdWUgdGhhdCB0aGUgZmllbGQgc2hvdWxkIGJlIGVxdWFsIHRvLlxuICAgKi9cbiAgZXF1YWw6IHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4gfCBEYXRlVGltZTtcblxufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNGaWVsZEVxdWFsUHJlZGljYXRlKHByZWRpY2F0ZTogYW55KTogcHJlZGljYXRlIGlzIEZpZWxkRXF1YWxQcmVkaWNhdGUge1xuICByZXR1cm4gcHJlZGljYXRlICYmICEhcHJlZGljYXRlLmZpZWxkICYmIHByZWRpY2F0ZS5lcXVhbCAhPT0gdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEZpZWxkTFRQcmVkaWNhdGUgZXh0ZW5kcyBGaWVsZFByZWRpY2F0ZUJhc2Uge1xuICAvKipcbiAgICogVGhlIHZhbHVlIHRoYXQgdGhlIGZpZWxkIHNob3VsZCBiZSBsZXNzIHRoYW4uXG4gICAqL1xuICBsdDogc3RyaW5nIHwgbnVtYmVyIHwgRGF0ZVRpbWU7XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRmllbGRMVFByZWRpY2F0ZShwcmVkaWNhdGU6IGFueSk6IHByZWRpY2F0ZSBpcyBGaWVsZExUUHJlZGljYXRlIHtcbiAgcmV0dXJuIHByZWRpY2F0ZSAmJiAhIXByZWRpY2F0ZS5maWVsZCAmJiBwcmVkaWNhdGUubHQgIT09IHVuZGVmaW5lZDtcbn1cblxuXG5leHBvcnQgaW50ZXJmYWNlIEZpZWxkTFRFUHJlZGljYXRlIGV4dGVuZHMgRmllbGRQcmVkaWNhdGVCYXNlIHtcbiAgLyoqXG4gICAqIFRoZSB2YWx1ZSB0aGF0IHRoZSBmaWVsZCBzaG91bGQgYmUgbGVzcyB0aGFuIG9yIGVxdWFscyB0by5cbiAgICovXG4gIGx0ZTogc3RyaW5nIHwgbnVtYmVyIHwgRGF0ZVRpbWU7XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRmllbGRMVEVQcmVkaWNhdGUocHJlZGljYXRlOiBhbnkpOiBwcmVkaWNhdGUgaXMgRmllbGRMVEVQcmVkaWNhdGUge1xuICByZXR1cm4gcHJlZGljYXRlICYmICEhcHJlZGljYXRlLmZpZWxkICYmIHByZWRpY2F0ZS5sdGUgIT09IHVuZGVmaW5lZDtcbn1cblxuXG5leHBvcnQgaW50ZXJmYWNlIEZpZWxkR1RQcmVkaWNhdGUgZXh0ZW5kcyBGaWVsZFByZWRpY2F0ZUJhc2Uge1xuICAvKipcbiAgICogVGhlIHZhbHVlIHRoYXQgdGhlIGZpZWxkIHNob3VsZCBiZSBncmVhdGVyIHRoYW4uXG4gICAqL1xuICBndDogc3RyaW5nIHwgbnVtYmVyIHwgRGF0ZVRpbWU7XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRmllbGRHVFByZWRpY2F0ZShwcmVkaWNhdGU6IGFueSk6IHByZWRpY2F0ZSBpcyBGaWVsZEdUUHJlZGljYXRlIHtcbiAgcmV0dXJuIHByZWRpY2F0ZSAmJiAhIXByZWRpY2F0ZS5maWVsZCAmJiBwcmVkaWNhdGUuZ3QgIT09IHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBGaWVsZEdURVByZWRpY2F0ZSBleHRlbmRzIEZpZWxkUHJlZGljYXRlQmFzZSB7XG4gIC8qKlxuICAgKiBUaGUgdmFsdWUgdGhhdCB0aGUgZmllbGQgc2hvdWxkIGJlIGdyZWF0ZXIgdGhhbiBvciBlcXVhbHMgdG8uXG4gICAqL1xuICBndGU6IHN0cmluZyB8IG51bWJlciB8IERhdGVUaW1lO1xuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0ZpZWxkR1RFUHJlZGljYXRlKHByZWRpY2F0ZTogYW55KTogcHJlZGljYXRlIGlzIEZpZWxkR1RFUHJlZGljYXRlIHtcbiAgcmV0dXJuIHByZWRpY2F0ZSAmJiAhIXByZWRpY2F0ZS5maWVsZCAmJiBwcmVkaWNhdGUuZ3RlICE9PSB1bmRlZmluZWQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRmllbGRSYW5nZVByZWRpY2F0ZSBleHRlbmRzIEZpZWxkUHJlZGljYXRlQmFzZSB7XG4gIC8qKlxuICAgKiBBbiBhcnJheSBvZiBpbmNsdXNpdmUgbWluaW11bSBhbmQgbWF4aW11bSB2YWx1ZXNcbiAgICogZm9yIGEgZmllbGQgdmFsdWUgb2YgYSBkYXRhIGl0ZW0gdG8gYmUgaW5jbHVkZWQgaW4gdGhlIGZpbHRlcmVkIGRhdGEuXG4gICAqIEBtYXhJdGVtcyAyXG4gICAqIEBtaW5JdGVtcyAyXG4gICAqL1xuICByYW5nZTogKG51bWJlcnxEYXRlVGltZXxudWxsKVtdO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNGaWVsZFJhbmdlUHJlZGljYXRlKHByZWRpY2F0ZTogYW55KTogcHJlZGljYXRlIGlzIEZpZWxkUmFuZ2VQcmVkaWNhdGUge1xuICBpZiAocHJlZGljYXRlICYmIHByZWRpY2F0ZS5maWVsZCkge1xuICAgIGlmIChpc0FycmF5KHByZWRpY2F0ZS5yYW5nZSkgJiYgcHJlZGljYXRlLnJhbmdlLmxlbmd0aCA9PT0gMikge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG4gIHJldHVybiBmYWxzZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBGaWVsZE9uZU9mUHJlZGljYXRlIGV4dGVuZHMgRmllbGRQcmVkaWNhdGVCYXNlIHtcbiAgLyoqXG4gICAqIEEgc2V0IG9mIHZhbHVlcyB0aGF0IHRoZSBgZmllbGRgJ3MgdmFsdWUgc2hvdWxkIGJlIGEgbWVtYmVyIG9mLFxuICAgKiBmb3IgYSBkYXRhIGl0ZW0gaW5jbHVkZWQgaW4gdGhlIGZpbHRlcmVkIGRhdGEuXG4gICAqL1xuICBvbmVPZjogc3RyaW5nW10gfCBudW1iZXJbXSB8IGJvb2xlYW5bXSB8IERhdGVUaW1lW107XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRmllbGRPbmVPZlByZWRpY2F0ZShwcmVkaWNhdGU6IGFueSk6IHByZWRpY2F0ZSBpcyBGaWVsZE9uZU9mUHJlZGljYXRlIHtcbiAgcmV0dXJuIHByZWRpY2F0ZSAmJiAhIXByZWRpY2F0ZS5maWVsZCAmJiAoXG4gICAgaXNBcnJheShwcmVkaWNhdGUub25lT2YpIHx8XG4gICAgaXNBcnJheShwcmVkaWNhdGUuaW4pIC8vIGJhY2t3YXJkIGNvbXBhdGliaWxpdHlcbiAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRmllbGRQcmVkaWNhdGUocHJlZGljYXRlOiBQcmVkaWNhdGUpOiBwcmVkaWNhdGUgaXMgRmllbGRPbmVPZlByZWRpY2F0ZSB8IEZpZWxkRXF1YWxQcmVkaWNhdGUgfCBGaWVsZFJhbmdlUHJlZGljYXRlIHwgRmllbGRMVFByZWRpY2F0ZSB8IEZpZWxkR1RQcmVkaWNhdGUgfCBGaWVsZExURVByZWRpY2F0ZSB8IEZpZWxkR1RFUHJlZGljYXRlIHtcbiAgcmV0dXJuIGlzRmllbGRPbmVPZlByZWRpY2F0ZShwcmVkaWNhdGUpIHx8IGlzRmllbGRFcXVhbFByZWRpY2F0ZShwcmVkaWNhdGUpIHx8IGlzRmllbGRSYW5nZVByZWRpY2F0ZShwcmVkaWNhdGUpIHx8IGlzRmllbGRMVFByZWRpY2F0ZShwcmVkaWNhdGUpIHx8IGlzRmllbGRHVFByZWRpY2F0ZShwcmVkaWNhdGUpIHx8IGlzRmllbGRMVEVQcmVkaWNhdGUocHJlZGljYXRlKSB8fCBpc0ZpZWxkR1RFUHJlZGljYXRlKHByZWRpY2F0ZSk7XG59XG5cbi8qKlxuICogQ29udmVydHMgYSBwcmVkaWNhdGUgaW50byBhbiBleHByZXNzaW9uLlxuICovXG4vLyBtb2RlbCBpcyBvbmx5IHVzZWQgZm9yIHNlbGVjdGlvbiBmaWx0ZXJzLlxuZXhwb3J0IGZ1bmN0aW9uIGV4cHJlc3Npb24obW9kZWw6IE1vZGVsLCBmaWx0ZXJPcDogTG9naWNhbE9wZXJhbmQ8UHJlZGljYXRlPiwgbm9kZT86IERhdGFGbG93Tm9kZSk6IHN0cmluZyB7XG4gIHJldHVybiBsb2dpY2FsRXhwcihmaWx0ZXJPcCwgKHByZWRpY2F0ZTogUHJlZGljYXRlKSA9PiB7XG4gICAgaWYgKGlzU3RyaW5nKHByZWRpY2F0ZSkpIHtcbiAgICAgIHJldHVybiBwcmVkaWNhdGU7XG4gICAgfSBlbHNlIGlmIChpc1NlbGVjdGlvblByZWRpY2F0ZShwcmVkaWNhdGUpKSB7XG4gICAgICByZXR1cm4gc2VsZWN0aW9uUHJlZGljYXRlKG1vZGVsLCBwcmVkaWNhdGUuc2VsZWN0aW9uLCBub2RlKTtcbiAgICB9IGVsc2UgeyAvLyBGaWx0ZXIgT2JqZWN0XG4gICAgICByZXR1cm4gZmllbGRGaWx0ZXJFeHByZXNzaW9uKHByZWRpY2F0ZSk7XG4gICAgfVxuICB9KTtcbn1cblxuLy8gVGhpcyBtZXRob2QgaXMgdXNlZCBieSBWb3lhZ2VyLiAgRG8gbm90IGNoYW5nZSBpdHMgYmVoYXZpb3Igd2l0aG91dCBjaGFuZ2luZyBWb3lhZ2VyLlxuZXhwb3J0IGZ1bmN0aW9uIGZpZWxkRmlsdGVyRXhwcmVzc2lvbihwcmVkaWNhdGU6IEZpZWxkUHJlZGljYXRlLCB1c2VJblJhbmdlPXRydWUpIHtcbiAgY29uc3QgZmllbGRFeHByID0gcHJlZGljYXRlLnRpbWVVbml0ID9cbiAgICAvLyBGb3IgdGltZVVuaXQsIGNhc3QgaW50byBpbnRlZ2VyIHdpdGggdGltZSgpIHNvIHdlIGNhbiB1c2UgPT09LCBpbnJhbmdlLCBpbmRleE9mIHRvIGNvbXBhcmUgdmFsdWVzIGRpcmVjdGx5LlxuICAgICAgLy8gVE9ETzogV2UgY2FsY3VsYXRlIHRpbWVVbml0IG9uIHRoZSBmbHkgaGVyZS4gQ29uc2lkZXIgaWYgd2Ugd291bGQgbGlrZSB0byBjb25zb2xpZGF0ZSB0aGlzIHdpdGggdGltZVVuaXQgcGlwZWxpbmVcbiAgICAgIC8vIFRPRE86IHN1cHBvcnQgdXRjXG4gICAgKCd0aW1lKCcgKyB0aW1lVW5pdEZpZWxkRXhwcihwcmVkaWNhdGUudGltZVVuaXQsIHByZWRpY2F0ZS5maWVsZCkgKyAnKScpIDpcbiAgICB2Z0ZpZWxkKHByZWRpY2F0ZSwge2V4cHI6ICdkYXR1bSd9KTtcblxuICBpZiAoaXNGaWVsZEVxdWFsUHJlZGljYXRlKHByZWRpY2F0ZSkpIHtcbiAgICByZXR1cm4gZmllbGRFeHByICsgJz09PScgKyB2YWx1ZUV4cHIocHJlZGljYXRlLmVxdWFsLCBwcmVkaWNhdGUudGltZVVuaXQpO1xuICB9IGVsc2UgaWYgKGlzRmllbGRMVFByZWRpY2F0ZShwcmVkaWNhdGUpKSB7XG4gICAgY29uc3QgdXBwZXIgPSBwcmVkaWNhdGUubHQ7XG4gICAgcmV0dXJuIGAke2ZpZWxkRXhwcn08JHt2YWx1ZUV4cHIodXBwZXIsIHByZWRpY2F0ZS50aW1lVW5pdCl9YDtcbiAgfSBlbHNlIGlmIChpc0ZpZWxkR1RQcmVkaWNhdGUocHJlZGljYXRlKSkge1xuICAgIGNvbnN0IGxvd2VyID0gcHJlZGljYXRlLmd0O1xuICAgIHJldHVybiBgJHtmaWVsZEV4cHJ9PiR7dmFsdWVFeHByKGxvd2VyLCBwcmVkaWNhdGUudGltZVVuaXQpfWA7XG4gIH0gZWxzZSBpZiAoaXNGaWVsZExURVByZWRpY2F0ZShwcmVkaWNhdGUpKSB7XG4gICAgY29uc3QgdXBwZXIgPSBwcmVkaWNhdGUubHRlO1xuICAgIHJldHVybiBgJHtmaWVsZEV4cHJ9PD0ke3ZhbHVlRXhwcih1cHBlciwgcHJlZGljYXRlLnRpbWVVbml0KX1gO1xuICB9IGVsc2UgaWYgKGlzRmllbGRHVEVQcmVkaWNhdGUocHJlZGljYXRlKSkge1xuICAgIGNvbnN0IGxvd2VyID0gcHJlZGljYXRlLmd0ZTtcbiAgICByZXR1cm4gYCR7ZmllbGRFeHByfT49JHt2YWx1ZUV4cHIobG93ZXIsIHByZWRpY2F0ZS50aW1lVW5pdCl9YDtcbiAgfSBlbHNlIGlmIChpc0ZpZWxkT25lT2ZQcmVkaWNhdGUocHJlZGljYXRlKSkge1xuICAgIC8vIFwib25lT2ZcIiB3YXMgZm9ybWVybHkgXCJpblwiIC0tIHNvIHdlIG5lZWQgdG8gYWRkIGJhY2t3YXJkIGNvbXBhdGliaWxpdHlcbiAgICBjb25zdCBvbmVPZjogRmllbGRPbmVPZlByZWRpY2F0ZVtdID0gcHJlZGljYXRlLm9uZU9mIHx8IHByZWRpY2F0ZVsnaW4nXTtcbiAgICByZXR1cm4gJ2luZGV4b2YoWycgK1xuICAgICAgb25lT2YubWFwKCh2KSA9PiB2YWx1ZUV4cHIodiwgcHJlZGljYXRlLnRpbWVVbml0KSkuam9pbignLCcpICtcbiAgICAgICddLCAnICsgZmllbGRFeHByICsgJykgIT09IC0xJztcbiAgfSBlbHNlIGlmIChpc0ZpZWxkUmFuZ2VQcmVkaWNhdGUocHJlZGljYXRlKSkge1xuICAgIGNvbnN0IGxvd2VyID0gcHJlZGljYXRlLnJhbmdlWzBdO1xuICAgIGNvbnN0IHVwcGVyID0gcHJlZGljYXRlLnJhbmdlWzFdO1xuXG4gICAgaWYgKGxvd2VyICE9PSBudWxsICYmIHVwcGVyICE9PSBudWxsICYmIHVzZUluUmFuZ2UpIHtcbiAgICAgIHJldHVybiAnaW5yYW5nZSgnICsgZmllbGRFeHByICsgJywgWycgK1xuICAgICAgICB2YWx1ZUV4cHIobG93ZXIsIHByZWRpY2F0ZS50aW1lVW5pdCkgKyAnLCAnICtcbiAgICAgICAgdmFsdWVFeHByKHVwcGVyLCBwcmVkaWNhdGUudGltZVVuaXQpICsgJ10pJztcbiAgICB9XG5cbiAgICBjb25zdCBleHBycyA9IFtdO1xuICAgIGlmIChsb3dlciAhPT0gbnVsbCkge1xuICAgICAgZXhwcnMucHVzaChgJHtmaWVsZEV4cHJ9ID49ICR7dmFsdWVFeHByKGxvd2VyLCBwcmVkaWNhdGUudGltZVVuaXQpfWApO1xuICAgIH1cbiAgICBpZiAodXBwZXIgIT09IG51bGwpIHtcbiAgICAgIGV4cHJzLnB1c2goYCR7ZmllbGRFeHByfSA8PSAke3ZhbHVlRXhwcih1cHBlciwgcHJlZGljYXRlLnRpbWVVbml0KX1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZXhwcnMubGVuZ3RoID4gMCA/IGV4cHJzLmpvaW4oJyAmJiAnKSA6ICd0cnVlJztcbiAgfVxuXG4gIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0OiBpdCBzaG91bGQgbmV2ZXIgcmVhY2ggaGVyZSAqL1xuICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgZmllbGQgcHJlZGljYXRlOiAke0pTT04uc3RyaW5naWZ5KHByZWRpY2F0ZSl9YCk7XG59XG5cbmZ1bmN0aW9uIHZhbHVlRXhwcih2OiBhbnksIHRpbWVVbml0OiBUaW1lVW5pdCk6IHN0cmluZyB7XG4gIGlmIChpc0RhdGVUaW1lKHYpKSB7XG4gICAgY29uc3QgZXhwciA9IGRhdGVUaW1lRXhwcih2LCB0cnVlKTtcbiAgICByZXR1cm4gJ3RpbWUoJyArIGV4cHIgKyAnKSc7XG4gIH1cbiAgaWYgKGlzTG9jYWxTaW5nbGVUaW1lVW5pdCh0aW1lVW5pdCkpIHtcbiAgICBjb25zdCBkYXRldGltZTogRGF0ZVRpbWUgPSB7fTtcbiAgICBkYXRldGltZVt0aW1lVW5pdF0gPSB2O1xuICAgIGNvbnN0IGV4cHIgPSBkYXRlVGltZUV4cHIoZGF0ZXRpbWUsIHRydWUpO1xuICAgIHJldHVybiAndGltZSgnICsgZXhwciArICcpJztcbiAgfSBlbHNlIGlmIChpc1V0Y1NpbmdsZVRpbWVVbml0KHRpbWVVbml0KSkge1xuICAgIHJldHVybiB2YWx1ZUV4cHIodiwgZ2V0TG9jYWxUaW1lVW5pdCh0aW1lVW5pdCkpO1xuICB9XG4gIHJldHVybiBKU09OLnN0cmluZ2lmeSh2KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG5vcm1hbGl6ZVByZWRpY2F0ZShmOiBQcmVkaWNhdGUpOiBQcmVkaWNhdGUge1xuICBpZiAoaXNGaWVsZFByZWRpY2F0ZShmKSAmJiBmLnRpbWVVbml0KSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLmYsXG4gICAgICB0aW1lVW5pdDogbm9ybWFsaXplVGltZVVuaXQoZi50aW1lVW5pdClcbiAgICB9O1xuICB9XG4gIHJldHVybiBmO1xufVxuIl19