import { isArray } from 'vega-util';
import { SUM_OPS } from './aggregate';
import { NONPOSITION_CHANNELS, X, X2, Y2 } from './channel';
import { channelHasField } from './encoding';
import { getFieldDef, isFieldDef, isStringFieldDef, vgField } from './fielddef';
import * as log from './log';
import { AREA, BAR, CIRCLE, isMarkDef, isPathMark, LINE, POINT, RULE, SQUARE, TEXT, TICK } from './mark';
import { ScaleType } from './scale';
import { contains } from './util';
var STACK_OFFSET_INDEX = {
    zero: 1,
    center: 1,
    normalize: 1
};
export function isStackOffset(s) {
    return !!STACK_OFFSET_INDEX[s];
}
export var STACKABLE_MARKS = [BAR, AREA, RULE, POINT, CIRCLE, SQUARE, LINE, TEXT, TICK];
export var STACK_BY_DEFAULT_MARKS = [BAR, AREA];
function potentialStackedChannel(encoding) {
    var xDef = encoding.x;
    var yDef = encoding.y;
    if (isFieldDef(xDef) && isFieldDef(yDef)) {
        if (xDef.type === 'quantitative' && yDef.type === 'quantitative') {
            if (xDef.stack) {
                return 'x';
            }
            else if (yDef.stack) {
                return 'y';
            }
            // if there is no explicit stacking, only apply stack if there is only one aggregate for x or y
            if ((!!xDef.aggregate) !== (!!yDef.aggregate)) {
                return xDef.aggregate ? 'x' : 'y';
            }
        }
        else if (xDef.type === 'quantitative') {
            return 'x';
        }
        else if (yDef.type === 'quantitative') {
            return 'y';
        }
    }
    else if (isFieldDef(xDef) && xDef.type === 'quantitative') {
        return 'x';
    }
    else if (isFieldDef(yDef) && yDef.type === 'quantitative') {
        return 'y';
    }
    return undefined;
}
// Note: CompassQL uses this method and only pass in required properties of each argument object.
// If required properties change, make sure to update CompassQL.
export function stack(m, encoding, stackConfig) {
    var mark = isMarkDef(m) ? m.type : m;
    // Should have stackable mark
    if (!contains(STACKABLE_MARKS, mark)) {
        return null;
    }
    var fieldChannel = potentialStackedChannel(encoding);
    if (!fieldChannel) {
        return null;
    }
    var stackedFieldDef = encoding[fieldChannel];
    var stackedField = isStringFieldDef(stackedFieldDef) ? vgField(stackedFieldDef, {}) : undefined;
    var dimensionChannel = fieldChannel === 'x' ? 'y' : 'x';
    var dimensionDef = encoding[dimensionChannel];
    var dimensionField = isStringFieldDef(dimensionDef) ? vgField(dimensionDef, {}) : undefined;
    // Should have grouping level of detail that is different from the dimension field
    var stackBy = NONPOSITION_CHANNELS.reduce(function (sc, channel) {
        if (channelHasField(encoding, channel)) {
            var channelDef = encoding[channel];
            (isArray(channelDef) ? channelDef : [channelDef]).forEach(function (cDef) {
                var fieldDef = getFieldDef(cDef);
                if (fieldDef.aggregate) {
                    return;
                }
                // Check whether the channel's field is identical to x/y's field or if the channel is a repeat
                var f = isStringFieldDef(fieldDef) ? vgField(fieldDef, {}) : undefined;
                if (
                // if fielddef is a repeat, just include it in the stack by
                !f ||
                    // otherwise, the field must be different from x and y fields.
                    (f !== dimensionField && f !== stackedField)) {
                    sc.push({ channel: channel, fieldDef: fieldDef });
                }
            });
        }
        return sc;
    }, []);
    if (stackBy.length === 0) {
        return null;
    }
    // Automatically determine offset
    var offset = undefined;
    if (stackedFieldDef.stack !== undefined) {
        offset = stackedFieldDef.stack;
    }
    else if (contains(STACK_BY_DEFAULT_MARKS, mark)) {
        // Bar and Area with sum ops are automatically stacked by default
        offset = stackConfig === undefined ? 'zero' : stackConfig;
    }
    else {
        offset = stackConfig;
    }
    if (!offset || !isStackOffset(offset)) {
        return null;
    }
    // warn when stacking non-linear
    if (stackedFieldDef.scale && stackedFieldDef.scale.type && stackedFieldDef.scale.type !== ScaleType.LINEAR) {
        log.warn(log.message.cannotStackNonLinearScale(stackedFieldDef.scale.type));
    }
    // Check if it is a ranged mark
    if (channelHasField(encoding, fieldChannel === X ? X2 : Y2)) {
        log.warn(log.message.cannotStackRangedMark(fieldChannel));
        return null;
    }
    // Warn if stacking summative aggregate
    if (stackedFieldDef.aggregate && !contains(SUM_OPS, stackedFieldDef.aggregate)) {
        log.warn(log.message.stackNonSummativeAggregate(stackedFieldDef.aggregate));
    }
    return {
        groupbyChannel: dimensionDef ? dimensionChannel : undefined,
        fieldChannel: fieldChannel,
        impute: isPathMark(mark),
        stackBy: stackBy,
        offset: offset
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLE9BQU8sRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUNsQyxPQUFPLEVBQUMsT0FBTyxFQUFDLE1BQU0sYUFBYSxDQUFDO0FBQ3BDLE9BQU8sRUFBQyxvQkFBb0IsRUFBc0IsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFDOUUsT0FBTyxFQUFDLGVBQWUsRUFBVyxNQUFNLFlBQVksQ0FBQztBQUNyRCxPQUFPLEVBQWtCLFdBQVcsRUFBRSxVQUFVLEVBQUUsZ0JBQWdCLEVBQW9CLE9BQU8sRUFBQyxNQUFNLFlBQVksQ0FBQztBQUNqSCxPQUFPLEtBQUssR0FBRyxNQUFNLE9BQU8sQ0FBQztBQUM3QixPQUFPLEVBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQWlCLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUMsTUFBTSxRQUFRLENBQUM7QUFDdEgsT0FBTyxFQUFDLFNBQVMsRUFBQyxNQUFNLFNBQVMsQ0FBQztBQUNsQyxPQUFPLEVBQUMsUUFBUSxFQUFPLE1BQU0sUUFBUSxDQUFDO0FBS3RDLElBQU0sa0JBQWtCLEdBQXNCO0lBQzVDLElBQUksRUFBRSxDQUFDO0lBQ1AsTUFBTSxFQUFFLENBQUM7SUFDVCxTQUFTLEVBQUUsQ0FBQztDQUNiLENBQUM7QUFFRixNQUFNLHdCQUF3QixDQUFTO0lBQ3JDLE9BQU8sQ0FBQyxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2pDLENBQUM7QUEwQkQsTUFBTSxDQUFDLElBQU0sZUFBZSxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFN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QUNMLGNBQWMsRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxTQUFTO1FBQzNELFlBQVksY0FBQTtRQUNaLE1BQU0sRUFBRSxVQUFVLENBQUMsSUFBSSxDQUFDO1FBQ3hCLE9BQU8sU0FBQTtRQUNQLE1BQU0sUUFBQTtLQUNQLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtpc0FycmF5fSBmcm9tICd2ZWdhLXV0aWwnO1xuaW1wb3J0IHtTVU1fT1BTfSBmcm9tICcuL2FnZ3JlZ2F0ZSc7XG5pbXBvcnQge05PTlBPU0lUSU9OX0NIQU5ORUxTLCBOb25Qb3NpdGlvbkNoYW5uZWwsIFgsIFgyLCBZMn0gZnJvbSAnLi9jaGFubmVsJztcbmltcG9ydCB7Y2hhbm5lbEhhc0ZpZWxkLCBFbmNvZGluZ30gZnJvbSAnLi9lbmNvZGluZyc7XG5pbXBvcnQge0ZpZWxkLCBGaWVsZERlZiwgZ2V0RmllbGREZWYsIGlzRmllbGREZWYsIGlzU3RyaW5nRmllbGREZWYsIFBvc2l0aW9uRmllbGREZWYsIHZnRmllbGR9IGZyb20gJy4vZmllbGRkZWYnO1xuaW1wb3J0ICogYXMgbG9nIGZyb20gJy4vbG9nJztcbmltcG9ydCB7QVJFQSwgQkFSLCBDSVJDTEUsIGlzTWFya0RlZiwgaXNQYXRoTWFyaywgTElORSwgTWFyaywgTWFya0RlZiwgUE9JTlQsIFJVTEUsIFNRVUFSRSwgVEVYVCwgVElDS30gZnJvbSAnLi9tYXJrJztcbmltcG9ydCB7U2NhbGVUeXBlfSBmcm9tICcuL3NjYWxlJztcbmltcG9ydCB7Y29udGFpbnMsIEZsYWd9IGZyb20gJy4vdXRpbCc7XG5cblxuZXhwb3J0IHR5cGUgU3RhY2tPZmZzZXQgPSAnemVybycgfCAnY2VudGVyJyB8ICdub3JtYWxpemUnO1xuXG5jb25zdCBTVEFDS19PRkZTRVRfSU5ERVg6IEZsYWc8U3RhY2tPZmZzZXQ+ID0ge1xuICB6ZXJvOiAxLFxuICBjZW50ZXI6IDEsXG4gIG5vcm1hbGl6ZTogMVxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGlzU3RhY2tPZmZzZXQoczogc3RyaW5nKTogcyBpcyBTdGFja09mZnNldCB7XG4gIHJldHVybiAhIVNUQUNLX09GRlNFVF9JTkRFWFtzXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTdGFja1Byb3BlcnRpZXMge1xuICAvKiogRGltZW5zaW9uIGF4aXMgb2YgdGhlIHN0YWNrLiAqL1xuICBncm91cGJ5Q2hhbm5lbDogJ3gnIHwgJ3knO1xuXG4gIC8qKiBNZWFzdXJlIGF4aXMgb2YgdGhlIHN0YWNrLiAqL1xuICBmaWVsZENoYW5uZWw6ICd4JyB8ICd5JztcblxuICAvKiogU3RhY2stYnkgZmllbGRzIGUuZy4sIGNvbG9yLCBkZXRhaWwgKi9cbiAgc3RhY2tCeToge1xuICAgIGZpZWxkRGVmOiBGaWVsZERlZjxzdHJpbmc+LFxuICAgIGNoYW5uZWw6IE5vblBvc2l0aW9uQ2hhbm5lbFxuICB9W107XG5cbiAgLyoqXG4gICAqIFNlZSBgXCJzdGFja1wiYCBwcm9wZXJ0eSBvZiBQb3NpdGlvbiBGaWVsZCBEZWYuXG4gICAqL1xuICBvZmZzZXQ6IFN0YWNrT2Zmc2V0O1xuXG4gIC8qKlxuICAgKiBXaGV0aGVyIHRoaXMgc3RhY2sgd2lsbCBwcm9kdWNlIGltcHV0ZSB0cmFuc2Zvcm1cbiAgICovXG4gIGltcHV0ZTogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNvbnN0IFNUQUNLQUJMRV9NQVJLUyA9IFtCQVIsIEFSRUEsIFJVTEUsIFBPSU5ULCBDSVJDTEUsIFNRVUFSRSwgTElORSwgVEVYVCwgVElDS107XG5leHBvcnQgY29uc3QgU1RBQ0tfQllfREVGQVVMVF9NQVJLUyA9IFtCQVIsIEFSRUFdO1xuXG5cbmZ1bmN0aW9uIHBvdGVudGlhbFN0YWNrZWRDaGFubmVsKGVuY29kaW5nOiBFbmNvZGluZzxGaWVsZD4pOiAneCcgfCAneScgfCB1bmRlZmluZWQge1xuICBjb25zdCB4RGVmID0gZW5jb2RpbmcueDtcbiAgY29uc3QgeURlZiA9IGVuY29kaW5nLnk7XG5cbiAgaWYgKGlzRmllbGREZWYoeERlZikgJiYgaXNGaWVsZERlZih5RGVmKSkge1xuICAgIGlmICh4RGVmLnR5cGUgPT09ICdxdWFudGl0YXRpdmUnICYmIHlEZWYudHlwZSA9PT0gJ3F1YW50aXRhdGl2ZScpIHtcbiAgICAgIGlmICh4RGVmLnN0YWNrKSB7XG4gICAgICAgIHJldHVybiAneCc7XG4gICAgICB9IGVsc2UgaWYgKHlEZWYuc3RhY2spIHtcbiAgICAgICAgcmV0dXJuICd5JztcbiAgICAgIH1cbiAgICAgIC8vIGlmIHRoZXJlIGlzIG5vIGV4cGxpY2l0IHN0YWNraW5nLCBvbmx5IGFwcGx5IHN0YWNrIGlmIHRoZXJlIGlzIG9ubHkgb25lIGFnZ3JlZ2F0ZSBmb3IgeCBvciB5XG4gICAgICBpZiAoKCEheERlZi5hZ2dyZWdhdGUpICE9PSAoISF5RGVmLmFnZ3JlZ2F0ZSkpIHtcbiAgICAgICAgcmV0dXJuIHhEZWYuYWdncmVnYXRlID8gJ3gnIDogJ3knO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoeERlZi50eXBlID09PSAncXVhbnRpdGF0aXZlJykge1xuICAgICAgcmV0dXJuICd4JztcbiAgICB9IGVsc2UgaWYgKHlEZWYudHlwZSA9PT0gJ3F1YW50aXRhdGl2ZScpIHtcbiAgICAgIHJldHVybiAneSc7XG4gICAgfVxuICB9IGVsc2UgaWYgKGlzRmllbGREZWYoeERlZikgJiYgeERlZi50eXBlID09PSAncXVhbnRpdGF0aXZlJykge1xuICAgIHJldHVybiAneCc7XG4gIH0gZWxzZSBpZiAoaXNGaWVsZERlZih5RGVmKSAmJiB5RGVmLnR5cGUgPT09ICdxdWFudGl0YXRpdmUnKSB7XG4gICAgcmV0dXJuICd5JztcbiAgfVxuICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG4vLyBOb3RlOiBDb21wYXNzUUwgdXNlcyB0aGlzIG1ldGhvZCBhbmQgb25seSBwYXNzIGluIHJlcXVpcmVkIHByb3BlcnRpZXMgb2YgZWFjaCBhcmd1bWVudCBvYmplY3QuXG4vLyBJZiByZXF1aXJlZCBwcm9wZXJ0aWVzIGNoYW5nZSwgbWFrZSBzdXJlIHRvIHVwZGF0ZSBDb21wYXNzUUwuXG5leHBvcnQgZnVuY3Rpb24gc3RhY2sobTogTWFyayB8IE1hcmtEZWYsIGVuY29kaW5nOiBFbmNvZGluZzxGaWVsZD4sIHN0YWNrQ29uZmlnOiBTdGFja09mZnNldCk6IFN0YWNrUHJvcGVydGllcyB7XG4gIGNvbnN0IG1hcmsgPSBpc01hcmtEZWYobSkgPyBtLnR5cGUgOiBtO1xuICAvLyBTaG91bGQgaGF2ZSBzdGFja2FibGUgbWFya1xuICBpZiAoIWNvbnRhaW5zKFNUQUNLQUJMRV9NQVJLUywgbWFyaykpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IGZpZWxkQ2hhbm5lbCA9IHBvdGVudGlhbFN0YWNrZWRDaGFubmVsKGVuY29kaW5nKTtcbiAgaWYgKCFmaWVsZENoYW5uZWwpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IHN0YWNrZWRGaWVsZERlZiA9IGVuY29kaW5nW2ZpZWxkQ2hhbm5lbF0gYXMgUG9zaXRpb25GaWVsZERlZjxzdHJpbmc+O1xuICBjb25zdCBzdGFja2VkRmllbGQgPSBpc1N0cmluZ0ZpZWxkRGVmKHN0YWNrZWRGaWVsZERlZikgPyB2Z0ZpZWxkKHN0YWNrZWRGaWVsZERlZiwge30pIDogdW5kZWZpbmVkO1xuXG4gIGNvbnN0IGRpbWVuc2lvbkNoYW5uZWwgPSBmaWVsZENoYW5uZWwgPT09ICd4JyA/ICd5JyA6ICd4JztcbiAgY29uc3QgZGltZW5zaW9uRGVmID0gZW5jb2RpbmdbZGltZW5zaW9uQ2hhbm5lbF07XG4gIGNvbnN0IGRpbWVuc2lvbkZpZWxkID0gaXNTdHJpbmdGaWVsZERlZihkaW1lbnNpb25EZWYpID8gdmdGaWVsZChkaW1lbnNpb25EZWYsIHt9KSA6IHVuZGVmaW5lZDtcblxuICAvLyBTaG91bGQgaGF2ZSBncm91cGluZyBsZXZlbCBvZiBkZXRhaWwgdGhhdCBpcyBkaWZmZXJlbnQgZnJvbSB0aGUgZGltZW5zaW9uIGZpZWxkXG4gIGNvbnN0IHN0YWNrQnkgPSBOT05QT1NJVElPTl9DSEFOTkVMUy5yZWR1Y2UoKHNjLCBjaGFubmVsKSA9PiB7XG4gICAgaWYgKGNoYW5uZWxIYXNGaWVsZChlbmNvZGluZywgY2hhbm5lbCkpIHtcbiAgICAgIGNvbnN0IGNoYW5uZWxEZWYgPSBlbmNvZGluZ1tjaGFubmVsXTtcbiAgICAgIChpc0FycmF5KGNoYW5uZWxEZWYpID8gY2hhbm5lbERlZiA6IFtjaGFubmVsRGVmXSkuZm9yRWFjaCgoY0RlZikgPT4ge1xuICAgICAgICBjb25zdCBmaWVsZERlZiA9IGdldEZpZWxkRGVmKGNEZWYpO1xuICAgICAgICBpZiAoZmllbGREZWYuYWdncmVnYXRlKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ2hlY2sgd2hldGhlciB0aGUgY2hhbm5lbCdzIGZpZWxkIGlzIGlkZW50aWNhbCB0byB4L3kncyBmaWVsZCBvciBpZiB0aGUgY2hhbm5lbCBpcyBhIHJlcGVhdFxuICAgICAgICBjb25zdCBmID0gaXNTdHJpbmdGaWVsZERlZihmaWVsZERlZikgPyB2Z0ZpZWxkKGZpZWxkRGVmLCB7fSkgOiB1bmRlZmluZWQ7XG4gICAgICAgIGlmIChcbiAgICAgICAgICAvLyBpZiBmaWVsZGRlZiBpcyBhIHJlcGVhdCwganVzdCBpbmNsdWRlIGl0IGluIHRoZSBzdGFjayBieVxuICAgICAgICAgICFmIHx8XG4gICAgICAgICAgLy8gb3RoZXJ3aXNlLCB0aGUgZmllbGQgbXVzdCBiZSBkaWZmZXJlbnQgZnJvbSB4IGFuZCB5IGZpZWxkcy5cbiAgICAgICAgICAoZiAhPT0gZGltZW5zaW9uRmllbGQgJiYgZiAhPT0gc3RhY2tlZEZpZWxkKVxuICAgICAgICApIHtcbiAgICAgICAgICBzYy5wdXNoKHtjaGFubmVsLCBmaWVsZERlZn0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHNjO1xuICB9LCBbXSk7XG5cbiAgaWYgKHN0YWNrQnkubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICAvLyBBdXRvbWF0aWNhbGx5IGRldGVybWluZSBvZmZzZXRcbiAgbGV0IG9mZnNldDogU3RhY2tPZmZzZXQgPSB1bmRlZmluZWQ7XG4gIGlmIChzdGFja2VkRmllbGREZWYuc3RhY2sgIT09IHVuZGVmaW5lZCkge1xuICAgIG9mZnNldCA9IHN0YWNrZWRGaWVsZERlZi5zdGFjaztcbiAgfSBlbHNlIGlmIChjb250YWlucyhTVEFDS19CWV9ERUZBVUxUX01BUktTLCBtYXJrKSkge1xuICAgIC8vIEJhciBhbmQgQXJlYSB3aXRoIHN1bSBvcHMgYXJlIGF1dG9tYXRpY2FsbHkgc3RhY2tlZCBieSBkZWZhdWx0XG4gICAgb2Zmc2V0ID0gc3RhY2tDb25maWcgPT09IHVuZGVmaW5lZCA/ICd6ZXJvJyA6IHN0YWNrQ29uZmlnO1xuICB9IGVsc2Uge1xuICAgIG9mZnNldCA9IHN0YWNrQ29uZmlnO1xuICB9XG5cbiAgaWYgKCFvZmZzZXQgfHwgIWlzU3RhY2tPZmZzZXQob2Zmc2V0KSkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgLy8gd2FybiB3aGVuIHN0YWNraW5nIG5vbi1saW5lYXJcbiAgaWYgKHN0YWNrZWRGaWVsZERlZi5zY2FsZSAmJiBzdGFja2VkRmllbGREZWYuc2NhbGUudHlwZSAmJiBzdGFja2VkRmllbGREZWYuc2NhbGUudHlwZSAhPT0gU2NhbGVUeXBlLkxJTkVBUikge1xuICAgIGxvZy53YXJuKGxvZy5tZXNzYWdlLmNhbm5vdFN0YWNrTm9uTGluZWFyU2NhbGUoc3RhY2tlZEZpZWxkRGVmLnNjYWxlLnR5cGUpKTtcbiAgfVxuXG4gIC8vIENoZWNrIGlmIGl0IGlzIGEgcmFuZ2VkIG1hcmtcbiAgaWYgKGNoYW5uZWxIYXNGaWVsZChlbmNvZGluZywgZmllbGRDaGFubmVsID09PSBYID8gWDIgOiBZMikpIHtcbiAgICBsb2cud2Fybihsb2cubWVzc2FnZS5jYW5ub3RTdGFja1JhbmdlZE1hcmsoZmllbGRDaGFubmVsKSk7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICAvLyBXYXJuIGlmIHN0YWNraW5nIHN1bW1hdGl2ZSBhZ2dyZWdhdGVcbiAgaWYgKHN0YWNrZWRGaWVsZERlZi5hZ2dyZWdhdGUgJiYgIWNvbnRhaW5zKFNVTV9PUFMsIHN0YWNrZWRGaWVsZERlZi5hZ2dyZWdhdGUpKSB7XG4gICAgbG9nLndhcm4obG9nLm1lc3NhZ2Uuc3RhY2tOb25TdW1tYXRpdmVBZ2dyZWdhdGUoc3RhY2tlZEZpZWxkRGVmLmFnZ3JlZ2F0ZSkpO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBncm91cGJ5Q2hhbm5lbDogZGltZW5zaW9uRGVmID8gZGltZW5zaW9uQ2hhbm5lbCA6IHVuZGVmaW5lZCxcbiAgICBmaWVsZENoYW5uZWwsXG4gICAgaW1wdXRlOiBpc1BhdGhNYXJrKG1hcmspLFxuICAgIHN0YWNrQnksXG4gICAgb2Zmc2V0XG4gIH07XG59XG4iXX0=