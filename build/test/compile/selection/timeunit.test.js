/* tslint:disable:quotemark */
import { assert } from 'chai';
import { assembleRootData } from '../../../src/compile/data/assemble';
import { optimizeDataflow } from '../../../src/compile/data/optimize';
import { TimeUnitNode } from '../../../src/compile/data/timeunit';
import * as selection from '../../../src/compile/selection/selection';
import { parseModel, parseUnitModel } from '../../util';
function getData(model) {
    optimizeDataflow(model.component.data);
    return assembleRootData(model.component.data, {});
}
function getModel(unit2) {
    var model = parseModel({
        "data": { "values": [
                { "date": "Sun, 01 Jan 2012 23:00:01", "price": 150 },
                { "date": "Sun, 02 Jan 2012 00:10:02", "price": 100 },
                { "date": "Sun, 02 Jan 2012 01:20:03", "price": 170 },
                { "date": "Sun, 02 Jan 2012 02:30:04", "price": 165 },
                { "date": "Sun, 02 Jan 2012 03:40:05", "price": 200 }
            ] },
        "hconcat": [{
                "mark": "point",
                "selection": {
                    "two": { "type": "single", "encodings": ["x", "y"] }
                },
                "encoding": {
                    "x": {
                        "field": "date",
                        "type": "temporal",
                        "timeUnit": "seconds"
                    },
                    "y": { "field": "price", "type": "quantitative" }
                }
            }, unit2]
    });
    model.parse();
    return model;
}
describe('Selection time unit', function () {
    it('dataflow nodes are constructed', function () {
        var model = parseUnitModel({
            "mark": "point",
            "encoding": {
                "x": { "field": "date", "type": "temporal", "timeUnit": "seconds" },
                "y": { "field": "date", "type": "temporal", "timeUnit": "minutes" }
            }
        });
        var selCmpts = model.component.selection = selection.parseUnitSelection(model, {
            "one": { "type": "single" },
            "two": { "type": "single", "encodings": ["x", "y"] }
        });
        assert.isUndefined(selCmpts['one'].timeUnit);
        assert.instanceOf(selCmpts['two'].timeUnit, TimeUnitNode);
        var as = selCmpts['two'].timeUnit.assemble().map(function (tx) { return tx.as; });
        assert.sameDeepMembers(as, ['seconds_date', 'minutes_date']);
    });
    it('is added with conditional encodings', function () {
        var model = getModel({
            "mark": "point",
            "encoding": {
                "x": {
                    "field": "date",
                    "type": "temporal",
                    "timeUnit": "minutes"
                },
                "y": { "field": "price", "type": "quantitative" },
                "color": {
                    "condition": { "selection": "two", "value": "goldenrod" },
                    "value": "steelblue"
                }
            }
        });
        var data2 = getData(model).filter(function (d) { return d.name === 'data_2'; })[0].transform;
        assert.equal(data2.filter(function (tx) { return tx.type === 'formula' && tx.as === 'seconds_date'; }).length, 1);
    });
    it('is added before selection filters', function () {
        var model = getModel({
            "transform": [{ "filter": { "selection": "two" } }],
            "mark": "point",
            "encoding": {
                "x": {
                    "field": "date",
                    "type": "temporal",
                    "timeUnit": "minutes"
                },
                "y": { "field": "price", "type": "quantitative" }
            }
        });
        var data2 = getData(model).filter(function (d) { return d.name === 'data_2'; })[0].transform;
        var tuIdx = -1;
        var selIdx = -1;
        data2.forEach(function (tx, idx) {
            if (tx.type === 'formula' && tx.as === 'seconds_date') {
                tuIdx = idx;
            }
            else if (tx.type === 'filter' && tx.expr.indexOf('vlSingle') >= 0) {
                selIdx = idx;
            }
        });
        assert.notEqual(tuIdx, -1);
        assert.notEqual(selIdx, -1);
        assert.isAbove(selIdx, tuIdx);
    });
    it('removes duplicate time unit formulae', function () {
        var model = getModel({
            "transform": [{ "filter": { "selection": "two" } }],
            "mark": "point",
            "encoding": {
                "x": {
                    "field": "date",
                    "type": "temporal",
                    "timeUnit": "seconds"
                },
                "y": { "field": "price", "type": "quantitative" }
            }
        });
        var data2 = getData(model).filter(function (d) { return d.name === 'data_2'; })[0].transform;
        assert.equal(data2.filter(function (tx) { return tx.type === 'formula' && tx.as === 'seconds_date'; }).length, 1);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZXVuaXQudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Rlc3QvY29tcGlsZS9zZWxlY3Rpb24vdGltZXVuaXQudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSw4QkFBOEI7QUFFOUIsT0FBTyxFQUFDLE1BQU0sRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUM1QixPQUFPLEVBQUMsZ0JBQWdCLEVBQUMsTUFBTSxvQ0FBb0MsQ0FBQztBQUNwRSxPQUFPLEVBQUMsZ0JBQWdCLEVBQUMsTUFBTSxvQ0FBb0MsQ0FBQztBQUNwRSxPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0sb0NBQW9DLENBQUM7QUFFaEUsT0FBTyxLQUFLLFNBQVMsTUFBTSwwQ0FBMEMsQ0FBQztBQUV0RSxPQUFPLEVBQUMsVUFBVSxFQUFFLGNBQWMsRUFBQyxNQUFNLFlBQVksQ0FBQztBQUV0RCxpQkFBaUIsS0FBWTtJQUMzQixnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3ZDLE9BQU8sZ0JBQWdCLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDcEQsQ0FBQztBQUVELGtCQUFrQixLQUF5QjtJQUN6QyxJQUFNLEtBQUssR0FBRyxVQUFVLENBQUM7UUFDdkIsTUFBTSxFQUFFLEVBQUMsUUFBUSxFQUFFO2dCQUNqQixFQUFDLE1BQU0sRUFBRSwyQkFBMkIsRUFBQyxPQUFPLEVBQUUsR0FBRyxFQUFDO2dCQUNsRCxFQUFDLE1BQU0sRUFBRSwyQkFBMkIsRUFBQyxPQUFPLEVBQUUsR0FBRyxFQUFDO2dCQUNsRCxFQUFDLE1BQU0sRUFBRSwyQkFBMkIsRUFBQyxPQUFPLEVBQUUsR0FBRyxFQUFDO2dCQUNsRCxFQUFDLE1BQU0sRUFBRSwyQkFBMkIsRUFBQyxPQUFPLEVBQUUsR0FBRyxFQUFDO2dCQUNsRCxFQUFDLE1BQU0sRUFBRSwyQkFBMkIsRUFBQyxP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VUFBQyxFQUFFLElBQUssT0FBQSxFQUFFLENBQUMsSUFBSSxLQUFLLFNBQVMsSUFBSSxFQUFFLENBQUMsRUFBRSxLQUFLLGNBQWMsRUFBakQsQ0FBaUQsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNsRyxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyogdHNsaW50OmRpc2FibGU6cXVvdGVtYXJrICovXG5cbmltcG9ydCB7YXNzZXJ0fSBmcm9tICdjaGFpJztcbmltcG9ydCB7YXNzZW1ibGVSb290RGF0YX0gZnJvbSAnLi4vLi4vLi4vc3JjL2NvbXBpbGUvZGF0YS9hc3NlbWJsZSc7XG5pbXBvcnQge29wdGltaXplRGF0YWZsb3d9IGZyb20gJy4uLy4uLy4uL3NyYy9jb21waWxlL2RhdGEvb3B0aW1pemUnO1xuaW1wb3J0IHtUaW1lVW5pdE5vZGV9IGZyb20gJy4uLy4uLy4uL3NyYy9jb21waWxlL2RhdGEvdGltZXVuaXQnO1xuaW1wb3J0IHtNb2RlbH0gZnJvbSAnLi4vLi4vLi4vc3JjL2NvbXBpbGUvbW9kZWwnO1xuaW1wb3J0ICogYXMgc2VsZWN0aW9uIGZyb20gJy4uLy4uLy4uL3NyYy9jb21waWxlL3NlbGVjdGlvbi9zZWxlY3Rpb24nO1xuaW1wb3J0IHtOb3JtYWxpemVkVW5pdFNwZWN9IGZyb20gJy4uLy4uLy4uL3NyYy9zcGVjJztcbmltcG9ydCB7cGFyc2VNb2RlbCwgcGFyc2VVbml0TW9kZWx9IGZyb20gJy4uLy4uL3V0aWwnO1xuXG5mdW5jdGlvbiBnZXREYXRhKG1vZGVsOiBNb2RlbCkge1xuICBvcHRpbWl6ZURhdGFmbG93KG1vZGVsLmNvbXBvbmVudC5kYXRhKTtcbiAgcmV0dXJuIGFzc2VtYmxlUm9vdERhdGEobW9kZWwuY29tcG9uZW50LmRhdGEsIHt9KTtcbn1cblxuZnVuY3Rpb24gZ2V0TW9kZWwodW5pdDI6IE5vcm1hbGl6ZWRVbml0U3BlYykge1xuICBjb25zdCBtb2RlbCA9IHBhcnNlTW9kZWwoe1xuICAgIFwiZGF0YVwiOiB7XCJ2YWx1ZXNcIjogW1xuICAgICAge1wiZGF0ZVwiOiBcIlN1biwgMDEgSmFuIDIwMTIgMjM6MDA6MDFcIixcInByaWNlXCI6IDE1MH0sXG4gICAgICB7XCJkYXRlXCI6IFwiU3VuLCAwMiBKYW4gMjAxMiAwMDoxMDowMlwiLFwicHJpY2VcIjogMTAwfSxcbiAgICAgIHtcImRhdGVcIjogXCJTdW4sIDAyIEphbiAyMDEyIDAxOjIwOjAzXCIsXCJwcmljZVwiOiAxNzB9LFxuICAgICAge1wiZGF0ZVwiOiBcIlN1biwgMDIgSmFuIDIwMTIgMDI6MzA6MDRcIixcInByaWNlXCI6IDE2NX0sXG4gICAgICB7XCJkYXRlXCI6IFwiU3VuLCAwMiBKYW4gMjAxMiAwMzo0MDowNVwiLFwicHJpY2VcIjogMjAwfVxuICAgIF19LFxuICAgIFwiaGNvbmNhdFwiOiBbe1xuICAgICAgXCJtYXJrXCI6IFwicG9pbnRcIixcbiAgICAgIFwic2VsZWN0aW9uXCI6IHtcbiAgICAgICAgXCJ0d29cIjoge1widHlwZVwiOiBcInNpbmdsZVwiLCBcImVuY29kaW5nc1wiOiBbXCJ4XCIsIFwieVwiXX1cbiAgICAgIH0sXG4gICAgICBcImVuY29kaW5nXCI6IHtcbiAgICAgICAgXCJ4XCI6IHtcbiAgICAgICAgICBcImZpZWxkXCI6IFwiZGF0ZVwiLFxuICAgICAgICAgIFwidHlwZVwiOiBcInRlbXBvcmFsXCIsXG4gICAgICAgICAgXCJ0aW1lVW5pdFwiOiBcInNlY29uZHNcIlxuICAgICAgICB9LFxuICAgICAgICBcInlcIjoge1wiZmllbGRcIjogXCJwcmljZVwiLFwidHlwZVwiOiBcInF1YW50aXRhdGl2ZVwifVxuICAgICAgfVxuICAgIH0sIHVuaXQyXVxuICB9KTtcbiAgbW9kZWwucGFyc2UoKTtcbiAgcmV0dXJuIG1vZGVsO1xufVxuXG5kZXNjcmliZSgnU2VsZWN0aW9uIHRpbWUgdW5pdCcsIGZ1bmN0aW9uKCkge1xuICBpdCgnZGF0YWZsb3cgbm9kZXMgYXJlIGNvbnN0cnVjdGVkJywgZnVuY3Rpb24oKSB7XG4gICAgY29uc3QgbW9kZWwgPSBwYXJzZVVuaXRNb2RlbCh7XG4gICAgICBcIm1hcmtcIjogXCJwb2ludFwiLFxuICAgICAgXCJlbmNvZGluZ1wiOiB7XG4gICAgICAgIFwieFwiOiB7XCJmaWVsZFwiOiBcImRhdGVcIiwgXCJ0eXBlXCI6IFwidGVtcG9yYWxcIiwgXCJ0aW1lVW5pdFwiOiBcInNlY29uZHNcIn0sXG4gICAgICAgIFwieVwiOiB7XCJmaWVsZFwiOiBcImRhdGVcIiwgXCJ0eXBlXCI6IFwidGVtcG9yYWxcIiwgXCJ0aW1lVW5pdFwiOiBcIm1pbnV0ZXNcIn1cbiAgICAgIH1cbiAgICB9KTtcbiAgICBjb25zdCBzZWxDbXB0cyA9IG1vZGVsLmNvbXBvbmVudC5zZWxlY3Rpb24gPSBzZWxlY3Rpb24ucGFyc2VVbml0U2VsZWN0aW9uKG1vZGVsLCB7XG4gICAgICBcIm9uZVwiOiB7XCJ0eXBlXCI6IFwic2luZ2xlXCJ9LFxuICAgICAgXCJ0d29cIjoge1widHlwZVwiOiBcInNpbmdsZVwiLCBcImVuY29kaW5nc1wiOiBbXCJ4XCIsIFwieVwiXX1cbiAgICB9KTtcblxuICAgIGFzc2VydC5pc1VuZGVmaW5lZChzZWxDbXB0c1snb25lJ10udGltZVVuaXQpO1xuICAgIGFzc2VydC5pbnN0YW5jZU9mKHNlbENtcHRzWyd0d28nXS50aW1lVW5pdCwgVGltZVVuaXROb2RlKTtcblxuICAgIGNvbnN0IGFzID0gc2VsQ21wdHNbJ3R3byddLnRpbWVVbml0LmFzc2VtYmxlKCkubWFwKCh0eCkgPT4gdHguYXMpO1xuICAgIGFzc2VydC5zYW1lRGVlcE1lbWJlcnMoYXMsIFsnc2Vjb25kc19kYXRlJywgJ21pbnV0ZXNfZGF0ZSddKTtcbiAgfSk7XG5cbiAgaXQoJ2lzIGFkZGVkIHdpdGggY29uZGl0aW9uYWwgZW5jb2RpbmdzJywgZnVuY3Rpb24oKSB7XG4gICAgY29uc3QgbW9kZWwgPSBnZXRNb2RlbCh7XG4gICAgICBcIm1hcmtcIjogXCJwb2ludFwiLFxuICAgICAgXCJlbmNvZGluZ1wiOiB7XG4gICAgICAgIFwieFwiOiB7XG4gICAgICAgICAgXCJmaWVsZFwiOiBcImRhdGVcIixcbiAgICAgICAgICBcInR5cGVcIjogXCJ0ZW1wb3JhbFwiLFxuICAgICAgICAgIFwidGltZVVuaXRcIjogXCJtaW51dGVzXCJcbiAgICAgICAgfSxcbiAgICAgICAgXCJ5XCI6IHtcImZpZWxkXCI6IFwicHJpY2VcIixcInR5cGVcIjogXCJxdWFudGl0YXRpdmVcIn0sXG4gICAgICAgIFwiY29sb3JcIjoge1xuICAgICAgICAgIFwiY29uZGl0aW9uXCI6IHtcInNlbGVjdGlvblwiOiBcInR3b1wiLCBcInZhbHVlXCI6IFwiZ29sZGVucm9kXCJ9LFxuICAgICAgICAgIFwidmFsdWVcIjogXCJzdGVlbGJsdWVcIlxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCBkYXRhMiA9IGdldERhdGEobW9kZWwpLmZpbHRlcigoZCkgPT4gZC5uYW1lID09PSAnZGF0YV8yJylbMF0udHJhbnNmb3JtO1xuICAgIGFzc2VydC5lcXVhbChkYXRhMi5maWx0ZXIoKHR4KSA9PiB0eC50eXBlID09PSAnZm9ybXVsYScgJiYgdHguYXMgPT09ICdzZWNvbmRzX2RhdGUnKS5sZW5ndGgsIDEpO1xuICB9KTtcblxuICBpdCgnaXMgYWRkZWQgYmVmb3JlIHNlbGVjdGlvbiBmaWx0ZXJzJywgZnVuY3Rpb24oKSB7XG4gICAgY29uc3QgbW9kZWwgPSBnZXRNb2RlbCh7XG4gICAgICBcInRyYW5zZm9ybVwiOiBbe1wiZmlsdGVyXCI6IHtcInNlbGVjdGlvblwiOiBcInR3b1wifX1dLFxuICAgICAgXCJtYXJrXCI6IFwicG9pbnRcIixcbiAgICAgIFwiZW5jb2RpbmdcIjoge1xuICAgICAgICBcInhcIjoge1xuICAgICAgICAgIFwiZmllbGRcIjogXCJkYXRlXCIsXG4gICAgICAgICAgXCJ0eXBlXCI6IFwidGVtcG9yYWxcIixcbiAgICAgICAgICBcInRpbWVVbml0XCI6IFwibWludXRlc1wiXG4gICAgICAgIH0sXG4gICAgICAgIFwieVwiOiB7XCJmaWVsZFwiOiBcInByaWNlXCIsXCJ0eXBlXCI6IFwicXVhbnRpdGF0aXZlXCJ9XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCBkYXRhMiA9IGdldERhdGEobW9kZWwpLmZpbHRlcigoZCkgPT4gZC5uYW1lID09PSAnZGF0YV8yJylbMF0udHJhbnNmb3JtO1xuICAgIGxldCB0dUlkeCA9IC0xO1xuICAgIGxldCBzZWxJZHggPSAtMTtcblxuICAgIGRhdGEyLmZvckVhY2goKHR4LCBpZHgpID0+IHtcbiAgICAgIGlmICh0eC50eXBlID09PSAnZm9ybXVsYScgJiYgdHguYXMgPT09ICdzZWNvbmRzX2RhdGUnKSB7XG4gICAgICAgIHR1SWR4ID0gaWR4O1xuICAgICAgfSBlbHNlIGlmICh0eC50eXBlID09PSAnZmlsdGVyJyAmJiB0eC5leHByLmluZGV4T2YoJ3ZsU2luZ2xlJykgPj0gMCkge1xuICAgICAgICBzZWxJZHggPSBpZHg7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBhc3NlcnQubm90RXF1YWwodHVJZHgsIC0xKTtcbiAgICBhc3NlcnQubm90RXF1YWwoc2VsSWR4LCAtMSk7XG4gICAgYXNzZXJ0LmlzQWJvdmUoc2VsSWR4LCB0dUlkeCk7XG4gIH0pO1xuXG4gIGl0KCdyZW1vdmVzIGR1cGxpY2F0ZSB0aW1lIHVuaXQgZm9ybXVsYWUnLCBmdW5jdGlvbigpIHtcbiAgICBjb25zdCBtb2RlbCA9IGdldE1vZGVsKHtcbiAgICAgIFwidHJhbnNmb3JtXCI6IFt7XCJmaWx0ZXJcIjoge1wic2VsZWN0aW9uXCI6IFwidHdvXCJ9fV0sXG4gICAgICBcIm1hcmtcIjogXCJwb2ludFwiLFxuICAgICAgXCJlbmNvZGluZ1wiOiB7XG4gICAgICAgIFwieFwiOiB7XG4gICAgICAgICAgXCJmaWVsZFwiOiBcImRhdGVcIixcbiAgICAgICAgICBcInR5cGVcIjogXCJ0ZW1wb3JhbFwiLFxuICAgICAgICAgIFwidGltZVVuaXRcIjogXCJzZWNvbmRzXCJcbiAgICAgICAgfSxcbiAgICAgICAgXCJ5XCI6IHtcImZpZWxkXCI6IFwicHJpY2VcIixcInR5cGVcIjogXCJxdWFudGl0YXRpdmVcIn1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IGRhdGEyID0gZ2V0RGF0YShtb2RlbCkuZmlsdGVyKChkKSA9PiBkLm5hbWUgPT09ICdkYXRhXzInKVswXS50cmFuc2Zvcm07XG4gICAgYXNzZXJ0LmVxdWFsKGRhdGEyLmZpbHRlcigodHgpID0+IHR4LnR5cGUgPT09ICdmb3JtdWxhJyAmJiB0eC5hcyA9PT0gJ3NlY29uZHNfZGF0ZScpLmxlbmd0aCwgMSk7XG4gIH0pO1xufSk7XG4iXX0=